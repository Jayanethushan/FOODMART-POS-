<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JAYANETH PRO | ADVANCED GLASS POS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
    <!-- QR/Barcode Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <style>
        :root {
            --bg-dark: #050608;
            --glass-bg: rgba(15, 18, 22, 0.85);
            --glass-border: rgba(255, 255, 255, 0.12);
            --neon-green: #8aff67;
            --neon-blue: #00f2ff;
            --danger: #ff4747;
            --orange: #ff9f43;
            --text-main: #ffffff;
            --text-dim: #94a3b8;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body { 
            margin: 0; 
            height: 100vh; 
            background: radial-gradient(circle at 70% 20%, #0d1a0d, #050608); 
            color: var(--text-main); 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: relative;
        }

        body::before {
            content: "";
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 100 100'%3E%3Cg fill='none' stroke='%23ffffff' stroke-width='0.6' stroke-opacity='0.12'%3E%3Cpath d='M20 20c5-10 15-10 20 0s-5 15-10 15-15-5-10-15z'/%3E%3Cpath d='M70 30c0-10 10-15 15-5s-5 15-10 15-5-5-5-10z'/%3E%3Cpath d='M40 70c0-10 15-10 15 0s-5 15-10 15-5-5-5-10z'/%3E%3Ccircle cx='15' cy='75' r='8'/%3E%3Cpath d='M80 80l5-10h-10z'/%3E%3Cpath d='M10 10l5 5-5 5z'/%3E%3Cpath d='M50 10c5 5 5 15 0 20s-15 5-20 0 5-15 10-20 10 0 10 0z'/%3E%3C/g%3E%3C/svg%3E");
            background-repeat: repeat; filter: blur(0.5px); z-index: -1;
        }

        .glass { background: var(--glass-bg); backdrop-filter: blur(25px); border: 1px solid var(--glass-border); border-radius: 18px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .privacy-blur { filter: blur(25px); pointer-events: none; transition: 0.5s; opacity: 0.3; }

        header { padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.6); border-bottom: 1px solid var(--glass-border); z-index: 10; }
        .logo h1 { margin: 0; font-size: 22px; font-weight: 800; }
        .logo span { color: var(--neon-green); }

        .dashboard-stats { display: flex; gap: 12px; }
        .mini-stat { padding: 8px 15px; text-align: right; min-width: 120px; }
        .stat-label { font-size: 9px; color: var(--text-dim); text-transform: uppercase; font-weight: 800; }
        .stat-val { display: block; font-family: 'JetBrains Mono'; font-size: 15px; }

        nav { display: flex; gap: 10px; padding: 12px 30px; background: rgba(0,0,0,0.3); z-index: 10; }
        .nav-link { background: var(--glass-bg); border: 1px solid var(--glass-border); color: white; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 12px; font-weight: 600; }
        .nav-link.active { background: var(--neon-green); color: black; border-color: var(--neon-green); }

        main { flex: 1; display: flex; padding: 20px; gap: 20px; overflow: hidden; }
        .left-col { flex: 1.8; display: flex; flex-direction: column; gap: 15px; }
        .right-col { flex: 1.2; display: flex; flex-direction: column; }

        .search-bar, select { width: 100%; padding: 12px 15px; border-radius: 10px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.4); color: white; margin-bottom: 10px; }
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; overflow-y: auto; }
        .item-card { padding: 15px 10px; text-align: center; cursor: pointer; transition: 0.3s; position: relative; }
        .item-card:hover { border-color: var(--neon-green); background: rgba(138, 255, 103, 0.05); }
        
        .stock-badge { position: absolute; top: 8px; right: 8px; font-size: 9px; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; }
        .cart-table { flex: 1; overflow-y: auto; padding: 10px; }
        .cart-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 5px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 12px; }

        .grand-total { font-family: 'JetBrains Mono'; font-size: 24px; color: var(--neon-green); font-weight: 800; }
        .btn-action { width: 100%; padding: 15px; border: none; border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: 800; margin-top: 10px; }
        .btn-pay { background: var(--neon-green); color: black; }

        .history-list { margin-top: 20px; max-height: 300px; overflow-y: auto; font-size: 13px; }
        .history-item { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
        .btn-view { background: #333; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }

        /* Universal Popup Styles */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 2000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(10px); }
        .receipt-box { background: white; color: black; padding: 20px; width: 100%; max-width: 320px; border-radius: 8px; font-family: 'JetBrains Mono'; font-size: 12px; }
        
        /* Modern Input Modals */
        .glass-popup { background: var(--glass-bg); border: 1px solid var(--glass-border); padding: 30px; border-radius: 24px; width: 100%; max-width: 380px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .popup-title { font-size: 18px; font-weight: 800; margin-bottom: 10px; color: var(--neon-blue); }
        .popup-sub { font-size: 12px; color: var(--text-dim); margin-bottom: 20px; }
        .popup-input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.05); color: white; font-size: 20px; text-align: center; font-family: 'JetBrains Mono'; margin-bottom: 20px; outline: none; }
        .popup-btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-cancel { background: rgba(255,255,255,0.1); color: white; }

        /* New PIN Error Modal */
        .pin-error-modal { background: var(--glass-bg); border: 1px solid var(--danger); padding: 25px; border-radius: 20px; width: 90%; max-width: 300px; text-align: center; }
        .pin-error-icon { font-size: 40px; margin-bottom: 15px; color: var(--danger); }
        .pin-error-title { font-size: 16px; font-weight: 800; margin-bottom: 10px; color: var(--danger); }
        .pin-error-text { font-size: 12px; color: var(--text-dim); margin-bottom: 20px; }
        .pin-error-btn { background: var(--danger); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: 600; }

        /* Discount Row Styles */
        .discount-row { display: flex; align-items: center; gap: 10px; margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 10px; }
        .discount-label { font-size: 12px; color: var(--text-dim); }
        .discount-input { width: 80px; padding: 8px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.05); color: white; text-align: center; }
        .apply-discount-btn { padding: 8px 15px; border-radius: 8px; background: var(--orange); color: black; border: none; cursor: pointer; font-weight: 600; }
        .remove-discount-btn { padding: 8px 15px; border-radius: 8px; background: var(--danger); color: white; border: none; cursor: pointer; font-weight: 600; }

        /* New Item Added Notification */
        .notification { position: fixed; top: 20px; right: 20px; background: var(--neon-green); color: black; padding: 12px 20px; border-radius: 10px; font-weight: 600; z-index: 3000; animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* Scanner Modal Styles */
        .scanner-modal { background: var(--glass-bg); border: 1px solid var(--glass-border); padding: 20px; border-radius: 20px; width: 90%; max-width: 500px; text-align: center; }
        #scanner-container { width: 100%; height: 300px; margin: 20px 0; background: rgba(0,0,0,0.3); border-radius: 10px; overflow: hidden; position: relative; }
        #scanner-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .scanner-icon { font-size: 50px; margin-bottom: 10px; color: var(--neon-blue); }
        .scanner-btn { background: var(--neon-blue); color: black; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; margin: 10px 5px; }

        /* Edit Button Styles - ‡∑É‡∑î‡∂Ø‡∑î outline ‡∂¥‡∑ê‡∂±‡∑ä‡∑É‡∂Ω */
        .edit-btn { 
            background: none; 
            border: none; 
            cursor: pointer; 
            font-size: 12px; 
            margin-left: 5px; 
            color: white;
            -webkit-text-stroke: 1px white; /* Outline effect */
            text-stroke: 1px white;
            text-shadow: 
                0 0 2px white,
                0 0 4px rgba(255, 255, 255, 0.5);
            opacity: 0.7;
            transition: all 0.3s ease;
            padding: 2px;
        }
        .edit-btn:hover { 
            opacity: 1; 
            color: var(--neon-blue);
            -webkit-text-stroke: 1px var(--neon-blue);
            text-stroke: 1px var(--neon-blue);
            text-shadow: 
                0 0 3px var(--neon-blue),
                0 0 6px rgba(0, 242, 255, 0.5);
            transform: scale(1.1);
        }
        .price-edit-input { width: 80px; padding: 5px; border-radius: 5px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.5); color: white; text-align: center; }

        /* Lock/Unlock Button */
        #lockBtn { display: flex; align-items: center; gap: 5px; }

        /* Edit Item Modal */
        .edit-item-modal { 
            background: var(--glass-bg); 
            border: 1px solid var(--glass-border); 
            padding: 25px; 
            border-radius: 20px; 
            width: 90%; 
            max-width: 400px; 
            text-align: center;
        }
        .emoji-display {
            font-size: 40px;
            margin: 15px 0;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
        }
        .emoji-display:hover {
            background: rgba(255,255,255,0.1);
            transform: scale(1.1);
        }
        .emoji-category-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        .emoji-tab {
            padding: 8px 15px;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-dim);
            cursor: pointer;
            font-size: 12px;
            transition: 0.3s;
        }
        .emoji-tab.active {
            background: var(--neon-green);
            color: black;
            border-color: var(--neon-green);
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }
        .emoji-option {
            font-size: 20px;
            padding: 8px;
            cursor: pointer;
            border-radius: 5px;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .emoji-option:hover {
            background: rgba(138, 255, 103, 0.2);
            transform: scale(1.2);
        }
        .emoji-option.selected {
            background: rgba(138, 255, 103, 0.3);
            border: 1px solid var(--neon-green);
        }
        
        /* Weight Modal Styles - Fixed */
        .weight-modal-content {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 30px;
            border-radius: 24px;
            width: 90%;
            max-width: 380px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        /* Hide MacBook Pro and other system info */
        .system-info {
            display: none !important;
        }
    </style>
</head>
<body>

<header>
    <div class="logo"><h1>JAYANETH <span>PRO MART</span></h1></div>
    <div class="dashboard-stats">
        <div class="mini-stat glass"><span class="stat-label">Daily Revenue</span><span id="statRev" class="stat-val privacy-target">Rs 0.00</span></div>
        <div class="mini-stat glass"><span class="stat-label">Daily Profit</span><span id="statProf" class="stat-val privacy-target" style="color: var(--neon-green);">Rs 0.00</span></div>
        <button class="nav-link" id="lockBtn" onclick="handleLock()">üîí LOCK</button>
    </div>
</header>

<nav>
    <button class="nav-link active" id="tab-pos" onclick="switchTab('pos')">POS</button>
    <button class="nav-link" id="tab-stock" onclick="switchTab('stock')">STOCK CONTROL</button>
    <button class="nav-link" id="tab-reports" onclick="switchTab('reports')">P&L REPORTS</button>
</nav>

<div id="view-pos" style="display: contents;">
    <main>
        <div class="left-col">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" id="pSearch" class="search-bar" placeholder="üîç Search items..." oninput="renderItems()" style="flex: 1;">
                <button class="nav-link" onclick="showScanner('pos')" style="min-width: 50px; padding: 12px; display: flex; align-items: center; justify-content: center;">üì∑</button>
            </div>
            <div class="item-grid" id="itemGrid"></div>
        </div>
        <div class="right-col glass">
            <div style="padding: 15px; border-bottom: 1px solid var(--glass-border); font-weight: 800; display: flex; justify-content: space-between; align-items: center;">
                <span>BILLING</span>
                <button class="nav-link" onclick="showScanner('bill')" style="padding: 5px 10px; font-size: 11px;">üì∑ Scan Item</button>
            </div>
            <div class="cart-table" id="cartList"></div>
            
            <div style="padding: 10px 15px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--glass-border);">
                <div class="discount-row">
                    <span class="discount-label">Discount:</span>
                    <input type="number" id="discountInput" class="discount-input" placeholder="Rs" min="0">
                    <button class="apply-discount-btn" onclick="applyDiscount()">Apply</button>
                    <button class="remove-discount-btn" onclick="removeDiscount()" style="display:none;" id="removeDiscountBtn">Remove</button>
                </div>
                <div style="font-size: 11px; color: var(--text-dim); margin-top: 5px;">Enter amount in Rupees to deduct from total</div>
            </div>
            
            <div style="padding: 20px; background: rgba(0,0,0,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <span style="font-size: 12px; color: var(--text-dim);">SUBTOTAL</span>
                    <span id="subTotal" style="font-family: 'JetBrains Mono';">0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;" id="discountDisplay">
                    <span style="font-size: 12px; color: var(--danger);">DISCOUNT</span>
                    <span id="discountAmount" style="font-family: 'JetBrains Mono'; color: var(--danger);">0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 12px; color: var(--text-dim);">TOTAL</span>
                    <span id="grandTotal" class="grand-total">0.00</span>
                </div>
                <button class="btn-action btn-pay" onclick="completeSale()">COMPLETE SALE</button>
            </div>
        </div>
    </main>
</div>

<div id="view-stock" style="display: none; padding: 30px; overflow-y: auto;">
    <div style="max-width: 1000px; margin: auto;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="glass" style="padding: 20px;">
                <div style="font-weight: 800; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <span>STOCK UPDATE</span>
                    <button class="nav-link" onclick="showScanner('stock')" style="padding: 5px 10px; font-size: 11px;">üì∑ Scan Code</button>
                </div>
                <select id="stType" onchange="toggleStockMode()">
                    <option value="in">ADD NEW / REFILL (‡∑É‡∑ä‡∂ß‡∑ú‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏)</option>
                    <option value="out">WASTAGE / DAMAGE (‡∂ö‡∑î‡∂´‡∑î ‡∑Ä‡∑ñ/‡∂¥‡∑è‡∂©‡∑î ‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏)</option>
                </select>
                <div id="newProductForm">
                    <input type="text" id="stName" placeholder="Item Name" class="search-bar">
                    <select id="stCat" class="search-bar"><option value="Fruit">Fruit</option><option value="Veg">Vegetable</option></select>
                    <input type="number" id="stCost" placeholder="Cost Price (1kg)" class="search-bar">
                    <input type="number" id="stPrice" placeholder="Selling Price (1kg)" class="search-bar">
                    <input type="text" id="stEmoji" placeholder="Emoji (üçé)" class="search-bar">
                    <input type="text" id="stBarcode" placeholder="Barcode/QR Code (optional)" class="search-bar">
                </div>
                <div id="existingProductForm" style="display:none;">
                    <select id="stSelect" class="search-bar"></select>
                </div>
                <input type="number" id="stQty" placeholder="Weight (kg)" class="search-bar">
                <button class="btn-action btn-pay" onclick="processStock()">UPDATE INVENTORY</button>
                <div style="font-size: 11px; color: var(--text-dim); margin-top: 10px; text-align: center;">
                    Note: All fields will clear after adding
                </div>
            </div>
            <div class="glass" style="padding: 20px;">
                <div style="font-weight: 800; margin-bottom: 20px;">OTHER EXPENSES</div>
                <input type="text" id="expName" placeholder="Reason" class="search-bar">
                <input type="number" id="expAmt" placeholder="Amount (Rs)" class="search-bar">
                <button class="btn-action" style="background:var(--orange); color:black;" onclick="addExpense()">ADD EXPENSE</button>
                <div style="font-size: 11px; color: var(--text-dim); margin-top: 10px; text-align: center;">
                    Note: Fields will clear after adding
                </div>
            </div>
        </div>

        <div class="glass" style="margin-top: 20px; padding: 20px;">
            <div style="font-weight: 800; border-bottom: 1px solid #333; padding-bottom: 10px;">RECENT ACTIVITY (‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂ö‡∑è‡∂ª‡∂ö‡∂∏‡∑ä ‡∑É‡∂ß‡∑Ñ‡∂±)</div>
            <div class="history-list" id="historyLog"></div>
        </div>
    </div>
</div>

<div id="view-reports" style="display: none; padding: 30px; overflow-y: auto;">
    <div id="reportPrivacyWrapper" class="privacy-blur">
        <div class="rep-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div class="glass" style="padding:20px; text-align:center;"><span class="stat-label">Daily Revenue</span><h2 id="rDayRev">0.00</h2></div>
            <div class="glass" style="padding:20px; text-align:center;"><span class="stat-label">Daily Profit (Net)</span><h2 id="rDayProf" style="color:var(--neon-green)">0.00</h2></div>
            <div class="glass" style="padding:20px; text-align:center;"><span class="stat-label">Daily Loss</span><h2 id="rDayLoss" style="color:var(--danger)">0.00</h2></div>
            <div class="glass" style="padding:20px; text-align:center;"><span class="stat-label">Monthly Net Profit</span><h2 id="rMonthProf" style="color:var(--neon-blue)">0.00</h2></div>
        </div>
        <div class="glass" style="padding: 20px;">
            <h3>Today's Summary</h3>
            <div id="summaryText"></div>
        </div>
    </div>
</div>

<!-- Existing Modals -->
<div class="modal" id="pinModal">
    <div class="glass-popup">
        <div class="popup-title">ENTER PIN</div>
        <div class="popup-sub">Please enter the security PIN to unlock reports</div>
        <input type="password" id="pinInput" class="popup-input" placeholder="****" maxlength="4" onkeydown="if(event.key === 'Enter') confirmPin()">
        <div class="popup-btn-grid">
            <button class="btn-action btn-cancel" onclick="closeModal('pinModal')">CANCEL</button>
            <button class="btn-action btn-pay" onclick="confirmPin()">UNLOCK</button>
        </div>
    </div>
</div>

<!-- Weight Modal - Fixed Version -->
<div class="modal" id="weightModal">
    <div class="weight-modal-content">
        <div class="popup-title" id="weightTitle">ENTER WEIGHT</div>
        <div class="popup-sub" id="weightSub">Enter weight in kilograms</div>
        <input type="number" id="weightInput" class="popup-input" placeholder="0.000" step="0.001" onkeydown="if(event.key === 'Enter') confirmWeight()">
        <div class="popup-btn-grid">
            <button class="btn-action btn-cancel" onclick="closeWeightModal()">CANCEL</button>
            <button class="btn-action btn-pay" onclick="confirmWeight()">ADD TO CART</button>
        </div>
    </div>
</div>

<div class="modal" id="modal">
    <div class="receipt-box" id="billArea"></div>
    <div style="text-align: center; width: 100%;">
        <button class="btn-action btn-pay" style="width: 200px;" onclick="closeModal('modal')">OK</button>
    </div>
</div>

<div class="modal" id="pinErrorModal">
    <div class="pin-error-modal">
        <div class="pin-error-icon">‚ö†Ô∏è</div>
        <div class="pin-error-title">‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í PIN ‡∂Ö‡∂Ç‡∂ö‡∂∫‡∂ö‡∑í!</div>
        <div class="pin-error-text">‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í PIN ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.</div>
        <button class="pin-error-btn" onclick="closeModal('pinErrorModal')">OK</button>
    </div>
</div>

<!-- New Scanner Modal -->
<div class="modal" id="scannerModal">
    <div class="scanner-modal">
        <div class="popup-title">SCAN QR/ BARCODE</div>
        <div class="popup-sub">Point your camera at the QR code or barcode</div>
        <div id="scanner-container">
            <div id="scanner-placeholder">
                <div class="scanner-icon">üì∑</div>
                <div>Camera scanner will appear here</div>
            </div>
        </div>
        <div style="margin-top: 20px;">
            <button class="scanner-btn" onclick="startScanner()">Start Scanner</button>
            <button class="btn-cancel" onclick="stopScanner()">Stop Scanner</button>
            <button class="btn-cancel" onclick="closeModal('scannerModal')">Close</button>
        </div>
        <div id="scanner-result" style="margin-top: 20px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 10px; display: none;">
            <div id="scanned-text"></div>
        </div>
    </div>
</div>

<!-- Edit Item Modal - Enhanced with Emoji Packs -->
<div class="modal" id="editItemModal">
    <div class="edit-item-modal">
        <div class="popup-title" id="editItemTitle">Edit Item</div>
        <div class="popup-sub" id="editItemSub">Change emoji and price</div>
        
        <div class="emoji-display" id="currentEmojiDisplay" onclick="toggleEmojiPicker()">üçé</div>
        
        <div id="emojiPicker" style="display: none;">
            <div class="emoji-category-tabs">
                <button class="emoji-tab active" onclick="switchEmojiCategory('fruits')">üçé Fruits</button>
                <button class="emoji-tab" onclick="switchEmojiCategory('vegetables')">ü•¶ Vegetables</button>
                <button class="emoji-tab" onclick="switchEmojiCategory('other')">üì¶ Other</button>
            </div>
            
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>
        
        <div style="margin: 20px 0;">
            <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 5px;">New Selling Price (Rs):</div>
            <input type="number" id="editItemPrice" class="popup-input" placeholder="0.00" step="0.01" style="font-size: 18px; padding: 12px;">
        </div>
        
        <div class="popup-btn-grid">
            <button class="btn-action btn-cancel" onclick="closeEditModal()">CANCEL</button>
            <button class="btn-action btn-pay" onclick="saveItemEdit()">SAVE CHANGES</button>
        </div>
    </div>
</div>

<!-- PIN Lock for Edit Modal -->
<div class="modal" id="editPinModal">
    <div class="glass-popup">
        <div class="popup-title">EDIT LOCKED</div>
        <div class="popup-sub">Enter PIN 8514 to edit item</div>
        <input type="password" id="editPinInput" class="popup-input" placeholder="****" maxlength="4" onkeydown="if(event.key === 'Enter') verifyEditPin()">
        <div class="popup-btn-grid">
            <button class="btn-action btn-cancel" onclick="closeModal('editPinModal')">CANCEL</button>
            <button class="btn-action btn-pay" onclick="verifyEditPin()">UNLOCK EDIT</button>
        </div>
    </div>
</div>

<script>
    // -------------------------------------------------------------------------
    // FIREBASE ‡∑É‡∑ê‡∂ö‡∑É‡∑î‡∂∏‡∑ä
    // -------------------------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyAdw73seKGjO0VLFZuMj9gJaiSmnpc3N0M",
        authDomain: "pos-system-dc0e0.firebaseapp.com",
        databaseURL: "https://pos-system-dc0e0-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "pos-system-dc0e0",
        storageBucket: "pos-system-dc0e0.firebasestorage.app",
        messagingSenderId: "251115370846",
        appId: "1:251115370846:web:f7cfe5b3f38f71d67077cf",
        measurementId: "G-CGRK6HPBLX"
    };

    // Firebase ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Global variables
    let db = JSON.parse(localStorage.getItem('jmart_db')) || [];
    let sales = JSON.parse(localStorage.getItem('jmart_sales')) || [];
    let expenses = JSON.parse(localStorage.getItem('jmart_exp')) || [];
    let wastage = JSON.parse(localStorage.getItem('jmart_waste')) || [];
    let logs = JSON.parse(localStorage.getItem('jmart_logs')) || [];
    let cart = [];
    let currentDiscount = 0;
    let isLocked = true;
    let tempItem = null;
    let scanner = null;
    let currentScannerMode = 'pos';
    let itemToEdit = null;
    let selectedEmoji = 'üçé';
    let currentEmojiCategory = 'fruits';
    
    // Emoji Packs
    const emojiPacks = {
        fruits: [
            'üçé', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'ü´ê', 'üçà',
            'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'üçÜ', 'ü´ë', 'üå∂Ô∏è'
        ],
        vegetables: [
            'ü•¶', 'ü•¨', 'ü•í', 'üåΩ', 'ü•ï', 'ü´õ', 'üßÖ', 'üßÑ', 'ü•î', 'üç†',
            'ü•ú', 'üå∞', 'ü´ö', 'ü´í', 'ü•ë', 'ü´ë', 'üå∂Ô∏è', 'ü´ò', 'üçÑ', 'ü•ó'
        ],
        other: [
            'ü•ê', 'üçû', 'ü•ñ', 'ü•®', 'üßÄ', 'ü•ö', 'üç≥', 'ü•ì', 'ü•©', 'üçó',
            'üçñ', 'ü¶¥', 'üå≠', 'üçî', 'üçü', 'üçï', 'ü•™', 'ü•ô', 'üßÜ', 'üåÆ'
        ]
    };

    // Device sync key for multi-device support
    const SYNC_KEY = 'jmart_sync_id';
    let syncId = localStorage.getItem(SYNC_KEY) || generateSyncId();
    localStorage.setItem(SYNC_KEY, syncId);

    // Generate unique device ID for sync
    function generateSyncId() {
        return 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // --- CLOUD SYNC: ‡∂Ö‡∂±‡∑ä‡∂≠‡∂ª‡∑ä‡∂¢‡∑è‡∂Ω‡∂∫‡∑ô‡∂±‡∑ä ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂± ‡∑Ä‡∑í‡∂ß UPDATE ‡∑Ä‡∑ì‡∂∏ ---
    database.ref('pos_data').on('value', (snapshot) => {
        const cloudData = snapshot.val();
        if (cloudData && cloudData.last_source !== syncId) {
            db = cloudData.db || [];
            sales = cloudData.sales || [];
            expenses = cloudData.expenses || [];
            wastage = cloudData.wastage || [];
            logs = cloudData.logs || [];
            
            // Local ‡∂ë‡∂ö‡∂ß‡∂Ø ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏
            localStorage.setItem('jmart_db', JSON.stringify(db));
            localStorage.setItem('jmart_sales', JSON.stringify(sales));
            localStorage.setItem('jmart_exp', JSON.stringify(expenses));
            localStorage.setItem('jmart_waste', JSON.stringify(wastage));
            localStorage.setItem('jmart_logs', JSON.stringify(logs));

            renderItems();
            updateStats();
            renderLogs();
            showNotification('Cloud Data Updated');
        }
    });

    // Save function with Cloud Support
    function save() {
        localStorage.setItem('jmart_last_update_source', syncId);
        localStorage.setItem('jmart_db', JSON.stringify(db));
        localStorage.setItem('jmart_sales', JSON.stringify(sales));
        localStorage.setItem('jmart_exp', JSON.stringify(expenses));
        localStorage.setItem('jmart_waste', JSON.stringify(wastage));
        localStorage.setItem('jmart_logs', JSON.stringify(logs));
        localStorage.setItem('jmart_last_update', new Date().toISOString());

        // Cloud Backup
        database.ref('pos_data').set({
            db, sales, expenses, wastage, logs,
            last_source: syncId,
            timestamp: Date.now()
        });
    }

    // Show notification function
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        notification.style.background = type === 'error' ? 'var(--danger)' : 
                                      type === 'success' ? 'var(--neon-green)' : 
                                      type === 'warning' ? 'var(--orange)' : 'var(--neon-blue)';
        notification.style.color = type === 'error' ? 'white' : 'black';
        
        document.body.appendChild(notification);
        
        // Remove after animation
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }

    function addLog(msg, type, data = null) {
        logs.unshift({ 
            msg, 
            type, 
            data, 
            time: new Date().toLocaleTimeString(), 
            date: new Date().toLocaleDateString(), 
            id: Date.now(),
            syncId: syncId 
        });
        if(logs.length > 50) logs.pop();
        save();
        renderLogs();
    }

    function renderLogs() {
        const logBox = document.getElementById('historyLog');
        logBox.innerHTML = logs.map(l => `
            <div class="history-item">
                <span>[${l.time}] ${l.msg}</span>
                ${l.type === 'sale' ? `<button class="btn-view" onclick="viewOldBill(${l.id})">VIEW BILL</button>` : ''}
            </div>
        `).join('');
    }

    function viewOldBill(logId) {
        let log = logs.find(x => x.id === logId);
        if(!log || !log.data) return;
        showReceipt(log.data.items, log.data.total, log.data.discount || 0, log.time);
    }

    function renderItems() {
        const grid = document.getElementById('itemGrid');
        const query = document.getElementById('pSearch').value.toLowerCase();
        grid.innerHTML = '';
        db.filter(i => i.name.toLowerCase().includes(query)).forEach(item => {
            const card = document.createElement('div');
            card.className = 'item-card glass';
            card.innerHTML = `
                <span class="stock-badge">${parseFloat(item.qty).toFixed(2)}kg</span>
                <div style="font-size:30px;">${item.emoji || 'üçé'}</div>
                <b>${item.name}</b>
                <br>
                <small>
                    Rs ${item.price}
                    <button class="edit-btn" onclick="openEditItemModal('${item.name}')" title="Edit item">‚úèÔ∏è</button>
                </small>
                ${item.barcode ? `<br><small style="font-size:9px;color:var(--text-dim)">${item.barcode}</small>` : ''}
            `;
            card.onclick = () => addToCart(item);
            grid.appendChild(card);
        });
    }

    // Item editing functionality with PIN lock
    function openEditItemModal(itemName) {
        const item = db.find(i => i.name === itemName);
        if (!item) return;
        
        // Check if system is locked
        if (isLocked) {
            itemToEdit = item;
            document.getElementById('editPinInput').value = "";
            document.getElementById('editPinModal').style.display = 'flex';
            document.getElementById('editPinInput').focus();
        } else {
            // System already unlocked, proceed directly
            setupEditModal(item);
        }
    }

    function verifyEditPin() {
        let pin = document.getElementById('editPinInput').value;
        if (pin === "8514") {
            closeModal('editPinModal');
            if (itemToEdit) {
                setupEditModal(itemToEdit);
            }
        } else {
            showNotification('Incorrect PIN', 'error');
            closeModal('editPinModal');
        }
    }

    function setupEditModal(item) {
        itemToEdit = item;
        selectedEmoji = item.emoji || 'üçé';
        currentEmojiCategory = 'fruits';
        
        document.getElementById('editItemTitle').innerText = `Edit ${item.name}`;
        document.getElementById('editItemSub').innerText = `Current price: Rs ${item.price}`;
        document.getElementById('currentEmojiDisplay').innerText = selectedEmoji;
        document.getElementById('editItemPrice').value = item.price;
        
        // Set active tab
        document.querySelectorAll('.emoji-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelector('.emoji-tab[onclick*="fruits"]').classList.add('active');
        
        // Load fruits emojis by default
        loadEmojiGrid('fruits');
        
        document.getElementById('editItemModal').style.display = 'flex';
        document.getElementById('editItemPrice').focus();
    }

    function toggleEmojiPicker() {
        const picker = document.getElementById('emojiPicker');
        if (picker.style.display === 'none') {
            picker.style.display = 'block';
            loadEmojiGrid(currentEmojiCategory);
        } else {
            picker.style.display = 'none';
        }
    }

    function switchEmojiCategory(category) {
        currentEmojiCategory = category;
        
        // Update tabs
        document.querySelectorAll('.emoji-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelector(`.emoji-tab[onclick*="${category}"]`).classList.add('active');
        
        // Load emojis
        loadEmojiGrid(category);
    }

    function loadEmojiGrid(category) {
        const emojiGrid = document.getElementById('emojiGrid');
        emojiGrid.innerHTML = '';
        
        const emojis = emojiPacks[category] || emojiPacks.fruits;
        
        emojis.forEach(emoji => {
            const emojiOption = document.createElement('div');
            emojiOption.className = `emoji-option ${emoji === selectedEmoji ? 'selected' : ''}`;
            emojiOption.innerText = emoji;
            emojiOption.onclick = () => selectEmoji(emoji);
            emojiGrid.appendChild(emojiOption);
        });
    }

    function selectEmoji(emoji) {
        selectedEmoji = emoji;
        document.getElementById('currentEmojiDisplay').innerText = emoji;
        
        // Update selection in grid
        document.querySelectorAll('.emoji-option').forEach(opt => {
            opt.classList.remove('selected');
            if (opt.innerText === emoji) {
                opt.classList.add('selected');
            }
        });
    }

    function saveItemEdit() {
        if (!itemToEdit) return;
        
        const newPrice = parseFloat(document.getElementById('editItemPrice').value);
        if (isNaN(newPrice) || newPrice <= 0) {
            alert("Please enter a valid price");
            return;
        }
        
        // Update item
        itemToEdit.emoji = selectedEmoji;
        itemToEdit.price = newPrice;
        
        save();
        renderItems();
        closeEditModal();
        showNotification(`${itemToEdit.name} updated: ${selectedEmoji} Rs ${newPrice}`, 'success');
        itemToEdit = null;
    }

    function closeEditModal() {
        document.getElementById('editItemModal').style.display = 'none';
        document.getElementById('emojiPicker').style.display = 'none';
        itemToEdit = null;
    }

    // --- Enhanced Popups Logic ---
    function addToCart(item) {
        tempItem = item;
        document.getElementById('weightTitle').innerText = item.name;
        document.getElementById('weightSub').innerText = `Price: Rs ${item.price} | Stock: ${item.qty}kg`;
        document.getElementById('weightInput').value = "";
        document.getElementById('weightModal').style.display = 'flex';
        document.getElementById('weightInput').focus();
    }

    function confirmWeight() {
        let input = document.getElementById('weightInput').value;
        let weight = parseFloat(input);
        if (isNaN(weight) || weight <= 0) {
            alert("‡∂Ö‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂∂‡∂ª‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª ‡∂á‡∂≠!");
            return;
        }
        if (weight > tempItem.qty) {
            alert(`‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∑Ä‡∂≠‡∑ä ‡∂≠‡∑ú‡∂ú ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠! ‡∂á‡∂≠‡∑í ‡∂≠‡∑ú‡∂ú: ${tempItem.qty}kg`);
            return;
        }
        cart.push({ ...tempItem, weight, rowTotal: tempItem.price * weight });
        updateCartUI();
        closeModal('weightModal');
        showNotification(`${tempItem.name} added to cart`);
    }

    // Fixed weight modal close function
    function closeWeightModal() {
        document.getElementById('weightModal').style.display = 'none';
        tempItem = null;
    }

    function handleLock() {
        if (isLocked) {
            document.getElementById('pinInput').value = "";
            document.getElementById('pinModal').style.display = 'flex';
            document.getElementById('pinInput').focus();
        } else {
            isLocked = true;
            document.getElementById('lockBtn').innerText = 'üîí LOCK';
            updateStats();
            showNotification('System locked');
        }
    }

    function confirmPin() {
        let pin = document.getElementById('pinInput').value;
        if (pin === "8514") {
            isLocked = false;
            document.getElementById('lockBtn').innerText = 'üîì UNLOCKED';
            updateStats();
            closeModal('pinModal');
            showNotification('System unlocked', 'success');
        } else {
            closeModal('pinModal');
            setTimeout(() => {
                document.getElementById('pinErrorModal').style.display = 'flex';
            }, 100);
        }
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
        if (id === 'scannerModal') {
            stopScanner();
        } else if (id === 'weightModal') {
            tempItem = null;
        }
    }

    // Discount Functions
    function applyDiscount() {
        const discountInput = document.getElementById('discountInput');
        const discount = parseFloat(discountInput.value);
        
        if (isNaN(discount) || discount < 0) {
            alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂©‡∑í‡∑É‡∑ä‡∂ö‡∑Ä‡∑î‡∂±‡∑ä‡∂ß‡∑ä ‡∂∏‡∑î‡∂Ø‡∂Ω‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±");
            return;
        }
        
        const subtotal = cart.reduce((total, item) => total + item.rowTotal, 0);
        if (discount > subtotal) {
            alert("‡∂©‡∑í‡∑É‡∑ä‡∂ö‡∑Ä‡∑î‡∂±‡∑ä‡∂ß‡∑ä ‡∂∏‡∑î‡∂Ø‡∂Ω ‡∂ë‡∂ö‡∂≠‡∑î‡∑Ä‡∂ß ‡∑Ä‡∂©‡∑è ‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑ô‡∂±‡∑ä ‡∑Ä‡∑í‡∂∫ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö");
            return;
        }
        
        currentDiscount = discount;
        updateCartUI();
        document.getElementById('removeDiscountBtn').style.display = 'inline-block';
        discountInput.value = "";
        showNotification(`Discount of Rs ${discount.toFixed(2)} applied`);
    }
    
    function removeDiscount() {
        currentDiscount = 0;
        document.getElementById('discountInput').value = "";
        document.getElementById('removeDiscountBtn').style.display = 'none';
        updateCartUI();
        showNotification('Discount removed');
    }

    function updateCartUI() {
        const list = document.getElementById('cartList');
        let subtotal = 0;
        list.innerHTML = '';
        
        if (cart.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-dim);">Cart is empty<br><small>Add items from the left or scan items</small></div>';
        } else {
            cart.forEach((item, i) => {
                subtotal += item.rowTotal;
                list.innerHTML += `<div class="cart-row">
                    <span>${item.name}</span>
                    <span>${item.weight.toFixed(3)}kg</span>
                    <span>Rs ${item.price}</span>
                    <span>${item.rowTotal.toFixed(2)}</span>
                    <span onclick="removeCartItem(${i})" style="color:var(--danger);cursor:pointer;">‚úï</span>
                </div>`;
            });
        }
        
        const total = Math.max(0, subtotal - currentDiscount);
        document.getElementById('subTotal').innerText = subtotal.toFixed(2);
        document.getElementById('discountAmount').innerText = currentDiscount.toFixed(2);
        document.getElementById('grandTotal').innerText = total.toFixed(2);
        
        // Show/hide discount display
        document.getElementById('discountDisplay').style.display = currentDiscount > 0 ? 'flex' : 'none';
    }

    function removeCartItem(index) {
        const item = cart[index];
        cart.splice(index, 1);
        updateCartUI();
        showNotification(`${item.name} removed from cart`, 'warning');
    }

    function showReceipt(items, total, discount, time) {
        let html = `<div style="text-align:center"><h3>JAYANETH PRO MART</h3><p>${new Date().toLocaleDateString()} | ${time}</p></div><hr>`;
        items.forEach(i => {
            html += `<div style="display:flex; justify-content:space-between"><span>${i.name} (${i.weight}kg)</span><span>${i.rowTotal.toFixed(2)}</span></div>`;
        });
        html += `<hr>`;
        if (discount > 0) {
            html += `<div style="display:flex; justify-content:space-between"><span>Subtotal</span><span>${(total + discount).toFixed(2)}</span></div>`;
            html += `<div style="display:flex; justify-content:space-between; color:red;"><span>Discount</span><span>-${discount.toFixed(2)}</span></div>`;
        }
        html += `<div style="display:flex; justify-content:space-between; font-weight:800"><span>TOTAL</span><span>Rs ${total.toFixed(2)}</span></div><p style="text-align:center; font-size:10px; margin-top:15px;">Thank You! Come Again.</p>`;
        document.getElementById('billArea').innerHTML = html;
        document.getElementById('modal').style.display = 'flex';
    }

    function completeSale() {
        if (!cart.length) {
            alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏ ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±");
            return;
        }
        
        let subtotal = cart.reduce((a, b) => a + b.rowTotal, 0);
        let total = Math.max(0, subtotal - currentDiscount);
        let cost = cart.reduce((a, b) => a + (b.cost * b.weight), 0);
        let itemsForLog = [...cart];

        cart.forEach(c => { 
            let p = db.find(x => x.name === c.name); 
            if (p) {
                p.qty = (parseFloat(p.qty) - c.weight).toFixed(3);
                if (p.qty < 0) p.qty = 0;
            }
        });

        sales.push({ 
            total, 
            discount: currentDiscount,
            profit: total - cost, 
            date: new Date().toLocaleDateString(), 
            month: new Date().getMonth(),
            itemsCount: cart.length,
            syncId: syncId
        });
        
        addLog(`‡∂±‡∑Ä ‡∂∂‡∑í‡∂Ω‡∂ö‡∑ä ‡∂±‡∑í‡∂ö‡∑î‡∂≠‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì (Rs ${total.toFixed(2)})${currentDiscount > 0 ? ` [Discount: Rs ${currentDiscount.toFixed(2)}]` : ''}`, 'sale', { 
            items: itemsForLog, 
            total,
            discount: currentDiscount
        });
        
        showReceipt(itemsForLog, total, currentDiscount, new Date().toLocaleTimeString());
        cart = []; 
        currentDiscount = 0;
        updateCartUI(); 
        renderItems(); 
        updateStats();
        showNotification('Sale completed successfully', 'success');
    }

    function toggleStockMode() {
        let mode = document.getElementById('stType').value;
        document.getElementById('newProductForm').style.display = mode === 'in' ? 'block' : 'none';
        document.getElementById('existingProductForm').style.display = mode === 'out' ? 'block' : 'none';
        if(mode === 'out') {
            document.getElementById('stSelect').innerHTML = db.map(i => 
                `<option value="${i.name}">${i.name} (${parseFloat(i.qty).toFixed(2)}kg)</option>`
            ).join('');
        }
        
        // Clear all fields when switching modes
        clearStockForm();
    }

    function clearStockForm() {
        document.getElementById('stName').value = "";
        document.getElementById('stCost').value = "";
        document.getElementById('stPrice').value = "";
        document.getElementById('stEmoji').value = "";
        document.getElementById('stBarcode').value = "";
        document.getElementById('stQty').value = "";
    }

    function clearExpenseForm() {
        document.getElementById('expName').value = "";
        document.getElementById('expAmt').value = "";
    }

    function processStock() {
        let mode = document.getElementById('stType').value;
        let qty = parseFloat(document.getElementById('stQty').value);
        
        if(!qty || qty <= 0) {
            alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±");
            return;
        }

        if(mode === 'in') {
            let name = document.getElementById('stName').value.trim();
            let cost = parseFloat(document.getElementById('stCost').value);
            let price = parseFloat(document.getElementById('stPrice').value);
            let emoji = document.getElementById('stEmoji').value || 'üçé';
            let barcode = document.getElementById('stBarcode').value.trim();
            
            if(!name) {
                alert("‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏‡∂∫‡∑ö ‡∂±‡∂∏ ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±");
                return;
            }
            
            let existing = db.find(i => i.name.toLowerCase() === name.toLowerCase());
            if(existing) { 
                existing.qty = (parseFloat(existing.qty) + qty).toFixed(3);
                if (barcode && !existing.barcode) {
                    existing.barcode = barcode;
                }
                addLog(`‡∂≠‡∑ú‡∂ú ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì: ${name} (+${qty}kg)`, 'stock');
                showNotification(`${name} stock increased by ${qty}kg`, 'success');
            } else {
                if(!cost || cost <= 0 || !price || price <= 0) {
                    alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂∏‡∑í‡∂Ω‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±");
                    return;
                }
                db.push({ 
                    name, 
                    cost: cost, 
                    price: price, 
                    qty, 
                    emoji: emoji,
                    barcode: barcode || null,
                    category: document.getElementById('stCat').value
                }); 
                addLog(`‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏‡∂∫‡∂ö‡∑ä ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì: ${name}`, 'stock');
                showNotification(`New item added: ${name}`, 'success');
            }
        } else {
            let itemName = document.getElementById('stSelect').value;
            let item = db.find(i => i.name === itemName);
            
            if(!item) {
                alert("‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏‡∂∫ ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑ì‡∂∫");
                return;
            }
            
            if(qty > parseFloat(item.qty)) {
                alert(`‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∑Ä‡∂≠‡∑ä ‡∂≠‡∑ú‡∂ú ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠! ‡∂á‡∂≠‡∑í ‡∂≠‡∑ú‡∂ú: ${item.qty}kg`);
                return;
            }
            
            item.qty = (parseFloat(item.qty) - qty).toFixed(3);
            wastage.push({ 
                name: item.name, 
                loss: qty * item.cost, 
                quantity: qty,
                date: new Date().toLocaleDateString(), 
                month: new Date().getMonth(),
                syncId: syncId
            });
            addLog(`‡∂Ö‡∂¥‡∂≠‡∑ö ‡∂∫‡∑è‡∂∏‡∑ä ‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì: ${item.name} (-${qty}kg)`, 'waste');
            showNotification(`${item.name} stock reduced by ${qty}kg`, 'warning');
        }
        
        // Clear form after successful operation
        clearStockForm();
        save(); 
        renderItems(); 
        updateStats();
        
        // Refresh the dropdown for waste mode
        if(mode === 'out') {
            document.getElementById('stSelect').innerHTML = db.map(i => 
                `<option value="${i.name}">${i.name} (${parseFloat(i.qty).toFixed(2)}kg)</option>`
            ).join('');
        }
    }

    function addExpense() {
        let n = document.getElementById('expName').value.trim();
        let a = parseFloat(document.getElementById('expAmt').value);
        
        if(!n) {
            alert("‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ö ‡∑Ñ‡∑ö‡∂≠‡∑î‡∑Ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±");
            return;
        }
        
        if(!a || a <= 0) {
            alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂∏‡∑î‡∂Ø‡∂Ω‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±");
            return;
        }
        
        expenses.push({ 
            name: n, 
            amt: a, 
            date: new Date().toLocaleDateString(), 
            month: new Date().getMonth(),
            syncId: syncId
        });
        addLog(`‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì: ${n} (Rs ${a})`, 'expense');
        showNotification(`Expense added: ${n} - Rs ${a.toFixed(2)}`, 'warning');
        
        clearExpenseForm();
        save(); 
        updateStats();
    }

    function updateStats() {
        let today = new Date().toLocaleDateString();
        let curMonth = new Date().getMonth();
        let daySales = sales.filter(s => s.date === today);
        let dayRev = daySales.reduce((a, b) => a + b.total, 0);
        let dayGrossProf = daySales.reduce((a, b) => a + b.profit, 0);
        let dayLoss = wastage.filter(w => w.date === today).reduce((a, b) => a + b.loss, 0) + expenses.filter(e => e.date === today).reduce((a, b) => a + b.amt, 0);
        let monthProf = sales.filter(s => s.month === curMonth).reduce((a, b) => a + b.profit, 0) - wastage.filter(w => w.month === curMonth).reduce((a, b) => a + b.loss, 0) - expenses.filter(e => e.month === curMonth).reduce((a, b) => a + b.amt, 0);

        document.getElementById('statRev').innerText = `Rs ${dayRev.toFixed(2)}`;
        document.getElementById('statProf').innerText = `Rs ${(dayGrossProf - dayLoss).toFixed(2)}`;
        document.getElementById('rDayRev').innerText = dayRev.toFixed(2);
        document.getElementById('rDayProf').innerText = (dayGrossProf - dayLoss).toFixed(2);
        document.getElementById('rDayLoss').innerText = dayLoss.toFixed(2);
        document.getElementById('rMonthProf').innerText = monthProf.toFixed(2);
        document.getElementById('summaryText').innerHTML = `‡∂Ω‡∑è‡∂∑‡∂∫: Rs ${dayGrossProf.toFixed(2)} | ‡∂¥‡∑è‡∂©‡∑î: Rs ${dayLoss.toFixed(2)}<br><b>‡∑Å‡∑î‡∂Ø‡∑ä‡∂∞ ‡∂Ω‡∑è‡∂∑‡∂∫: Rs ${(dayGrossProf - dayLoss).toFixed(2)}</b>`;
        
        const targets = document.querySelectorAll('.privacy-target');
        const reportWrapper = document.getElementById('reportPrivacyWrapper');
        if(isLocked) { 
            targets.forEach(e => e.classList.add('privacy-blur')); 
            reportWrapper.classList.add('privacy-blur'); 
        } else { 
            targets.forEach(e => e.classList.remove('privacy-blur')); 
            reportWrapper.classList.remove('privacy-blur'); 
        }
    }

    function switchTab(t) {
        ['view-pos', 'view-stock', 'view-reports'].forEach(v => document.getElementById(v).style.display = 'none');
        document.getElementById('view-' + t).style.display = t === 'pos' ? 'contents' : 'block';
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        document.getElementById('tab-' + t).classList.add('active');
        
        if(t === 'stock') {
            renderLogs();
            // Initialize the dropdown for waste mode
            document.getElementById('stSelect').innerHTML = db.map(i => 
                `<option value="${i.name}">${i.name} (${parseFloat(i.qty).toFixed(2)}kg)</option>`
            ).join('');
        }
    }

    // =============================================
    // QR/BARCODE SCANNER FUNCTIONS
    // =============================================
    function showScanner(mode) {
        currentScannerMode = mode;
        document.getElementById('scannerModal').style.display = 'flex';
        document.getElementById('scanner-result').style.display = 'none';
    }

    function startScanner() {
        const scannerContainer = document.getElementById('scanner-container');
        scannerContainer.innerHTML = '';
        
        // Create scanner element
        const scannerElement = document.createElement('div');
        scannerElement.id = 'qr-reader';
        scannerElement.style.width = '100%';
        scannerElement.style.height = '100%';
        scannerContainer.appendChild(scannerElement);
        
        // Initialize scanner
        scanner = new Html5Qrcode("qr-reader");
        
        const config = { 
            fps: 10, 
            qrbox: { width: 250, height: 250 },
            supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
            facingMode: "environment"
        };
        
        scanner.start(
            { facingMode: "environment" },
            config,
            onScanSuccess,
            onScanError
        ).catch(err => {
            console.error("Scanner error:", err);
            alert("Unable to start camera. Please check permissions.");
        });
    }

    function stopScanner() {
        if (scanner) {
            scanner.stop().then(() => {
                scanner = null;
                const scannerContainer = document.getElementById('scanner-container');
                scannerContainer.innerHTML = `
                    <div id="scanner-placeholder">
                        <div class="scanner-icon">üì∑</div>
                        <div>Camera scanner stopped</div>
                    </div>
                `;
            }).catch(err => {
                console.error("Error stopping scanner:", err);
            });
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        console.log(`Scan result: ${decodedText}`, decodedResult);
        
        // Display scanned result
        document.getElementById('scanned-text').innerHTML = `
            <strong>Scanned:</strong> ${decodedText}<br>
            <small>${new Date().toLocaleTimeString()}</small>
        `;
        document.getElementById('scanner-result').style.display = 'block';
        
        // Process based on scanner mode
        processScannedCode(decodedText);
        
        // Stop scanner after successful scan
        setTimeout(() => {
            if (scanner) {
                stopScanner();
            }
        }, 1000);
    }

    function onScanError(errorMessage) {
        // Don't show errors to user unless it's critical
        console.log(`Scan error: ${errorMessage}`);
    }

    function processScannedCode(code) {
        // Clean the code
        code = code.trim();
        
        // Try to find item by barcode
        let item = db.find(i => i.barcode === code);
        
        // If not found by barcode, try to find by name
        if (!item) {
            item = db.find(i => i.name.toLowerCase().includes(code.toLowerCase()));
        }
        
        if (item) {
            // Item found
            switch(currentScannerMode) {
                case 'pos':
                    // Add to cart from POS view
                    addToCart(item);
                    closeModal('scannerModal');
                    break;
                    
                case 'bill':
                    // Add to cart from billing view
                    addToCart(item);
                    closeModal('scannerModal');
                    break;
                    
                case 'stock':
                    // Pre-fill stock form
                    document.getElementById('stName').value = item.name;
                    document.getElementById('stCost').value = item.cost;
                    document.getElementById('stPrice').value = item.price;
                    document.getElementById('stEmoji').value = item.emoji || 'üçé';
                    document.getElementById('stBarcode').value = item.barcode || '';
                    document.getElementById('stCat').value = item.category || 'Fruit';
                    closeModal('scannerModal');
                    showNotification(`Item ${item.name} loaded`, 'success');
                    break;
            }
        } else {
            // Item not found
            switch(currentScannerMode) {
                case 'pos':
                case 'bill':
                    alert("Item not found in database. Please add it first in Stock Control.");
                    // Optionally switch to stock tab
                    switchTab('stock');
                    break;
                    
                case 'stock':
                    // For new items, just fill the barcode field
                    document.getElementById('stBarcode').value = code;
                    showNotification(`Barcode ${code} saved. Fill other details.`, 'info');
                    break;
            }
        }
    }

    // Generate barcode for items
    function generateBarcode(itemName) {
        // Simple barcode generation using item name hash
        const hash = Array.from(itemName).reduce((acc, char) => {
            return ((acc << 5) - acc) + char.charCodeAt(0);
        }, 0);
        return 'JM' + Math.abs(hash).toString().substring(0, 8);
    }

    // Initialize on load
    window.onload = () => { 
        renderItems(); 
        updateStats(); 
        renderLogs();
        updateCartUI();
        
        // Generate barcodes for existing items if not present
        let needsSave = false;
        db.forEach(item => {
            if (!item.barcode) {
                item.barcode = generateBarcode(item.name);
                needsSave = true;
            }
        });
        if (needsSave) save();
        
        // Show welcome message
        setTimeout(() => {
            showNotification('Jayaneth Pro Mart POS Ready');
        }, 1000);
    };

    // Handle beforeunload to clean up scanner
    window.addEventListener('beforeunload', () => {
        if (scanner) {
            stopScanner();
        }
    });
</script>
</body>
</html>
