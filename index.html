<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JAYANETH PRO | ADVANCED GLASS POS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-dark: #050608;
            --glass-bg: rgba(15, 18, 22, 0.85);
            --glass-border: rgba(255, 255, 255, 0.12);
            --neon-green: #8aff67;
            --neon-blue: #00f2ff;
            --danger: #ff4747;
            --orange: #ff9f43;
            --text-main: #ffffff;
            --text-dim: #94a3b8;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body { 
            margin: 0; 
            height: 100vh; 
            background: radial-gradient(circle at 70% 20%, #0d1a0d, #050608); 
            color: var(--text-main); 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: relative;
        }

        body::before {
            content: "";
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 100 100'%3E%3Cg fill='none' stroke='%23ffffff' stroke-width='0.6' stroke-opacity='0.12'%3E%3Cpath d='M20 20c5-10 15-10 20 0s-5 15-10 15-15-5-10-15z'/%3E%3Cpath d='M70 30c0-10 10-15 15-5s-5 15-10 15-5-5-5-10z'/%3E%3Cpath d='M40 70c0-10 15-10 15 0s-5 15-10 15-5-5-5-10z'/%3E%3Ccircle cx='15' cy='75' r='8'/%3E%3Cpath d='M80 80l5-10h-10z'/%3E%3Cpath d='M10 10l5 5-5 5z'/%3E%3Cpath d='M50 10c5 5 5 15 0 20s-15 5-20 0 5-15 10-20 10 0 10 0z'/%3E%3C/g%3E%3C/svg%3E");
            background-repeat: repeat; filter: blur(0.5px); z-index: -1;
        }

        .glass { background: var(--glass-bg); backdrop-filter: blur(25px); border: 1px solid var(--glass-border); border-radius: 18px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .privacy-blur { filter: blur(25px); pointer-events: none; transition: 0.5s; opacity: 0.3; }

        header { padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.6); border-bottom: 1px solid var(--glass-border); z-index: 10; }
        .logo h1 { margin: 0; font-size: 22px; font-weight: 800; }
        .logo span { color: var(--neon-green); }

        .dashboard-stats { display: flex; gap: 12px; }
        .mini-stat { padding: 8px 15px; text-align: right; min-width: 120px; }
        .stat-label { font-size: 9px; color: var(--text-dim); text-transform: uppercase; font-weight: 800; }
        .stat-val { display: block; font-family: 'JetBrains Mono'; font-size: 15px; }

        nav { display: flex; gap: 10px; padding: 12px 30px; background: rgba(0,0,0,0.3); z-index: 10; }
        .nav-link { background: var(--glass-bg); border: 1px solid var(--glass-border); color: white; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 12px; font-weight: 600; }
        .nav-link.active { background: var(--neon-green); color: black; border-color: var(--neon-green); }

        main { flex: 1; display: flex; padding: 20px; gap: 20px; overflow: hidden; }
        .left-col { flex: 1.8; display: flex; flex-direction: column; gap: 15px; }
        .right-col { flex: 1.2; display: flex; flex-direction: column; }

        .search-bar, select { width: 100%; padding: 12px 15px; border-radius: 10px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.4); color: white; margin-bottom: 10px; }
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; overflow-y: auto; }
        .item-card { padding: 15px 10px; text-align: center; cursor: pointer; transition: 0.3s; position: relative; }
        .item-card:hover { border-color: var(--neon-green); background: rgba(138, 255, 103, 0.05); }
        
        .stock-badge { position: absolute; top: 8px; right: 8px; font-size: 9px; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; }
        .cart-table { flex: 1; overflow-y: auto; padding: 10px; }
        .cart-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 5px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 12px; }

        .grand-total { font-family: 'JetBrains Mono'; font-size: 24px; color: var(--neon-green); font-weight: 800; }
        .btn-action { width: 100%; padding: 15px; border: none; border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: 800; margin-top: 10px; }
        .btn-pay { background: var(--neon-green); color: black; }

        .history-list { margin-top: 20px; max-height: 300px; overflow-y: auto; font-size: 13px; }
        .history-item { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
        .btn-view { background: #333; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }

        /* Universal Popup Styles */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 2000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(10px); }
        .receipt-box { background: white; color: black; padding: 20px; width: 100%; max-width: 320px; border-radius: 8px; font-family: 'JetBrains Mono'; font-size: 12px; }
        
        /* Modern Input Modals */
        .glass-popup { background: var(--glass-bg); border: 1px solid var(--glass-border); padding: 30px; border-radius: 24px; width: 100%; max-width: 380px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .popup-title { font-size: 18px; font-weight: 800; margin-bottom: 10px; color: var(--neon-blue); }
        .popup-sub { font-size: 12px; color: var(--text-dim); margin-bottom: 20px; }
        .popup-input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.05); color: white; font-size: 20px; text-align: center; font-family: 'JetBrains Mono'; margin-bottom: 20px; outline: none; }
        .popup-btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-cancel { background: rgba(255,255,255,0.1); color: white; }

        /* New PIN Error Modal */
        .pin-error-modal { background: var(--glass-bg); border: 1px solid var(--danger); padding: 25px; border-radius: 20px; width: 90%; max-width: 300px; text-align: center; }
        .pin-error-icon { font-size: 40px; margin-bottom: 15px; color: var(--danger); }
        .pin-error-title { font-size: 16px; font-weight: 800; margin-bottom: 10px; color: var(--danger); }
        .pin-error-text { font-size: 12px; color: var(--text-dim); margin-bottom: 20px; }
        .pin-error-btn { background: var(--danger); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: 600; }

        /* Discount Row Styles */
        .discount-row { display: flex; align-items: center; gap: 10px; margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 10px; }
        .discount-label { font-size: 12px; color: var(--text-dim); }
        .discount-input { width: 80px; padding: 8px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.05); color: white; text-align: center; }
        .apply-discount-btn { padding: 8px 15px; border-radius: 8px; background: var(--orange); color: black; border: none; cursor: pointer; font-weight: 600; }
        .remove-discount-btn { padding: 8px 15px; border-radius: 8px; background: var(--danger); color: white; border: none; cursor: pointer; font-weight: 600; }

        /* New Item Added Notification */
        .notification { position: fixed; top: 20px; right: 20px; background: var(--neon-green); color: black; padding: 12px 20px; border-radius: 10px; font-weight: 600; z-index: 3000; animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body>

<header>
    <div class="logo"><h1>JAYANETH <span>PRO MART</span></h1></div>
    <div class="dashboard-stats">
        <div class="mini-stat glass"><span class="stat-label">Daily Revenue</span><span id="statRev" class="stat-val privacy-target">Rs 0.00</span></div>
        <div class="mini-stat glass"><span class="stat-label">Daily Profit</span><span id="statProf" class="stat-val privacy-target" style="color: var(--neon-green);">Rs 0.00</span></div>
        <button class="nav-link" id="lockBtn" onclick="handleLock()">üîí LOCK</button>
    </div>
</header>

<nav>
    <button class="nav-link active" id="tab-pos" onclick="switchTab('pos')">POS</button>
    <button class="nav-link" id="tab-stock" onclick="switchTab('stock')">STOCK CONTROL</button>
    <button class="nav-link" id="tab-reports" onclick="switchTab('reports')">P&L REPORTS</button>
</nav>

<div id="view-pos" style="display: contents;">
    <main>
        <div class="left-col">
            <input type="text" id="pSearch" class="search-bar" placeholder="üîç Search items..." oninput="renderItems()">
            <div class="item-grid" id="itemGrid"></div>
        </div>
        <div class="right-col glass">
            <div style="padding: 15px; border-bottom: 1px solid var(--glass-border); font-weight: 800;">BILLING</div>
            <div class="cart-table" id="cartList"></div>
            
            <div style="padding: 10px 15px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--glass-border);">
                <div class="discount-row">
                    <span class="discount-label">Discount:</span>
                    <input type="number" id="discountInput" class="discount-input" placeholder="Rs" min="0">
                    <button class="apply-discount-btn" onclick="applyDiscount()">Apply</button>
                    <button class="remove-discount-btn" onclick="removeDiscount()" style="display:none;" id="removeDiscountBtn">Remove</button>
                </div>
                <div style="font-size: 11px; color: var(--text-dim); margin-top: 5px;">Enter amount in Rupees to deduct from total</div>
            </div>
            
            <div style="padding: 20px; background: rgba(0,0,0,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <span style="font-size: 12px; color: var(--text-dim);">SUBTOTAL</span>
                    <span id="subTotal" style="font-family: 'JetBrains Mono';">0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;" id="discountDisplay">
                    <span style="font-size: 12px; color: var(--danger);">DISCOUNT</span>
                    <span id="discountAmount" style="font-family: 'JetBrains Mono'; color: var(--danger);">0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 12px; color: var(--text-dim);">TOTAL</span>
                    <span id="grandTotal" class="grand-total">0.00</span>
                </div>
                <button class="btn-action btn-pay" onclick="completeSale()">COMPLETE SALE</button>
            </div>
        </div>
    </main>
</div>

<div id="view-stock" style="display: none; padding: 30px; overflow-y: auto;">
    <div style="max-width: 1000px; margin: auto;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="glass" style="padding: 20px;">
                <div style="font-weight: 800; margin-bottom: 20px;">STOCK UPDATE</div>
                <select id="stType" onchange="toggleStockMode()">
                    <option value="in">ADD NEW / REFILL (‡∑É‡∑ä‡∂ß‡∑ú‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏)</option>
                    <option value="out">WASTAGE / DAMAGE (‡∂ö‡∑î‡∂´‡∑î ‡∑Ä‡∑ñ/‡∂¥‡∑è‡∂©‡∑î ‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏)</option>
                </select>
                <div id="newProductForm">
                    <input type="text" id="stName" placeholder="Item Name" class="search-bar">
                    <select id="stCat" class="search-bar"><option value="Fruit">Fruit</option><option value="Veg">Vegetable</option></select>
                    <input type="number" id="stCost" placeholder="Cost Price (1kg)" class="search-bar">
                    <input type="number" id="stPrice" placeholder="Selling Price (1kg)" class="search-bar">
                    <input type="text" id="stEmoji" placeholder="Emoji (üçé)" class="search-bar">
                </div>
                <div id="existingProductForm" style="display:none;">
                    <select id="stSelect" class="search-bar"></select>
                </div>
                <input type="number" id="stQty" placeholder="Weight (kg)" class="search-bar">
                <button class="btn-action btn-pay" onclick="processStock()">UPDATE INVENTORY</button>
                <div style="font-size: 11px; color: var(--text-dim); margin-top: 10px; text-align: center;">
                    Note: All fields will clear after adding
                </div>
            </div>
            <div class="glass" style="padding: 20px;">
                <div style="font-weight: 800; margin-bottom: 20px;">OTHER EXPENSES</div>
                <input type="text" id="expName" placeholder="Reason" class="search-bar">
                <input type="number" id="expAmt" placeholder="Amount (Rs)" class="search-bar">
                <button class="btn-action" style="background:var(--orange); color:black;" onclick="addExpense()">ADD EXPENSE</button>
                <div style="font-size: 11px; color: var(--text-dim); margin-top: 10px; text-align: center;">
                    Note: Fields will clear after adding
                </div>
            </div>
        </div>

        <div class="glass" style="margin-top: 20px; padding: 20px;">
            <div style="font-weight: 800; border-bottom: 1px solid #333; padding-bottom: 10px;">RECENT ACTIVITY (‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂ö‡∑è‡∂ª‡∂ö‡∂∏‡∑ä ‡∑É‡∂ß‡∑Ñ‡∂±)</div>
            <div class="history-list" id="historyLog"></div>
        </div>
    </div>
</div>

<div id="view-reports" style="display: none; padding: 30px; overflow-y: auto;">
    <div id="reportPrivacyWrapper" class="privacy-blur">
        <div class="rep-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div class="glass" style="padding:20px; text-align:center;"><span class="stat-label">Daily Revenue</span><h2 id="rDayRev">0.00</h2></div>
            <div class="glass" style="padding:20px; text-align:center;"><span class="stat-label">Daily Profit (Net)</span><h2 id="rDayProf" style="color:var(--neon-green)">0.00</h2></div>
            <div class="glass" style="padding:20px; text-align:center;"><span class="stat-label">Daily Loss</span><h2 id="rDayLoss" style="color:var(--danger)">0.00</h2></div>
            <div class="glass" style="padding:20px; text-align:center;"><span class="stat-label">Monthly Net Profit</span><h2 id="rMonthProf" style="color:var(--neon-blue)">0.00</h2></div>
        </div>
        <div class="glass" style="padding: 20px;">
            <h3>Today's Summary</h3>
            <div id="summaryText"></div>
        </div>
    </div>
</div>

<div class="modal" id="pinModal">
    <div class="glass-popup">
        <div class="popup-title">ENTER PIN</div>
        <div class="popup-sub">Please enter the security PIN to unlock reports</div>
        <input type="password" id="pinInput" class="popup-input" placeholder="****" maxlength="4" onkeydown="if(event.key === 'Enter') confirmPin()">
        <div class="popup-btn-grid">
            <button class="btn-action btn-cancel" onclick="closeModal('pinModal')">CANCEL</button>
            <button class="btn-action btn-pay" onclick="confirmPin()">UNLOCK</button>
        </div>
    </div>
</div>

<div class="modal" id="weightModal">
    <div class="glass-popup">
        <div class="popup-title" id="weightTitle">ENTER WEIGHT</div>
        <div class="popup-sub" id="weightSub">Enter weight in kilograms</div>
        <input type="number" id="weightInput" class="popup-input" placeholder="0.000" step="0.001" onkeydown="if(event.key === 'Enter') confirmWeight()">
        <div class="popup-btn-grid">
            <button class="btn-action btn-cancel" onclick="closeModal('weightModal')">CANCEL</button>
            <button class="btn-action btn-pay" onclick="confirmWeight()">ADD TO CART</button>
        </div>
    </div>
</div>

<div class="modal" id="modal">
    <div class="receipt-box" id="billArea"></div>
    <div style="text-align: center; width: 100%;">
        <button class="btn-action btn-pay" style="width: 200px;" onclick="closeModal('modal')">OK</button>
    </div>
</div>

<div class="modal" id="pinErrorModal">
    <div class="pin-error-modal">
        <div class="pin-error-icon">‚ö†Ô∏è</div>
        <div class="pin-error-title">‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í PIN ‡∂Ö‡∂Ç‡∂ö‡∂∫‡∂ö‡∑í!</div>
        <div class="pin-error-text">‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í PIN ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.</div>
        <button class="pin-error-btn" onclick="closeModal('pinErrorModal')">OK</button>
    </div>
</div>

<script>
    // -------------------------------------------------------------------------
    // FIREBASE ‡∑É‡∑ê‡∂ö‡∑É‡∑î‡∂∏‡∑ä (‡∂î‡∂∂‡∑ö Firebase ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∂∏‡∑ô‡∑Ñ‡∑í ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±)
    // -------------------------------------------------------------------------
    const firebaseConfig = {
  apiKey: "AIzaSyAdw73seKGjO0VLFZuMj9gJaiSmnpc3N0M",
  authDomain: "pos-system-dc0e0.firebaseapp.com",
  databaseURL: "https://pos-system-dc0e0-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "pos-system-dc0e0",
  storageBucket: "pos-system-dc0e0.firebasestorage.app",
  messagingSenderId: "251115370846",
  appId: "1:251115370846:web:f7cfe5b3f38f71d67077cf",
  measurementId: "G-CGRK6HPBLX"
};

    // Firebase ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Global variables
    let db = JSON.parse(localStorage.getItem('jmart_db')) || [];
    let sales = JSON.parse(localStorage.getItem('jmart_sales')) || [];
    let expenses = JSON.parse(localStorage.getItem('jmart_exp')) || [];
    let wastage = JSON.parse(localStorage.getItem('jmart_waste')) || [];
    let logs = JSON.parse(localStorage.getItem('jmart_logs')) || [];
    let cart = [];
    let currentDiscount = 0;
    let isLocked = true;
    let tempItem = null;
    
    // Device sync key for multi-device support
    const SYNC_KEY = 'jmart_sync_id';
    let syncId = localStorage.getItem(SYNC_KEY) || generateSyncId();
    localStorage.setItem(SYNC_KEY, syncId);

    // Generate unique device ID for sync
    function generateSyncId() {
        return 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // --- CLOUD SYNC: ‡∂Ö‡∂±‡∑ä‡∂≠‡∂ª‡∑ä‡∂¢‡∑è‡∂Ω‡∂∫‡∑ô‡∂±‡∑ä ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂± ‡∑Ä‡∑í‡∂ß UPDATE ‡∑Ä‡∑ì‡∂∏ ---
    database.ref('pos_data').on('value', (snapshot) => {
        const cloudData = snapshot.val();
        if (cloudData && cloudData.last_source !== syncId) {
            db = cloudData.db || [];
            sales = cloudData.sales || [];
            expenses = cloudData.expenses || [];
            wastage = cloudData.wastage || [];
            logs = cloudData.logs || [];
            
            // Local ‡∂ë‡∂ö‡∂ß‡∂Ø ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏
            localStorage.setItem('jmart_db', JSON.stringify(db));
            localStorage.setItem('jmart_sales', JSON.stringify(sales));
            localStorage.setItem('jmart_exp', JSON.stringify(expenses));
            localStorage.setItem('jmart_waste', JSON.stringify(wastage));
            localStorage.setItem('jmart_logs', JSON.stringify(logs));

            renderItems();
            updateStats();
            renderLogs();
            showNotification('Cloud Data Updated');
        }
    });

    // Save function with Cloud Support (‡∂∏‡∑î‡∂Ω‡∑ä ‡∂ë‡∂ö‡∂ß ‡∂Ö‡∂∏‡∂≠‡∂ª‡∑Ä Firebase ‡∂ë‡∂ö‡∂ß‡∂Ø Save ‡∂ö‡∂ª‡∂∫‡∑í)
    function save() {
        localStorage.setItem('jmart_last_update_source', syncId);
        localStorage.setItem('jmart_db', JSON.stringify(db));
        localStorage.setItem('jmart_sales', JSON.stringify(sales));
        localStorage.setItem('jmart_exp', JSON.stringify(expenses));
        localStorage.setItem('jmart_waste', JSON.stringify(wastage));
        localStorage.setItem('jmart_logs', JSON.stringify(logs));
        localStorage.setItem('jmart_last_update', new Date().toISOString());

        // Cloud Backup
        database.ref('pos_data').set({
            db, sales, expenses, wastage, logs,
            last_source: syncId,
            timestamp: Date.now()
        });
    }

    // Show notification function
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        notification.style.background = type === 'error' ? 'var(--danger)' : 
                                      type === 'success' ? 'var(--neon-green)' : 
                                      type === 'warning' ? 'var(--orange)' : 'var(--neon-blue)';
        notification.style.color = type === 'error' ? 'white' : 'black';
        
        document.body.appendChild(notification);
        
        // Remove after animation
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }

    function addLog(msg, type, data = null) {
        logs.unshift({ 
            msg, 
            type, 
            data, 
            time: new Date().toLocaleTimeString(), 
            date: new Date().toLocaleDateString(), 
            id: Date.now(),
            syncId: syncId 
        });
        if(logs.length > 50) logs.pop();
        save();
        renderLogs();
    }

    function renderLogs() {
        const logBox = document.getElementById('historyLog');
        logBox.innerHTML = logs.map(l => `
            <div class="history-item">
                <span>[${l.time}] ${l.msg}</span>
                ${l.type === 'sale' ? `<button class="btn-view" onclick="viewOldBill(${l.id})">VIEW BILL</button>` : ''}
            </div>
        `).join('');
    }

    function viewOldBill(logId) {
        let log = logs.find(x => x.id === logId);
        if(!log || !log.data) return;
        showReceipt(log.data.items, log.data.total, log.data.discount || 0, log.time);
    }

    function renderItems() {
        const grid = document.getElementById('itemGrid');
        const query = document.getElementById('pSearch').value.toLowerCase();
        grid.innerHTML = '';
        db.filter(i => i.name.toLowerCase().includes(query)).forEach(item => {
            const card = document.createElement('div');
            card.className = 'item-card glass';
            card.innerHTML = `<span class="stock-badge">${parseFloat(item.qty).toFixed(2)}kg</span><div style="font-size:30px;">${item.emoji}</div><b>${item.name}</b><br><small>Rs ${item.price}</small>`;
            card.onclick = () => addToCart(item);
            grid.appendChild(card);
        });
    }

    // --- Enhanced Popups Logic ---
    function addToCart(item) {
        tempItem = item;
        document.getElementById('weightTitle').innerText = item.name;
        document.getElementById('weightSub').innerText = `Price: Rs ${item.price} | Stock: ${item.qty}kg`;
        document.getElementById('weightInput').value = "";
        document.getElementById('weightModal').style.display = 'flex';
        document.getElementById('weightInput').focus();
    }

    function confirmWeight() {
        let input = document.getElementById('weightInput').value;
        let weight = parseFloat(input);
        if (isNaN(weight) || weight <= 0) {
            alert("‡∂Ö‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂∂‡∂ª‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª ‡∂á‡∂≠!");
            return;
        }
        if (weight > tempItem.qty) {
            alert(`‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∑Ä‡∂≠‡∑ä ‡∂≠‡∑ú‡∂ú ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠! ‡∂á‡∂≠‡∑í ‡∂≠‡∑ú‡∂ú: ${tempItem.qty}kg`);
            return;
        }
        cart.push({ ...tempItem, weight, rowTotal: tempItem.price * weight });
        updateCartUI();
        closeModal('weightModal');
        showNotification(`${tempItem.name} added to cart`);
    }

    function handleLock() {
        if (isLocked) {
            document.getElementById('pinInput').value = "";
            document.getElementById('pinModal').style.display = 'flex';
            document.getElementById('pinInput').focus();
        } else {
            isLocked = true;
            document.getElementById('lockBtn').innerText = 'üîí LOCK';
            updateStats();
            showNotification('Reports locked');
        }
    }

    function confirmPin() {
        let pin = document.getElementById('pinInput').value;
        if (pin === "8514") {
            isLocked = false;
            document.getElementById('lockBtn').innerText = 'üîì UNLOCKED';
            updateStats();
            closeModal('pinModal');
            showNotification('Reports unlocked', 'success');
        } else {
            closeModal('pinModal');
            setTimeout(() => {
                document.getElementById('pinErrorModal').style.display = 'flex';
            }, 100);
        }
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    // Discount Functions
    function applyDiscount() {
        const discountInput = document.getElementById('discountInput');
        const discount = parseFloat(discountInput.value);
        
        if (isNaN(discount) || discount < 0) {
            alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂©‡∑í‡∑É‡∑ä‡∂ö‡∑Ä‡∑î‡∂±‡∑ä‡∂ß‡∑ä ‡∂∏‡∑î‡∂Ø‡∂Ω‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±");
            return;
        }
        
        const subtotal = cart.reduce((total, item) => total + item.rowTotal, 0);
        if (discount > subtotal) {
            alert("‡∂©‡∑í‡∑É‡∑ä‡∂ö‡∑Ä‡∑î‡∂±‡∑ä‡∂ß‡∑ä ‡∂∏‡∑î‡∂Ø‡∂Ω ‡∂ë‡∂ö‡∂≠‡∑î‡∑Ä‡∂ß ‡∑Ä‡∂©‡∑è ‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑ô‡∂±‡∑ä ‡∑Ä‡∑í‡∂∫ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö");
            return;
        }
        
        currentDiscount = discount;
        updateCartUI();
        document.getElementById('removeDiscountBtn').style.display = 'inline-block';
        discountInput.value = "";
        showNotification(`Discount of Rs ${discount.toFixed(2)} applied`);
    }
    
    function removeDiscount() {
        currentDiscount = 0;
        document.getElementById('discountInput').value = "";
        document.getElementById('removeDiscountBtn').style.display = 'none';
        updateCartUI();
        showNotification('Discount removed');
    }

    function updateCartUI() {
        const list = document.getElementById('cartList');
        let subtotal = 0;
        list.innerHTML = '';
        
        if (cart.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-dim);">Cart is empty<br><small>Add items from the left</small></div>';
        } else {
            cart.forEach((item, i) => {
                subtotal += item.rowTotal;
                list.innerHTML += `<div class="cart-row"><span>${item.name}</span><span>${item.weight.toFixed(3)}kg</span><span></span><span>${item.rowTotal.toFixed(2)}</span><span onclick="removeCartItem(${i})" style="color:var(--danger);cursor:pointer;">‚úï</span></div>`;
            });
        }
        
        const total = Math.max(0, subtotal - currentDiscount);
        document.getElementById('subTotal').innerText = subtotal.toFixed(2);
        document.getElementById('discountAmount').innerText = currentDiscount.toFixed(2);
        document.getElementById('grandTotal').innerText = total.toFixed(2);
        
        // Show/hide discount display
        document.getElementById('discountDisplay').style.display = currentDiscount > 0 ? 'flex' : 'none';
    }

    function removeCartItem(index) {
        const item = cart[index];
        cart.splice(index, 1);
        updateCartUI();
        showNotification(`${item.name} removed from cart`, 'warning');
    }

    function showReceipt(items, total, discount, time) {
        let html = `<div style="text-align:center"><h3>JAYANETH PRO MART</h3><p>${new Date().toLocaleDateString()} | ${time}</p></div><hr>`;
        items.forEach(i => {
            html += `<div style="display:flex; justify-content:space-between"><span>${i.name} (${i.weight}kg)</span><span>${i.rowTotal.toFixed(2)}</span></div>`;
        });
        html += `<hr>`;
        if (discount > 0) {
            html += `<div style="display:flex; justify-content:space-between"><span>Subtotal</span><span>${(total + discount).toFixed(2)}</span></div>`;
            html += `<div style="display:flex; justify-content:space-between; color:red;"><span>Discount</span><span>-${discount.toFixed(2)}</span></div>`;
        }
        html += `<div style="display:flex; justify-content:space-between; font-weight:800"><span>TOTAL</span><span>Rs ${total.toFixed(2)}</span></div><p style="text-align:center; font-size:10px; margin-top:15px;">Thank You! Come Again.</p>`;
        document.getElementById('billArea').innerHTML = html;
        document.getElementById('modal').style.display = 'flex';
    }

    function completeSale() {
        if (!cart.length) {
            alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏ ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±");
            return;
        }
        
        let subtotal = cart.reduce((a, b) => a + b.rowTotal, 0);
        let total = Math.max(0, subtotal - currentDiscount);
        let cost = cart.reduce((a, b) => a + (b.cost * b.weight), 0);
        let itemsForLog = [...cart];

        cart.forEach(c => { 
            let p = db.find(x => x.name === c.name); 
            if (p) {
                p.qty = (parseFloat(p.qty) - c.weight).toFixed(3);
                if (p.qty < 0) p.qty = 0;
            }
        });

        sales.push({ 
            total, 
            discount: currentDiscount,
            profit: total - cost, 
            date: new Date().toLocaleDateString(), 
            month: new Date().getMonth(),
            itemsCount: cart.length,
            syncId: syncId
        });
        
        addLog(`‡∂±‡∑Ä ‡∂∂‡∑í‡∂Ω‡∂ö‡∑ä ‡∂±‡∑í‡∂ö‡∑î‡∂≠‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì (Rs ${total.toFixed(2)})${currentDiscount > 0 ? ` [Discount: Rs ${currentDiscount.toFixed(2)}]` : ''}`, 'sale', { 
            items: itemsForLog, 
            total,
            discount: currentDiscount
        });
        
        showReceipt(itemsForLog, total, currentDiscount, new Date().toLocaleTimeString());
        cart = []; 
        currentDiscount = 0;
        updateCartUI(); 
        renderItems(); 
        updateStats();
        showNotification('Sale completed successfully', 'success');
    }

    function toggleStockMode() {
        let mode = document.getElementById('stType').value;
        document.getElementById('newProductForm').style.display = mode === 'in' ? 'block' : 'none';
        document.getElementById('existingProductForm').style.display = mode === 'out' ? 'block' : 'none';
        if(mode === 'out') {
            document.getElementById('stSelect').innerHTML = db.map(i => 
                `<option value="${i.name}">${i.name} (${parseFloat(i.qty).toFixed(2)}kg)</option>`
            ).join('');
        }
        
        // Clear all fields when switching modes
        clearStockForm();
    }

    function clearStockForm() {
        document.getElementById('stName').value = "";
        document.getElementById('stCost').value = "";
        document.getElementById('stPrice').value = "";
        document.getElementById('stEmoji').value = "";
        document.getElementById('stQty').value = "";
    }

    function clearExpenseForm() {
        document.getElementById('expName').value = "";
        document.getElementById('expAmt').value = "";
    }

    function processStock() {
        let mode = document.getElementById('stType').value;
        let qty = parseFloat(document.getElementById('stQty').value);
        
        if(!qty || qty <= 0) {
            alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±");
            return;
        }

        if(mode === 'in') {
            let name = document.getElementById('stName').value.trim();
            let cost = parseFloat(document.getElementById('stCost').value);
            let price = parseFloat(document.getElementById('stPrice').value);
            let emoji = document.getElementById('stEmoji').value || 'üçé';
            
            if(!name) {
                alert("‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏‡∂∫‡∑ö ‡∂±‡∂∏ ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±");
                return;
            }
            
            let existing = db.find(i => i.name.toLowerCase() === name.toLowerCase());
            if(existing) { 
                existing.qty = (parseFloat(existing.qty) + qty).toFixed(3);
                addLog(`‡∂≠‡∑ú‡∂ú ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì: ${name} (+${qty}kg)`, 'stock');
                showNotification(`${name} stock increased by ${qty}kg`, 'success');
            } else {
                if(!cost || cost <= 0 || !price || price <= 0) {
                    alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂∏‡∑í‡∂Ω‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±");
                    return;
                }
                db.push({ 
                    name, 
                    cost: cost, 
                    price: price, 
                    qty, 
                    emoji: emoji,
                    category: document.getElementById('stCat').value
                }); 
                addLog(`‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏‡∂∫‡∂ö‡∑ä ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì: ${name}`, 'stock');
                showNotification(`New item added: ${name}`, 'success');
            }
        } else {
            let itemName = document.getElementById('stSelect').value;
            let item = db.find(i => i.name === itemName);
            
            if(!item) {
                alert("‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏‡∂∫ ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑ì‡∂∫");
                return;
            }
            
            if(qty > parseFloat(item.qty)) {
                alert(`‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∑Ä‡∂≠‡∑ä ‡∂≠‡∑ú‡∂ú ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠! ‡∂á‡∂≠‡∑í ‡∂≠‡∑ú‡∂ú: ${item.qty}kg`);
                return;
            }
            
            item.qty = (parseFloat(item.qty) - qty).toFixed(3);
            wastage.push({ 
                name: item.name, 
                loss: qty * item.cost, 
                quantity: qty,
                date: new Date().toLocaleDateString(), 
                month: new Date().getMonth(),
                syncId: syncId
            });
            addLog(`‡∂Ö‡∂¥‡∂≠‡∑ö ‡∂∫‡∑è‡∂∏‡∑ä ‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì: ${item.name} (-${qty}kg)`, 'waste');
            showNotification(`${item.name} stock reduced by ${qty}kg`, 'warning');
        }
        
        // Clear form after successful operation
        clearStockForm();
        save(); 
        renderItems(); 
        updateStats();
        
        // Refresh the dropdown for waste mode
        if(mode === 'out') {
            document.getElementById('stSelect').innerHTML = db.map(i => 
                `<option value="${i.name}">${i.name} (${parseFloat(i.qty).toFixed(2)}kg)</option>`
            ).join('');
        }
    }

    function addExpense() {
        let n = document.getElementById('expName').value.trim();
        let a = parseFloat(document.getElementById('expAmt').value);
        
        if(!n) {
            alert("‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ö ‡∑Ñ‡∑ö‡∂≠‡∑î‡∑Ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±");
            return;
        }
        
        if(!a || a <= 0) {
            alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂∏‡∑î‡∂Ø‡∂Ω‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±");
            return;
        }
        
        expenses.push({ 
            name: n, 
            amt: a, 
            date: new Date().toLocaleDateString(), 
            month: new Date().getMonth(),
            syncId: syncId
        });
        addLog(`‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì: ${n} (Rs ${a})`, 'expense');
        showNotification(`Expense added: ${n} - Rs ${a.toFixed(2)}`, 'warning');
        
        clearExpenseForm();
        save(); 
        updateStats();
    }

    function updateStats() {
        let today = new Date().toLocaleDateString();
        let curMonth = new Date().getMonth();
        let daySales = sales.filter(s => s.date === today);
        let dayRev = daySales.reduce((a, b) => a + b.total, 0);
        let dayGrossProf = daySales.reduce((a, b) => a + b.profit, 0);
        let dayLoss = wastage.filter(w => w.date === today).reduce((a, b) => a + b.loss, 0) + expenses.filter(e => e.date === today).reduce((a, b) => a + b.amt, 0);
        let monthProf = sales.filter(s => s.month === curMonth).reduce((a, b) => a + b.profit, 0) - wastage.filter(w => w.month === curMonth).reduce((a, b) => a + b.loss, 0) - expenses.filter(e => e.month === curMonth).reduce((a, b) => a + b.amt, 0);

        document.getElementById('statRev').innerText = `Rs ${dayRev.toFixed(2)}`;
        document.getElementById('statProf').innerText = `Rs ${(dayGrossProf - dayLoss).toFixed(2)}`;
        document.getElementById('rDayRev').innerText = dayRev.toFixed(2);
        document.getElementById('rDayProf').innerText = (dayGrossProf - dayLoss).toFixed(2);
        document.getElementById('rDayLoss').innerText = dayLoss.toFixed(2);
        document.getElementById('rMonthProf').innerText = monthProf.toFixed(2);
        document.getElementById('summaryText').innerHTML = `‡∂Ω‡∑è‡∂∑‡∂∫: Rs ${dayGrossProf.toFixed(2)} | ‡∂¥‡∑è‡∂©‡∑î: Rs ${dayLoss.toFixed(2)}<br><b>‡∑Å‡∑î‡∂Ø‡∑ä‡∂∞ ‡∂Ω‡∑è‡∂∑‡∂∫: Rs ${(dayGrossProf - dayLoss).toFixed(2)}</b>`;
        
        const targets = document.querySelectorAll('.privacy-target');
        const reportWrapper = document.getElementById('reportPrivacyWrapper');
        if(isLocked) { 
            targets.forEach(e => e.classList.add('privacy-blur')); 
            reportWrapper.classList.add('privacy-blur'); 
        } else { 
            targets.forEach(e => e.classList.remove('privacy-blur')); 
            reportWrapper.classList.remove('privacy-blur'); 
        }
    }

    function switchTab(t) {
        ['view-pos', 'view-stock', 'view-reports'].forEach(v => document.getElementById(v).style.display = 'none');
        document.getElementById('view-' + t).style.display = t === 'pos' ? 'contents' : 'block';
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        document.getElementById('tab-' + t).classList.add('active');
        
        if(t === 'stock') {
            renderLogs();
            // Initialize the dropdown for waste mode
            document.getElementById('stSelect').innerHTML = db.map(i => 
                `<option value="${i.name}">${i.name} (${parseFloat(i.qty).toFixed(2)}kg)</option>`
            ).join('');
        }
    }

    // Initialize on load
    window.onload = () => { 
        renderItems(); 
        updateStats(); 
        renderLogs();
        updateCartUI();
        
        // Show welcome message
        setTimeout(() => {
            showNotification('Jayaneth Pro Mart POS Ready');
        }, 1000);
    };
</script>
</body>
</html>
