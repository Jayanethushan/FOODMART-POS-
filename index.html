<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JAYANETH PRO | ADVANCED GLASS POS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
    <!-- QR/Barcode Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <style>
        :root {
            --bg-dark: #050608;
            --glass-bg: rgba(15, 18, 22, 0.85);
            --glass-border: rgba(255, 255, 255, 0.12);
            --neon-green: #8aff67;
            --neon-blue: #00f2ff;
            --danger: #ff4747;
            --orange: #ff9f43;
            --text-main: #ffffff;
            --text-dim: #94a3b8;
        }

        * { 
            box-sizing: border-box; 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            margin: 0; 
            height: 100vh; 
            background: radial-gradient(circle at 70% 20%, #0d1a0d, #050608); 
            color: var(--text-main); 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: relative;
            touch-action: pan-x pan-y;
        }

        body::before {
            content: "";
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 100 100'%3E%3Cg fill='none' stroke='%23ffffff' stroke-width='0.6' stroke-opacity='0.12'%3E%3Cpath d='M20 20c5-10 15-10 20 0s-5 15-10 15-15-5-10-15z'/%3E%3Cpath d='M70 30c0-10 10-15 15-5s-5 15-10 15-5-5-5-10z'/%3E%3Cpath d='M40 70c0-10 15-10 15 0s-5 15-10 15-5-5-5-10z'/%3E%3Ccircle cx='15' cy='75' r='8'/%3E%3Cpath d='M80 80l5-10h-10z'/%3E%3Cpath d='M10 10l5 5-5 5z'/%3E%3Cpath d='M50 10c5 5 5 15 0 20s-15 5-20 0 5-15 10-20 10 0 10 0z'/%3E%3C/g%3E%3C/svg%3E");
            background-repeat: repeat; filter: blur(0.5px); z-index: -1;
        }

        .glass { 
            background: var(--glass-bg); 
            backdrop-filter: blur(25px); 
            border: 1px solid var(--glass-border); 
            border-radius: 18px; 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); 
        }
        .privacy-blur { filter: blur(25px); pointer-events: none; transition: 0.5s; opacity: 0.3; }

        /* Responsive Header */
        header { 
            padding: 12px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: rgba(0,0,0,0.6); 
            border-bottom: 1px solid var(--glass-border); 
            z-index: 10;
            min-height: 60px;
        }
        .logo h1 { margin: 0; font-size: 18px; font-weight: 800; white-space: nowrap; }
        .logo span { color: var(--neon-green); }

        .dashboard-stats { 
            display: flex; 
            gap: 8px; 
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .mini-stat { 
            padding: 6px 10px; 
            text-align: right; 
            min-width: 100px; 
        }
        .stat-label { font-size: 9px; color: var(--text-dim); text-transform: uppercase; font-weight: 800; }
        .stat-val { display: block; font-family: 'JetBrains Mono'; font-size: 13px; }

        /* Responsive Navigation */
        nav { 
            display: flex; 
            gap: 5px; 
            padding: 8px 15px; 
            background: rgba(0,0,0,0.3); 
            z-index: 10; 
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        .nav-link { 
            background: var(--glass-bg); 
            border: 1px solid var(--glass-border); 
            color: white; 
            padding: 8px 15px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 12px; 
            font-weight: 600; 
            min-width: fit-content;
        }
        .nav-link.active { background: var(--neon-green); color: black; border-color: var(--neon-green); }

        /* Main Content Area - Responsive */
        main { 
            flex: 1; 
            display: flex; 
            padding: 15px; 
            gap: 15px; 
            overflow: hidden; 
            flex-direction: column;
        }
        
        @media (min-width: 768px) {
            main {
                flex-direction: row;
            }
        }
        
        .left-col { 
            flex: 1.8; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            min-height: 300px;
        }
        .right-col { 
            flex: 1.2; 
            display: flex; 
            flex-direction: column; 
            min-height: 400px;
        }

        /* POS ‡∂ö‡∑è‡∂´‡∑ä‡∂© ‡∂ö‡∑ú‡∂ß‡∑î‡∑Ä - ‡∑Ä‡∑ô‡∂±‡∑ä ‡∂ö‡∑Ö ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä */
        .pos-category-box {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            overflow-x: auto;
        }
        .pos-cat-btn {
            padding: 8px 15px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            min-width: fit-content;
        }
        .pos-cat-btn.active {
            background: var(--neon-green);
            color: black;
            border-color: var(--neon-green);
        }
        .pos-cat-btn.new-item {
            border: 1px dashed var(--neon-green);
            color: var(--neon-green);
        }

        /* Search and Controls */
        .search-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }
        .search-bar, select { 
            width: 100%; 
            padding: 12px 15px; 
            border-radius: 10px; 
            border: 1px solid var(--glass-border); 
            background: rgba(0,0,0,0.4); 
            color: white; 
            margin-bottom: 0;
            font-size: 14px;
        }
        
        /* Responsive Item Grid */
        .item-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
            gap: 8px; 
            overflow-y: auto;
            padding: 5px;
        }
        
        @media (min-width: 1024px) {
            .item-grid {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
                gap: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .item-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 6px;
            }
        }
        
        .item-card { 
            padding: 12px 8px; 
            text-align: center; 
            cursor: pointer; 
            transition: 0.3s; 
            position: relative;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .item-card:hover, .item-card:active { 
            border-color: var(--neon-green); 
            background: rgba(138, 255, 103, 0.05); 
        }
        
        .stock-badge { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            font-size: 9px; 
            background: rgba(255,255,255,0.1); 
            padding: 2px 6px; 
            border-radius: 4px; 
        }
        
        /* Cart Area */
        .cart-table { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px; 
            min-height: 200px;
        }
        .cart-row { 
            display: grid; 
            grid-template-columns: 2fr 1fr 1fr 1fr auto; 
            gap: 5px; 
            padding: 8px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            font-size: 12px; 
            align-items: center;
        }
        
        @media (max-width: 480px) {
            .cart-row {
                grid-template-columns: 2fr 1fr 1fr auto;
                font-size: 11px;
            }
            .cart-row span:nth-child(3) {
                display: none;
            }
        }

        .grand-total { font-family: 'JetBrains Mono'; font-size: 24px; color: var(--neon-green); font-weight: 800; }
        .btn-action { 
            width: 100%; 
            padding: 15px; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 800; 
            margin-top: 10px; 
            transition: all 0.3s;
            touch-action: manipulation;
        }
        .btn-action:active {
            transform: scale(0.98);
        }
        .btn-pay { background: var(--neon-green); color: black; }

        /* Responsive History */
        .history-list { 
            margin-top: 20px; 
            max-height: 300px; 
            overflow-y: auto; 
            font-size: 13px; 
        }
        .history-item { 
            padding: 10px; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap;
        }
        .btn-view { 
            background: #333; 
            color: white; 
            border: none; 
            padding: 4px 8px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 11px; 
        }

        /* Responsive Modals */
        .modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.92); 
            z-index: 2000; 
            align-items: center; 
            justify-content: center; 
            padding: 15px; 
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }
        
        .receipt-box { 
            background: white; 
            color: black; 
            padding: 20px; 
            width: 100%; 
            max-width: 320px; 
            border-radius: 8px; 
            font-family: 'JetBrains Mono'; 
            font-size: 12px; 
        }
        
        /* Glass Popups - Responsive */
        .glass-popup { 
            background: var(--glass-bg); 
            border: 1px solid var(--glass-border); 
            padding: 25px; 
            border-radius: 20px; 
            width: 100%; 
            max-width: 380px; 
            text-align: center; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        @media (max-width: 480px) {
            .glass-popup {
                padding: 20px;
                border-radius: 15px;
            }
        }
        
        .popup-title { font-size: 18px; font-weight: 800; margin-bottom: 10px; color: var(--neon-blue); }
        .popup-sub { font-size: 12px; color: var(--text-dim); margin-bottom: 20px; }
        .popup-input { 
            width: 100%; 
            padding: 15px; 
            border-radius: 12px; 
            border: 1px solid var(--glass-border); 
            background: rgba(255,255,255,0.05); 
            color: white; 
            font-size: 20px; 
            text-align: center; 
            font-family: 'JetBrains Mono'; 
            margin-bottom: 20px; 
            outline: none;
            font-size: 18px;
        }
        .popup-btn-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
        }
        .btn-cancel { background: rgba(255,255,255,0.1); color: white; }

        /* Discount Row */
        .discount-row { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin: 10px 0; 
            padding: 10px; 
            background: rgba(0,0,0,0.2); 
            border-radius: 10px; 
            flex-wrap: wrap;
        }
        .discount-label { font-size: 12px; color: var(--text-dim); }
        .discount-input { 
            width: 80px; 
            padding: 8px; 
            border-radius: 8px; 
            border: 1px solid var(--glass-border); 
            background: rgba(255,255,255,0.05); 
            color: white; 
            text-align: center; 
            font-size: 14px;
        }
        .apply-discount-btn, .remove-discount-btn { 
            padding: 8px 15px; 
            border-radius: 8px; 
            background: var(--orange); 
            color: black; 
            border: none; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 12px;
            touch-action: manipulation;
        }
        .remove-discount-btn { background: var(--danger); color: white; }

        /* Notification */
        .notification { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--neon-green); 
            color: black; 
            padding: 12px 20px; 
            border-radius: 10px; 
            font-weight: 600; 
            z-index: 3000; 
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 300px;
            word-wrap: break-word;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* Scanner Modal */
        .scanner-modal { 
            background: var(--glass-bg); 
            border: 1px solid var(--glass-border); 
            padding: 20px; 
            border-radius: 20px; 
            width: 100%; 
            max-width: 500px; 
            text-align: center; 
        }
        #scanner-container { 
            width: 100%; 
            height: 300px; 
            margin: 20px 0; 
            background: rgba(0,0,0,0.3); 
            border-radius: 10px; 
            overflow: hidden; 
            position: relative; 
        }
        #scanner-placeholder { 
            width: 100%; 
            height: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-direction: column; 
        }
        .scanner-icon { font-size: 50px; margin-bottom: 10px; color: var(--neon-blue); }
        .scanner-btn { 
            background: var(--neon-blue); 
            color: black; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: 600; 
            margin: 10px 5px; 
            font-size: 14px;
            touch-action: manipulation;
        }

        /* Lock/Unlock Button */
        #lockBtn { 
            display: flex; 
            align-items: center; 
            gap: 5px; 
            white-space: nowrap;
            padding: 8px 15px;
        }

        /* Game Styles - Responsive */
        .game-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            overflow: hidden;
        }
        
        .game-canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 300px;
        }
        
        #gameCanvas {
            width: 100%;
            height: 100%;
            background: rgba(5, 10, 15, 0.8);
            display: block;
        }
        
        .game-controls {
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .game-stats {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .game-stat {
            background: rgba(255,255,255,0.05);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 11px;
            min-width: 70px;
        }
        
        @media (max-width: 480px) {
            .game-stat {
                min-width: 60px;
                padding: 5px 8px;
                font-size: 10px;
            }
        }
        
        .game-stat-value {
            font-family: 'JetBrains Mono';
            font-size: 14px;
            color: var(--neon-green);
            display: block;
        }
        
        .game-buttons {
            display: flex;
            gap: 8px;
        }
        
        .game-btn {
            background: var(--neon-blue);
            color: black;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 11px;
            transition: 0.3s;
            touch-action: manipulation;
        }
        
        @media (max-width: 480px) {
            .game-btn {
                padding: 5px 10px;
                font-size: 10px;
            }
        }
        
        .game-btn:active {
            transform: scale(0.95);
        }
        
        /* Mobile-Specific Improvements */
        @media (max-width: 768px) {
            .logo h1 {
                font-size: 16px;
            }
            
            .mini-stat {
                min-width: 80px;
                padding: 5px 8px;
            }
            
            .stat-val {
                font-size: 11px;
            }
            
            .nav-link {
                padding: 6px 12px;
                font-size: 11px;
            }
            
            main {
                padding: 10px;
                gap: 10px;
            }
            
            .btn-action {
                padding: 12px;
                font-size: 13px;
            }
            
            .grand-total {
                font-size: 20px;
            }
            
            /* Hide some elements on very small screens */
            @media (max-width: 360px) {
                .logo h1 {
                    font-size: 14px;
                }
                
                .dashboard-stats {
                    display: none;
                }
            }
        }
        
        /* Tablet Optimizations */
        @media (min-width: 769px) and (max-width: 1024px) {
            .item-grid {
                grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            }
            
            .game-stat {
                min-width: 85px;
            }
        }
        
        /* Large Desktop Optimizations */
        @media (min-width: 1440px) {
            .item-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .mini-stat {
                min-width: 140px;
            }
        }
        
        /* Portrait Mode Adjustments */
        @media (orientation: portrait) and (max-height: 700px) {
            main {
                flex-direction: column;
                height: calc(100vh - 120px);
            }
            
            .left-col, .right-col {
                flex: none;
            }
            
            .left-col {
                height: 40%;
            }
            
            .right-col {
                height: 60%;
            }
        }
        
        /* Landscape Mode Adjustments */
        @media (orientation: landscape) and (max-height: 500px) {
            header, nav {
                flex-shrink: 0;
            }
            
            main {
                height: calc(100vh - 100px);
            }
            
            .item-grid {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            }
        }
        
        /* Prevent text size adjustment on mobile */
        html {
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }
        
        /* Improve tap targets on mobile */
        button, 
        .item-card, 
        .nav-link,
        .game-btn {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Smooth scrolling for iOS */
        .item-grid,
        .cart-table,
        .history-list {
            -webkit-overflow-scrolling: touch;
        }
        
        /* POS Complete Sale Button Fix */
        .complete-sale-btn {
            display: flex !important;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        
        /* Contact Info Modal */
        .contact-input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.05);
            color: white;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            main { flex-direction: column; overflow-y: auto; }
            .left-col, .right-col { flex: none; width: 100%; }
            .item-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
        }

        @media (max-width: 600px) {
            header { flex-direction: column; gap: 10px; padding: 10px; }
            nav { overflow-x: auto; white-space: nowrap; padding: 10px; }
            .dashboard-stats { width: 100%; justify-content: space-between; }
            .mini-stat { min-width: 80px; padding: 5px; }
            .item-card { padding: 10px 5px; }
            .logo h1 { font-size: 18px; }
            .pos-category-box { padding: 8px; }
            .pos-cat-btn { padding: 6px 12px; font-size: 11px; }
        }
        
        /* Custom Scrollbar for Glass Theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        
        /* Stock Table Styles */
        .stock-table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            margin-top: 15px;
            position: relative;
        }
        
        .stock-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            min-width: 800px;
        }
        
        .stock-table th {
            background: rgba(0,0,0,0.4);
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-dim);
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(10px);
        }
        
        .stock-table td {
            padding: 14px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            vertical-align: middle;
            height: 60px;
        }
        
        .stock-table tr:hover {
            background: rgba(255,255,255,0.03);
        }
        
        .stock-actions {
            display: flex;
            gap: 6px;
        }
        
        .action-btn {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            border: none;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .edit-btn-stock {
            background: rgba(0, 242, 255, 0.15);
            color: var(--neon-blue);
            border: 1px solid rgba(0, 242, 255, 0.3);
        }
        
        .delete-btn-stock {
            background: rgba(255, 71, 71, 0.15);
            color: var(--danger);
            border: 1px solid rgba(255, 71, 71, 0.3);
        }
        
        .restock-btn-stock {
            background: rgba(138, 255, 103, 0.15);
            color: var(--neon-green);
            border: 1px solid rgba(138, 255, 103, 0.3);
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .stock-qty {
            font-family: 'JetBrains Mono';
            font-weight: 600;
            font-size: 13px;
        }
        
        .out-of-stock {
            color: var(--danger);
        }
        
        .low-stock {
            color: var(--orange);
        }
        
        .in-stock {
            color: var(--neon-green);
        }
        
        .emoji-cell {
            font-size: 24px;
            text-align: center;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-right: 10px;
        }
        
        /* Stock Table Row Layout */
        .stock-item-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .stock-item-info {
            display: flex;
            flex-direction: column;
        }
        
        .stock-item-name {
            font-weight: 600;
            font-size: 13px;
        }
        
        .stock-item-barcode {
            font-size: 10px;
            color: var(--text-dim);
            font-family: 'JetBrains Mono';
        }
        
        /* Stock Category Badge */
        .stock-category-badge {
            padding: 4px 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            font-size: 11px;
            border: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>

<header>
    <div class="logo"><h1>JAYANETH <span>PRO MART</span></h1></div>
    <div class="dashboard-stats">
        <div class="mini-stat glass"><span class="stat-label">Daily Revenue</span><span id="statRev" class="stat-val privacy-target">Rs 0.00</span></div>
        <div class="mini-stat glass"><span class="stat-label">Daily Profit</span><span id="statProf" class="stat-val privacy-target" style="color: var(--neon-green);">Rs 0.00</span></div>
        <button class="nav-link" id="lockBtn" onclick="handleLock()">üîí LOCK</button>
    </div>
</header>

<nav>
    <button class="nav-link active" id="tab-pos" onclick="switchTab('pos')">POS</button>
    <button class="nav-link" id="tab-stock" onclick="switchTab('stock')">STOCK CONTROL</button>
    <button class="nav-link" id="tab-reports" onclick="switchTab('reports')">P&L REPORTS</button>
    <button class="nav-link" id="tab-game" onclick="switchTab('game')">üéÆ FRUIT CATCH</button>
</nav>

<!-- POS View -->
<div id="view-pos" style="display: contents;">
    <main>
        <div class="left-col">
            <div class="search-controls">
                <input type="text" id="pSearch" class="search-bar" placeholder="üîç Search items..." oninput="renderItems()" style="flex: 1;">
                <button class="nav-link" onclick="showScanner('pos')" style="min-width: 44px; padding: 12px; display: flex; align-items: center; justify-content: center;">üì∑</button>
            </div>
            
            <!-- Category Filter Buttons for POS -->
            <div class="pos-category-box">
                <button class="pos-cat-btn active" onclick="filterPosCategory('all')">All Items</button>
                <button class="pos-cat-btn" onclick="filterPosCategory('Fruit')">üçé Fruits</button>
                <button class="pos-cat-btn" onclick="filterPosCategory('Vegetable')">ü•¶ Vegetables</button>
                <button class="pos-cat-btn" onclick="filterPosCategory('Other')">üì¶ Other</button>
                <button class="pos-cat-btn new-item" onclick="switchTab('stock')">+ Add New Item</button>
            </div>
            
            <div class="item-grid" id="itemGrid"></div>
        </div>
        
        <div class="right-col glass">
            <div style="padding: 15px; border-bottom: 1px solid var(--glass-border); font-weight: 800; display: flex; justify-content: space-between; align-items: center;">
                <span>BILLING</span>
                <button class="nav-link" onclick="showScanner('bill')" style="padding: 5px 10px; font-size: 11px;">üì∑ Scan Item</button>
            </div>
            <div class="cart-table" id="cartList"></div>
            
            <div style="padding: 10px 15px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--glass-border);">
                <div class="discount-row">
                    <span class="discount-label">Discount:</span>
                    <input type="number" id="discountInput" class="discount-input" placeholder="Rs" min="0">
                    <button class="apply-discount-btn" onclick="applyDiscount()">Apply</button>
                    <button class="remove-discount-btn" onclick="removeDiscount()" style="display:none;" id="removeDiscountBtn">Remove</button>
                </div>
                <div style="font-size: 11px; color: var(--text-dim); margin-top: 5px;">Enter amount in Rupees to deduct from total</div>
            </div>
            
            <div style="padding: 20px; background: rgba(0,0,0,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <span style="font-size: 12px; color: var(--text-dim);">SUBTOTAL</span>
                    <span id="subTotal" style="font-family: 'JetBrains Mono';">0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;" id="discountDisplay">
                    <span style="font-size: 12px; color: var(--danger);">DISCOUNT</span>
                    <span id="discountAmount" style="font-family: 'JetBrains Mono'; color: var(--danger);">0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 12px; color: var(--text-dim);">TOTAL</span>
                    <span id="grandTotal" class="grand-total">0.00</span>
                </div>
                <button class="btn-action btn-pay complete-sale-btn" onclick="completeSale()">‚úÖ COMPLETE SALE</button>
            </div>
        </div>
    </main>
</div>

<!-- Stock Control View - UPDATED -->
<div id="view-stock" style="display: none; padding: 20px; overflow-y: auto;">
    <div style="max-width: 1400px; margin: auto; width: 100%;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="glass" style="padding: 20px;">
                <div style="font-weight: 800; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <span>STOCK UPDATE</span>
                    <button class="nav-link" onclick="showScanner('stock')" style="padding: 5px 10px; font-size: 11px;">üì∑ Scan Code</button>
                </div>
                <select id="stType" onchange="toggleStockMode()">
                    <option value="in">ADD NEW / REFILL (‡∑É‡∑ä‡∂ß‡∑ú‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏)</option>
                    <option value="out">WASTAGE / DAMAGE (‡∂ö‡∑î‡∂´‡∑î ‡∑Ä‡∑ñ/‡∂¥‡∑è‡∂©‡∑î ‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏)</option>
                </select>
                <div id="newProductForm">
                    <div style="margin-bottom: 10px;">
                        <select id="stSelectName" class="search-bar" onchange="handleItemSelect()">
                            <option value="">-- Select existing item or add new --</option>
                        </select>
                    </div>
                    <input type="text" id="stName" placeholder="Item Name (if new)" class="search-bar">
                    <select id="stCat" class="search-bar">
                        <option value="Fruit">Fruit</option>
                        <option value="Vegetable">Vegetable</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="number" id="stCost" placeholder="Cost Price (1kg)" class="search-bar">
                    <input type="number" id="stPrice" placeholder="Selling Price (1kg)" class="search-bar">
                    <input type="text" id="stEmoji" placeholder="Emoji (üçé)" class="search-bar">
                    <input type="text" id="stBarcode" placeholder="Barcode/QR Code (optional)" class="search-bar">
                </div>
                <div id="existingProductForm" style="display:none;">
                    <select id="stSelect" class="search-bar"></select>
                </div>
                <input type="number" id="stQty" placeholder="Weight (kg)" class="search-bar">
                <button class="btn-action btn-pay" onclick="processStock()">UPDATE INVENTORY</button>
            </div>
            
            <div class="glass" style="padding: 20px;">
                <div style="font-weight: 800; margin-bottom: 20px;">OTHER EXPENSES</div>
                <input type="text" id="expName" placeholder="Reason" class="search-bar">
                <input type="number" id="expAmt" placeholder="Amount (Rs)" class="search-bar">
                <button class="btn-action" style="background:var(--orange); color:black;" onclick="addExpense()">ADD EXPENSE</button>
            </div>
        </div>

        <!-- Stock Items Table with CRUD Operations -->
        <div class="glass" style="padding: 20px; margin-bottom: 20px;">
            <div style="font-weight: 800; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                <span>ALL STOCK ITEMS</span>
                <div style="display: flex; gap: 10px;">
                    <button class="nav-link" onclick="refreshStockTable()" style="padding: 5px 10px; font-size: 11px;">üîÑ Refresh</button>
                    <button class="nav-link" onclick="exportStockData()" style="padding: 5px 10px; font-size: 11px;">üìä Export</button>
                </div>
            </div>
            
            <div class="stock-table-container">
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th style="min-width: 200px;">Item</th>
                            <th style="min-width: 100px;">Category</th>
                            <th style="min-width: 100px;">Stock (kg)</th>
                            <th style="min-width: 100px;">Cost Price</th>
                            <th style="min-width: 100px;">Selling Price</th>
                            <th style="min-width: 120px;">Barcode</th>
                            <th style="min-width: 100px;">Value</th>
                            <th style="min-width: 200px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody">
                        <!-- Stock items will be loaded here -->
                    </tbody>
                </table>
            </div>
            <div id="stockTableEmpty" style="text-align: center; padding: 40px; color: var(--text-dim); display: none;">
                No stock items found. Add items using the form above.
            </div>
        </div>

        <div class="glass" style="padding: 20px;">
            <div style="font-weight: 800; border-bottom: 1px solid #333; padding-bottom: 10px;">RECENT ACTIVITY</div>
            <div class="history-list" id="historyLog"></div>
        </div>
    </div>
</div>

<!-- Reports View -->
<div id="view-reports" style="display: none; padding: 20px; overflow-y: auto;">
    <div id="reportPrivacyWrapper" class="privacy-blur">
        <div class="rep-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div class="glass" style="padding:20px; text-align:center;"><span class="stat-label">Daily Revenue</span><h2 id="rDayRev">0.00</h2></div>
            <div class="glass" style="padding:20px; text-align:center;"><span class="stat-label">Daily Profit (Net)</span><h2 id="rDayProf" style="color:var(--neon-green)">0.00</h2></div>
            <div class="glass" style="padding:20px; text-align:center;"><span class="stat-label">Daily Loss</span><h2 id="rDayLoss" style="color:var(--danger)">0.00</h2></div>
            <div class="glass" style="padding:20px; text-align:center;"><span class="stat-label">Monthly Net Profit</span><h2 id="rMonthProf" style="color:var(--neon-blue)">0.00</h2></div>
        </div>
        <div class="glass" style="padding: 20px;">
            <h3>Today's Summary</h3>
            <div id="summaryText"></div>
        </div>
    </div>
</div>

<!-- Game View -->
<div id="view-game" style="display: none; padding: 15px; overflow: hidden;">
    <div class="game-container glass">
        <div class="game-canvas-container">
            <canvas id="gameCanvas"></canvas>
            <div id="gameOverScreen" class="game-over-screen" style="display: none;">
                <div class="game-over-title">GAME OVER!</div>
                <div class="game-over-score">Score: <span id="finalScore">0</span></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="game-btn" onclick="restartGame()">PLAY AGAIN</button>
                    <button class="game-btn game-btn-danger" onclick="switchTab('pos')">BACK TO POS</button>
                </div>
            </div>
        </div>
        
        <div class="game-controls">
            <div class="game-stats">
                <div class="game-stat">
                    <div style="font-size: 10px; color: var(--text-dim);">SCORE</div>
                    <div id="gameScore" class="game-stat-value">0</div>
                </div>
                <div class="game-stat">
                    <div style="font-size: 10px; color: var(--text-dim);">LIVES</div>
                    <div id="gameLives" class="game-stat-value">3</div>
                </div>
                <div class="game-stat">
                    <div style="font-size: 10px; color: var(--text-dim);">TIME</div>
                    <div id="gameTime" class="game-stat-value">60</div>
                </div>
                <div class="game-stat">
                    <div style="font-size: 10px; color: var(--text-dim);">PLAYER</div>
                    <div id="playerName" class="game-stat-value">Guest</div>
                </div>
            </div>
            
            <div class="game-buttons">
                <button class="game-btn" onclick="startGame()">START</button>
                <button class="game-btn" onclick="pauseGame()">PAUSE</button>
                <button class="game-btn game-btn-danger" onclick="switchTab('pos')">EXIT</button>
            </div>
        </div>
    </div>
</div>

<!-- All Modals -->
<div class="modal" id="pinModal">
    <div class="glass-popup">
        <div class="popup-title">ENTER PIN</div>
        <div class="popup-sub">Please enter the security PIN to unlock reports</div>
        <input type="password" id="pinInput" class="popup-input" placeholder="****" maxlength="4" onkeydown="if(event.key === 'Enter') confirmPin()">
        <div class="popup-btn-grid">
            <button class="btn-action btn-cancel" onclick="closeModal('pinModal')">CANCEL</button>
            <button class="btn-action btn-pay" onclick="confirmPin()">UNLOCK</button>
        </div>
    </div>
</div>

<div class="modal" id="weightModal">
    <div class="glass-popup">
        <div class="popup-title" id="weightTitle">ENTER WEIGHT</div>
        <div class="popup-sub" id="weightSub">Enter weight in kilograms</div>
        <input type="number" id="weightInput" class="popup-input" placeholder="0.000" step="0.001" onkeydown="if(event.key === 'Enter') confirmWeight()">
        <div class="popup-btn-grid">
            <button class="btn-action btn-cancel" onclick="closeWeightModal()">CANCEL</button>
            <button class="btn-action btn-pay" onclick="confirmWeight()">ADD TO CART</button>
        </div>
    </div>
</div>

<div class="modal" id="modal">
    <div class="receipt-box" id="billArea"></div>
    <div style="text-align: center; width: 100%;">
        <button class="btn-action btn-pay" style="width: 200px; margin-top: 15px;" onclick="closeModal('modal')">OK</button>
    </div>
</div>

<div class="modal" id="pinErrorModal">
    <div class="glass-popup" style="border-color: var(--danger);">
        <div style="font-size: 40px; margin-bottom: 15px; color: var(--danger);">‚ö†Ô∏è</div>
        <div class="popup-title" style="color: var(--danger);">‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í PIN ‡∂Ö‡∂Ç‡∂ö‡∂∫‡∂ö‡∑í!</div>
        <div class="popup-sub">‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í PIN ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.</div>
        <button class="btn-action" style="background: var(--danger); color: white; margin-top: 20px;" onclick="closeModal('pinErrorModal')">OK</button>
    </div>
</div>

<div class="modal" id="scannerModal">
    <div class="glass-popup">
        <div class="popup-title">SCAN QR/BARCODE</div>
        <div class="popup-sub">Point your camera at the QR code or barcode</div>
        <div id="scanner-container">
            <div id="scanner-placeholder">
                <div class="scanner-icon">üì∑</div>
                <div>Camera scanner will appear here</div>
            </div>
        </div>
        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
            <button class="scanner-btn" onclick="startScanner()">Start Scanner</button>
            <button class="btn-cancel" onclick="stopScanner()">Stop Scanner</button>
            <button class="btn-cancel" onclick="closeModal('scannerModal')">Close</button>
        </div>
        <div id="scanner-result" style="margin-top: 20px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 10px; display: none;">
            <div id="scanned-text"></div>
        </div>
    </div>
</div>

<!-- Stock Item Edit Modal -->
<div class="modal" id="stockEditModal">
    <div class="glass-popup">
        <div class="popup-title" id="stockEditTitle">Edit Stock Item</div>
        <div class="popup-sub" id="stockEditSub">Update item details</div>
        
        <div style="text-align: left; margin: 20px 0;">
            <div style="margin-bottom: 15px;">
                <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 5px;">Item Name:</div>
                <input type="text" id="stockEditName" class="popup-input" style="text-align: left; font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 5px;">Category:</div>
                <select id="stockEditCategory" class="popup-input" style="text-align: left; font-size: 14px;">
                    <option value="Fruit">Fruit</option>
                    <option value="Vegetable">Vegetable</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 5px;">Cost Price (Rs):</div>
                    <input type="number" id="stockEditCost" class="popup-input" step="0.01" style="font-size: 14px;">
                </div>
                <div>
                    <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 5px;">Selling Price (Rs):</div>
                    <input type="number" id="stockEditPrice" class="popup-input" step="0.01" style="font-size: 14px;">
                </div>
            </div>
            
            <div style="margin-bottom: 15px;">
                <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 5px;">Current Stock (kg):</div>
                <input type="number" id="stockEditQty" class="popup-input" step="0.001" style="font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 5px;">Barcode:</div>
                <input type="text" id="stockEditBarcode" class="popup-input" style="font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 15px; text-align: center;">
                <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 5px;">Emoji:</div>
                <div class="emoji-display" id="stockEmojiDisplay" onclick="toggleStockEmojiPicker()">üçé</div>
                <div id="stockEmojiPicker" style="display: none;">
                    <div style="display: flex; justify-content: center; gap: 10px; margin: 15px 0;">
                        <button class="cat-btn" onclick="switchStockEmojiCategory('fruits')">üçé Fruits</button>
                        <button class="cat-btn" onclick="switchStockEmojiCategory('vegetables')">ü•¶ Vegetables</button>
                        <button class="cat-btn" onclick="switchStockEmojiCategory('other')">üì¶ Other</button>
                    </div>
                    <div class="emoji-grid" id="stockEmojiGrid"></div>
                </div>
            </div>
        </div>
        
        <div class="popup-btn-grid">
            <button class="btn-action btn-cancel" onclick="closeStockEditModal()">CANCEL</button>
            <button class="btn-action btn-pay" onclick="saveStockItemEdit()">SAVE CHANGES</button>
        </div>
    </div>
</div>

<!-- Edit Pin Modal -->
<div class="modal" id="editPinModal">
    <div class="glass-popup">
        <div class="popup-title">EDIT LOCKED</div>
        <div class="popup-sub">Enter PIN 8514 to edit item</div>
        <input type="password" id="editPinInput" class="popup-input" placeholder="****" maxlength="4" onkeydown="if(event.key === 'Enter') verifyEditPin()">
        <div class="popup-btn-grid">
            <button class="btn-action btn-cancel" onclick="closeModal('editPinModal')">CANCEL</button>
            <button class="btn-action btn-pay" onclick="verifyEditPin()">UNLOCK EDIT</button>
        </div>
    </div>
</div>

<!-- Player Name Modal -->
<div class="modal" id="playerNameModal">
    <div class="glass-popup">
        <div class="popup-title">ENTER PLAYER NAME</div>
        <div class="popup-sub">Enter your name for the leaderboard</div>
        <input type="text" id="playerNameInput" class="popup-input" placeholder="Your Name" maxlength="15" onkeydown="if(event.key === 'Enter') savePlayerName()">
        <div class="popup-btn-grid">
            <button class="btn-action btn-cancel" onclick="closeModal('playerNameModal')">SKIP</button>
            <button class="btn-action btn-pay" onclick="savePlayerName()">SAVE</button>
        </div>
    </div>
</div>

<!-- Contact Information Modal -->
<div class="modal" id="contactModal">
    <div class="glass-popup">
        <div class="popup-title">CUSTOMER INFORMATION</div>
        <div class="popup-sub">Enter customer contact details (optional)</div>
        
        <input type="text" id="customerName" class="contact-input" placeholder="Customer Name">
        <input type="email" id="customerEmail" class="contact-input" placeholder="Email Address">
        <input type="tel" id="customerPhone" class="contact-input" placeholder="Phone Number">
        
        <div class="popup-btn-grid">
            <button class="btn-action btn-cancel" onclick="skipContactInfo()">SKIP</button>
            <button class="btn-action btn-pay" onclick="saveContactInfo()">SAVE & COMPLETE SALE</button>
        </div>
    </div>
</div>

<script>
    // -------------------------------------------------------------------------
    // FIREBASE ‡∑É‡∑ê‡∂ö‡∑É‡∑î‡∂∏‡∑ä
    // -------------------------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyAdw73seKGjO0VLFZuMj9gJaiSmnpc3N0M",
        authDomain: "pos-system-dc0e0.firebaseapp.com",
        databaseURL: "https://pos-system-dc0e0-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "pos-system-dc0e0",
        storageBucket: "pos-system-dc0e0.firebasestorage.app",
        messagingSenderId: "251115370846",
        appId: "1:251115370846:web:f7cfe5b3f38f71d67077cf",
        measurementId: "G-CGRK6HPBLX"
    };

    // Firebase ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Global variables
    let db = JSON.parse(localStorage.getItem('jmart_db')) || [];
    let sales = JSON.parse(localStorage.getItem('jmart_sales')) || [];
    let expenses = JSON.parse(localStorage.getItem('jmart_exp')) || [];
    let wastage = JSON.parse(localStorage.getItem('jmart_waste')) || [];
    let logs = JSON.parse(localStorage.getItem('jmart_logs')) || [];
    let cart = [];
    let currentDiscount = 0;
    let isLocked = true;
    let tempItem = null;
    let scanner = null;
    let currentScannerMode = 'pos';
    let itemToEdit = null;
    let selectedEmoji = 'üçé';
    let currentEmojiCategory = 'fruits';
    let soldOutItems = new Set();
    let currentPosCategory = 'all';
    
    // Contact info for current sale
    let currentCustomerInfo = null;
    
    // Game variables
    let game = {
        canvas: null,
        ctx: null,
        basket: { x: 300, y: 500, width: 100, height: 30 },
        fruits: [],
        bombs: [],
        score: 0,
        lives: 3,
        time: 60,
        isRunning: false,
        isPaused: false,
        lastTime: 0,
        playerName: localStorage.getItem('jmart_player_name') || 'Guest',
        keys: {},
        gameLoopId: null,
        leaderboard: []
    };
    
    // Emoji Packs
    const emojiPacks = {
        fruits: [
            'üçé', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'ü´ê', 'üçà',
            'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'üçÜ', 'ü´ë', 'üå∂Ô∏è'
        ],
        vegetables: [
            'ü•¶', 'ü•¨', 'ü•í', 'üåΩ', 'ü•ï', 'ü´õ', 'üßÖ', 'üßÑ', 'ü•î', 'üç†',
            'ü•ú', 'üå∞', 'ü´ö', 'ü´í', 'ü•ë', 'ü´ë', 'üå∂Ô∏è', 'ü´ò', 'üçÑ', 'ü•ó'
        ],
        other: [
            'ü•ê', 'üçû', 'ü•ñ', 'ü•®', 'üßÄ', 'ü•ö', 'üç≥', 'ü•ì', 'ü•©', 'üçó',
            'üçñ', 'ü¶¥', 'üå≠', 'üçî', 'üçü', 'üçï', 'ü•™', 'ü•ô', 'üßÜ', 'üåÆ'
        ]
    };

    // Device sync key for multi-device support
    const SYNC_KEY = 'jmart_sync_id';
    let syncId = localStorage.getItem(SYNC_KEY) || generateSyncId();
    localStorage.setItem(SYNC_KEY, syncId);

    // Generate unique device ID for sync
    function generateSyncId() {
        return 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // -------------------------------------------------------------------------
    // ‡∂Ø‡∑ä‡∑Ä‡∑í‡∂≠‡∑ä‡∑Ä ‡∑É‡∑î‡∂ª‡∑ê‡∂ö‡∑î‡∂∏‡∑ä ‡∂ö‡∑ä‡∂ª‡∂∏‡∂∫ (Local Storage + Firebase)
    // -------------------------------------------------------------------------
    function saveToBothStorage() {
        // 1. Local Storage ‡∑É‡∑ö‡∑Ä‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        localStorage.setItem('jmart_db', JSON.stringify(db));
        localStorage.setItem('jmart_sales', JSON.stringify(sales));
        localStorage.setItem('jmart_exp', JSON.stringify(expenses));
        localStorage.setItem('jmart_waste', JSON.stringify(wastage));
        localStorage.setItem('jmart_logs', JSON.stringify(logs));
        
        // 2. Firebase ‡∂ë‡∂ö‡∂ß ‡∑É‡∑ö‡∑Ä‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        const dataToSave = {
            db: db,
            sales: sales,
            expenses: expenses,
            wastage: wastage,
            logs: logs,
            last_update: new Date().toISOString(),
            last_source: syncId
        };
        
        try {
            database.ref('pos_data').set(dataToSave)
                .then(() => {
                    console.log('‚úÖ Data saved to Firebase successfully');
                })
                .catch(error => {
                    console.error('‚ùå Firebase save error:', error);
                    // If Firebase fails, continue with local storage only
                    showNotification('Data saved locally (No internet)', 'warning');
                });
        } catch (error) {
            console.error('‚ùå Firebase error:', error);
        }
    }

    // Cloud sync: Listen for changes from other devices
    database.ref('pos_data').on('value', (snapshot) => {
        const cloudData = snapshot.val();
        if (cloudData && cloudData.last_source !== syncId) {
            console.log('üîÑ Cloud data received, updating local storage');
            
            // Update local data
            db = cloudData.db || [];
            sales = cloudData.sales || [];
            expenses = cloudData.expenses || [];
            wastage = cloudData.wastage || [];
            logs = cloudData.logs || [];
            
            // Save to local storage
            localStorage.setItem('jmart_db', JSON.stringify(db));
            localStorage.setItem('jmart_sales', JSON.stringify(sales));
            localStorage.setItem('jmart_exp', JSON.stringify(expenses));
            localStorage.setItem('jmart_waste', JSON.stringify(wastage));
            localStorage.setItem('jmart_logs', JSON.stringify(logs));
            
            // Update UI
            renderItems();
            updateStats();
            renderLogs();
            updateItemSelectDropdown();
            
            showNotification('üîÑ Cloud data synchronized', 'success');
        }
    });

    // Game leaderboard sync
    database.ref('game_leaderboard').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            game.leaderboard = Object.values(data).sort((a, b) => b.score - a.score);
        }
    });

    // -------------------------------------------------------------------------
    // POS ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä‡∑ö ‡∂ö‡∑è‡∂´‡∑ä‡∂© ‡∂¥‡∑ô‡∂ª‡∑ì‡∂∏
    // -------------------------------------------------------------------------
    function filterPosCategory(category) {
        currentPosCategory = category;
        
        // Update active button
        document.querySelectorAll('.pos-cat-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        renderItems();
    }

    // -------------------------------------------------------------------------
    // POS ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä‡∑ö ‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏ ‡∂¥‡∑ô‡∂ª‡∑ì‡∂∏ (‡∂¥‡∑ê‡∂±‡∑ä‡∑É‡∂Ω ‡∂Ö‡∂∫‡∑í‡∂ö‡∂±‡∂∫ ‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∂ª‡∂¥‡∑î)
    // -------------------------------------------------------------------------
    function renderItems() {
        const grid = document.getElementById('itemGrid');
        const query = document.getElementById('pSearch').value.toLowerCase();
        grid.innerHTML = '';
        
        // Filter items based on POS category and search
        const availableItems = db.filter(i => {
            const matchesSearch = i.name.toLowerCase().includes(query);
            const matchesCategory = currentPosCategory === 'all' || 
                                  i.category === currentPosCategory;
            const hasStock = parseFloat(i.qty) > 0;
            
            return matchesSearch && matchesCategory && hasStock;
        });
        
        if (availableItems.length === 0) {
            grid.innerHTML = `
                <div style="text-align:center; padding:40px; color:var(--text-dim); grid-column: 1/-1;">
                    No items available in this category<br>
                    <small>Add stock or check other categories</small>
                </div>`;
        } else {
            availableItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card glass';
                card.innerHTML = `
                    <span class="stock-badge">${parseFloat(item.qty).toFixed(2)}kg</span>
                    <div style="font-size:30px; margin-bottom: 8px;">${item.emoji || 'üçé'}</div>
                    <b style="font-size: 13px; margin-bottom: 4px;">${item.name}</b>
                    <div style="font-size: 12px; color: var(--neon-green);">
                        Rs ${parseFloat(item.price).toFixed(2)}
                    </div>
                    ${item.barcode ? `<div style="font-size:9px;color:var(--text-dim); margin-top: 4px;">${item.barcode}</div>` : ''}
                `;
                card.onclick = () => addToCart(item);
                grid.appendChild(card);
            });
        }
        
        // Update the select dropdown in stock control
        updateItemSelectDropdown();
    }

    // -------------------------------------------------------------------------
    // ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä ‡∂ö‡∑ä‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂Ω‡∑í‡∂∫
    // -------------------------------------------------------------------------
    function completeSale() {
        if (!cart.length) {
            showNotification("Please add items to cart first", "error");
            return;
        }
        
        // Show contact info modal first
        document.getElementById('contactModal').style.display = 'flex';
        document.getElementById('customerName').focus();
    }

    function skipContactInfo() {
        currentCustomerInfo = null;
        document.getElementById('contactModal').style.display = 'none';
        processSaleCompletion();
    }

    function saveContactInfo() {
        const name = document.getElementById('customerName').value.trim();
        const email = document.getElementById('customerEmail').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();
        
        currentCustomerInfo = {
            name: name || 'Walk-in Customer',
            email: email || '',
            phone: phone || '',
            timestamp: new Date().toISOString()
        };
        
        document.getElementById('contactModal').style.display = 'none';
        processSaleCompletion();
    }

    function processSaleCompletion() {
        let subtotal = cart.reduce((a, b) => a + b.rowTotal, 0);
        let total = Math.max(0, subtotal - currentDiscount);
        let cost = cart.reduce((a, b) => a + (b.cost * b.weight), 0);
        let itemsForLog = [...cart];
        let saleId = 'SALE_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

        // Update stock quantities
        cart.forEach(c => { 
            let p = db.find(x => x.name === c.name); 
            if (p) {
                p.qty = (parseFloat(p.qty) - c.weight).toFixed(3);
                if (p.qty <= 0) {
                    p.qty = 0;
                    soldOutItems.add(p.name);
                }
            }
        });

        // Create sale record
        const saleRecord = {
            id: saleId,
            total: total,
            subtotal: subtotal,
            discount: currentDiscount,
            profit: total - cost,
            date: new Date().toLocaleDateString(),
            time: new Date().toLocaleTimeString(),
            timestamp: Date.now(),
            month: new Date().getMonth(),
            itemsCount: cart.length,
            items: itemsForLog,
            customer: currentCustomerInfo,
            syncId: syncId
        };

        sales.push(saleRecord);
        
        addLog(`Sale completed: Rs ${total.toFixed(2)}${currentDiscount > 0 ? ` [Discount: Rs ${currentDiscount.toFixed(2)}]` : ''}`, 'sale', saleRecord);
        
        // Show receipt
        showReceipt(itemsForLog, total, currentDiscount, saleRecord.time, currentCustomerInfo);
        
        // Clear cart and reset
        cart = []; 
        currentDiscount = 0;
        currentCustomerInfo = null;
        
        // Update UI
        updateCartUI(); 
        renderItems(); 
        updateStats();
        
        // Save to both storage systems
        saveToBothStorage();
        
        showNotification('‚úÖ Sale completed successfully!', 'success');
        
        // Clear contact form
        document.getElementById('customerName').value = '';
        document.getElementById('customerEmail').value = '';
        document.getElementById('customerPhone').value = '';
    }

    // -------------------------------------------------------------------------
    // ‡∂Ö‡∂±‡∑ô‡∂ö‡∑î‡∂≠‡∑ä ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫‡∂∫‡∂±‡∑ä
    // -------------------------------------------------------------------------
    function addLog(msg, type, data = null) {
        const logEntry = { 
            msg, 
            type, 
            data, 
            time: new Date().toLocaleTimeString(), 
            date: new Date().toLocaleDateString(), 
            id: Date.now(),
            syncId: syncId 
        };
        
        logs.unshift(logEntry);
        if(logs.length > 100) logs.pop();
        
        // Save to both storage systems
        saveToBothStorage();
        
        renderLogs();
    }

    function renderLogs() {
        const logBox = document.getElementById('historyLog');
        logBox.innerHTML = logs.map(l => `
            <div class="history-item">
                <span>[${l.time}] ${l.msg}</span>
                ${l.type === 'sale' ? `<button class="btn-view" onclick="viewOldBill('${l.id}')">VIEW</button>` : ''}
            </div>
        `).join('');
    }

    function viewOldBill(logId) {
        // First check if the log exists
        let log = logs.find(x => x.id.toString() === logId.toString());
        
        if(!log || !log.data) {
            showNotification("Sale details not found", "error");
            return;
        }
        
        // Extract sale data
        const saleData = log.data;
        const items = saleData.items || [];
        const total = saleData.total || 0;
        const discount = saleData.discount || 0;
        const time = saleData.time || log.time;
        const saleId = saleData.id || logId;
        
        // Show receipt with all details
        showReceipt(items, total, discount, time, saleData.customer || null);
        
        // Also add a log entry about viewing this old bill
        addLog(`Viewed old sale: ${saleId}`, 'info');
    }

    function showReceipt(items, total, discount, time, customer = null) {
        let html = `
            <div style="text-align:center">
                <h3>JAYANETH PRO MART</h3>
                <p>${new Date().toLocaleDateString()} | ${time}</p>
                <hr>
            </div>`;
        
        // Add customer info if available
        if (customer && customer.name) {
            html += `
                <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                    <div style="font-weight: 600; margin-bottom: 5px;">Customer Information:</div>
                    <div>Name: ${customer.name}</div>
                    ${customer.phone ? `<div>Phone: ${customer.phone}</div>` : ''}
                    ${customer.email ? `<div>Email: ${customer.email}</div>` : ''}
                </div>
            `;
        }
        
        if (items.length === 0) {
            html += `<p style="text-align:center; color: #666;">No items in this sale</p>`;
        } else {
            items.forEach(i => {
                html += `<div style="display:flex; justify-content:space-between; margin-bottom: 5px;">
                    <span>${i.name} (${parseFloat(i.weight || 0).toFixed(3)}kg)</span>
                    <span>Rs ${parseFloat(i.rowTotal || 0).toFixed(2)}</span>
                </div>`;
            });
        }
        
        html += `<hr style="margin: 15px 0;">`;
        
        const subtotal = items.reduce((sum, i) => sum + (i.rowTotal || 0), 0);
        
        if (discount > 0) {
            html += `<div style="display:flex; justify-content:space-between; margin-bottom: 5px;">
                <span>Subtotal</span>
                <span>Rs ${subtotal.toFixed(2)}</span>
            </div>`;
            html += `<div style="display:flex; justify-content:space-between; margin-bottom: 10px; color:red;">
                <span>Discount</span>
                <span>-Rs ${parseFloat(discount).toFixed(2)}</span>
            </div>`;
        }
        
        html += `<div style="display:flex; justify-content:space-between; font-weight:800; font-size: 16px; margin-top: 10px;">
            <span>TOTAL</span>
            <span>Rs ${parseFloat(total).toFixed(2)}</span>
        </div>`;
        
        // Add payment method if available
        if (items.length > 0) {
            html += `<div style="margin-top: 10px; font-size: 11px; color: #666;">
                <div>Payment: Cash</div>
                <div>Items: ${items.length}</div>
            </div>`;
        }
        
        html += `<p style="text-align:center; font-size:10px; margin-top:15px; color: #666;">Thank You! Come Again.</p>`;
        
        document.getElementById('billArea').innerHTML = html;
        document.getElementById('modal').style.display = 'flex';
    }

    // -------------------------------------------------------------------------
    // Update the select dropdown with available items
    // -------------------------------------------------------------------------
    function updateItemSelectDropdown() {
        const select = document.getElementById('stSelectName');
        select.innerHTML = '<option value="">-- Select existing item or add new --</option>';
        
        // Add "New +" option
        const newOption = document.createElement('option');
        newOption.value = "new";
        newOption.textContent = "‚ûï Add New Item";
        select.appendChild(newOption);
        
        // Add available items grouped by category
        const fruits = db.filter(i => i.category === 'Fruit');
        const vegetables = db.filter(i => i.category === 'Vegetable');
        const other = db.filter(i => i.category !== 'Fruit' && i.category !== 'Vegetable');
        
        if (fruits.length > 0) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = "üçé Fruits";
            fruits.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                option.textContent = `${item.name} (${parseFloat(item.qty).toFixed(2)}kg)`;
                optgroup.appendChild(option);
            });
            select.appendChild(optgroup);
        }
        
        if (vegetables.length > 0) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = "ü•¶ Vegetables";
            vegetables.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                option.textContent = `${item.name} (${parseFloat(item.qty).toFixed(2)}kg)`;
                optgroup.appendChild(option);
            });
            select.appendChild(optgroup);
        }
        
        if (other.length > 0) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = "üì¶ Other Items";
            other.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                option.textContent = `${item.name} (${parseFloat(item.qty).toFixed(2)}kg)`;
                optgroup.appendChild(option);
            });
            select.appendChild(optgroup);
        }
    }

    // -------------------------------------------------------------------------
    // Handle item selection in stock control
    // -------------------------------------------------------------------------
    function handleItemSelect() {
        const selectedValue = document.getElementById('stSelectName').value;
        
        if (selectedValue === "new") {
            // Clear all fields for new item
            document.getElementById('stName').value = "";
            document.getElementById('stCost').value = "";
            document.getElementById('stPrice').value = "";
            document.getElementById('stEmoji').value = "üçé";
            document.getElementById('stBarcode').value = "";
            document.getElementById('stCat').value = "Fruit";
            
            // Focus on name field
            document.getElementById('stName').focus();
        } else if (selectedValue) {
            // Find the selected item
            const item = db.find(i => i.name === selectedValue);
            if (item) {
                // Auto-fill the form with item details
                document.getElementById('stName').value = item.name;
                document.getElementById('stCost').value = item.cost;
                document.getElementById('stPrice').value = item.price;
                document.getElementById('stEmoji').value = item.emoji || "üçé";
                document.getElementById('stBarcode').value = item.barcode || "";
                document.getElementById('stCat').value = item.category || "Fruit";
                
                // Focus on quantity field
                document.getElementById('stQty').focus();
            }
        }
    }

    // -------------------------------------------------------------------------
    // Process stock update
    // -------------------------------------------------------------------------
    function processStock() {
        let mode = document.getElementById('stType').value;
        let qty = parseFloat(document.getElementById('stQty').value);
        
        if(!qty || qty <= 0) {
            showNotification("Please enter a valid quantity", "error");
            return;
        }

        if(mode === 'in') {
            let name = document.getElementById('stName').value.trim();
            let cost = parseFloat(document.getElementById('stCost').value);
            let price = parseFloat(document.getElementById('stPrice').value);
            let emoji = document.getElementById('stEmoji').value || 'üçé';
            let barcode = document.getElementById('stBarcode').value.trim();
            let category = document.getElementById('stCat').value;
            
            if(!name) {
                showNotification("Please enter item name", "error");
                return;
            }
            
            let existing = db.find(i => i.name.toLowerCase() === name.toLowerCase());
            if(existing) { 
                existing.qty = (parseFloat(existing.qty) + qty).toFixed(3);
                if (barcode && !existing.barcode) {
                    existing.barcode = barcode;
                }
                // Remove from sold out items if it was sold out
                soldOutItems.delete(existing.name);
                addLog(`Stock updated: ${name} (+${qty}kg)`, 'stock');
                showNotification(`${name} stock increased by ${qty}kg`, 'success');
            } else {
                if(!cost || cost <= 0 || !price || price <= 0) {
                    showNotification("Please enter valid prices", "error");
                    return;
                }
                db.push({ 
                    name, 
                    cost: cost, 
                    price: price, 
                    qty, 
                    emoji: emoji,
                    barcode: barcode || null,
                    category: category
                }); 
                addLog(`New item added: ${name}`, 'stock');
                showNotification(`New item added: ${name}`, 'success');
            }
        } else {
            let itemName = document.getElementById('stSelect').value;
            let item = db.find(i => i.name === itemName);
            
            if(!item) {
                showNotification("Item not found", "error");
                return;
            }
            
            if(qty > parseFloat(item.qty)) {
                showNotification(`Insufficient stock! Available: ${item.qty}kg`, "error");
                return;
            }
            
            item.qty = (parseFloat(item.qty) - qty).toFixed(3);
            wastage.push({ 
                name: item.name, 
                loss: qty * item.cost, 
                quantity: qty,
                date: new Date().toLocaleDateString(), 
                month: new Date().getMonth(),
                syncId: syncId
            });
            addLog(`Wastage removed: ${item.name} (-${qty}kg)`, 'waste');
            showNotification(`${item.name} stock reduced by ${qty}kg`, 'warning');
        }
        
        // Clear form after successful operation
        clearStockForm();
        
        // Save to both storage systems
        saveToBothStorage();
        
        // Update UI
        renderItems(); 
        updateStats();
        
        // Refresh the dropdown for waste mode
        if(mode === 'out') {
            document.getElementById('stSelect').innerHTML = db.map(i => 
                `<option value="${i.name}">${i.name} (${parseFloat(i.qty).toFixed(2)}kg)</option>`
            ).join('');
        }
        
        // Refresh stock table
        loadStockTable();
    }

    // -------------------------------------------------------------------------
    // Add expense
    // -------------------------------------------------------------------------
    function addExpense() {
        let n = document.getElementById('expName').value.trim();
        let a = parseFloat(document.getElementById('expAmt').value);
        
        if(!n) {
            showNotification("Please enter expense reason", "error");
            return;
        }
        
        if(!a || a <= 0) {
            showNotification("Please enter valid amount", "error");
            return;
        }
        
        expenses.push({ 
            name: n, 
            amt: a, 
            date: new Date().toLocaleDateString(), 
            month: new Date().getMonth(),
            syncId: syncId
        });
        addLog(`Expense added: ${n} (Rs ${a})`, 'expense');
        showNotification(`Expense added: ${n} - Rs ${a.toFixed(2)}`, 'warning');
        
        clearExpenseForm();
        
        // Save to both storage systems
        saveToBothStorage();
        
        updateStats();
    }

    // -------------------------------------------------------------------------
    // Update statistics
    // -------------------------------------------------------------------------
    function updateStats() {
        let today = new Date().toLocaleDateString();
        let curMonth = new Date().getMonth();
        let daySales = sales.filter(s => s.date === today);
        let dayRev = daySales.reduce((a, b) => a + b.total, 0);
        let dayGrossProf = daySales.reduce((a, b) => a + b.profit, 0);
        let dayLoss = wastage.filter(w => w.date === today).reduce((a, b) => a + b.loss, 0) + expenses.filter(e => e.date === today).reduce((a, b) => a + b.amt, 0);
        let monthProf = sales.filter(s => s.month === curMonth).reduce((a, b) => a + b.profit, 0) - wastage.filter(w => w.month === curMonth).reduce((a, b) => a + b.loss, 0) - expenses.filter(e => e.month === curMonth).reduce((a, b) => a + b.amt, 0);

        document.getElementById('statRev').innerText = `Rs ${dayRev.toFixed(2)}`;
        document.getElementById('statProf').innerText = `Rs ${(dayGrossProf - dayLoss).toFixed(2)}`;
        document.getElementById('rDayRev').innerText = dayRev.toFixed(2);
        document.getElementById('rDayProf').innerText = (dayGrossProf - dayLoss).toFixed(2);
        document.getElementById('rDayLoss').innerText = dayLoss.toFixed(2);
        document.getElementById('rMonthProf').innerText = monthProf.toFixed(2);
        document.getElementById('summaryText').innerHTML = `Profit: Rs ${dayGrossProf.toFixed(2)} | Loss: Rs ${dayLoss.toFixed(2)}<br><b>Net Profit: Rs ${(dayGrossProf - dayLoss).toFixed(2)}</b>`;
        
        const targets = document.querySelectorAll('.privacy-target');
        const reportWrapper = document.getElementById('reportPrivacyWrapper');
        if(isLocked) { 
            targets.forEach(e => e.classList.add('privacy-blur')); 
            reportWrapper.classList.add('privacy-blur'); 
        } else { 
            targets.forEach(e => e.classList.remove('privacy-blur')); 
            reportWrapper.classList.remove('privacy-blur'); 
        }
    }

    // -------------------------------------------------------------------------
    // Tab switching
    // -------------------------------------------------------------------------
    function switchTab(t) {
        ['view-pos', 'view-stock', 'view-reports', 'view-game'].forEach(v => 
            document.getElementById(v).style.display = 'none'
        );
        document.getElementById('view-' + t).style.display = t === 'pos' ? 'contents' : 'block';
        
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        document.getElementById('tab-' + t).classList.add('active');
        
        if(t === 'stock') {
            renderLogs();
            // Initialize the dropdown for waste mode
            document.getElementById('stSelect').innerHTML = db.map(i => 
                `<option value="${i.name}">${i.name} (${parseFloat(i.qty).toFixed(2)}kg)</option>`
            ).join('');
            // Update the item select dropdown
            updateItemSelectDropdown();
            // Load stock table
            loadStockTable();
        } else if (t === 'game') {
            // Initialize game when switching to game tab
            setTimeout(initGame, 100);
        } else if (t === 'pos') {
            // Reset POS category filter when switching back to POS
            currentPosCategory = 'all';
            document.querySelectorAll('.pos-cat-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.textContent.includes('All Items')) {
                    btn.classList.add('active');
                }
            });
            renderItems();
        }
    }

    // -------------------------------------------------------------------------
    // Cart functions
    // -------------------------------------------------------------------------
    function addToCart(item) {
        tempItem = item;
        document.getElementById('weightTitle').innerText = item.name;
        document.getElementById('weightSub').innerText = `Price: Rs ${item.price} | Stock: ${item.qty}kg`;
        document.getElementById('weightInput').value = "";
        document.getElementById('weightModal').style.display = 'flex';
        document.getElementById('weightInput').focus();
    }

    function confirmWeight() {
        let input = document.getElementById('weightInput').value;
        let weight = parseFloat(input);
        if (isNaN(weight) || weight <= 0) {
            showNotification("Invalid weight entered!", "error");
            return;
        }
        if (weight > tempItem.qty) {
            showNotification(`Insufficient stock! Available: ${tempItem.qty}kg`, "error");
            return;
        }
        cart.push({ 
            ...tempItem, 
            weight: weight, 
            rowTotal: tempItem.price * weight 
        });
        updateCartUI();
        closeModal('weightModal');
        showNotification(`${tempItem.name} added to cart`);
    }

    function closeWeightModal() {
        document.getElementById('weightModal').style.display = 'none';
        tempItem = null;
    }

    function updateCartUI() {
        const list = document.getElementById('cartList');
        let subtotal = 0;
        list.innerHTML = '';
        
        if (cart.length === 0) {
            list.innerHTML = `
                <div style="text-align:center; padding:40px; color:var(--text-dim);">
                    Cart is empty<br>
                    <small>Add items from the left or scan items</small>
                </div>`;
        } else {
            cart.forEach((item, i) => {
                subtotal += item.rowTotal;
                list.innerHTML += `
                    <div class="cart-row">
                        <span>${item.name}</span>
                        <span>${item.weight.toFixed(3)}kg</span>
                        <span>Rs ${item.price}</span>
                        <span>Rs ${item.rowTotal.toFixed(2)}</span>
                        <span onclick="removeCartItem(${i})" style="color:var(--danger);cursor:pointer;">‚úï</span>
                    </div>`;
            });
        }
        
        const total = Math.max(0, subtotal - currentDiscount);
        document.getElementById('subTotal').innerText = subtotal.toFixed(2);
        document.getElementById('discountAmount').innerText = currentDiscount.toFixed(2);
        document.getElementById('grandTotal').innerText = total.toFixed(2);
        
        // Show/hide discount display
        document.getElementById('discountDisplay').style.display = currentDiscount > 0 ? 'flex' : 'none';
    }

    function removeCartItem(index) {
        const item = cart[index];
        cart.splice(index, 1);
        updateCartUI();
        showNotification(`${item.name} removed from cart`, 'warning');
    }

    function applyDiscount() {
        const discountInput = document.getElementById('discountInput');
        const discount = parseFloat(discountInput.value);
        
        if (isNaN(discount) || discount < 0) {
            showNotification("Please enter a valid discount amount", "error");
            return;
        }
        
        const subtotal = cart.reduce((total, item) => total + item.rowTotal, 0);
        if (discount > subtotal) {
            showNotification("Discount cannot be greater than subtotal", "error");
            return;
        }
        
        currentDiscount = discount;
        updateCartUI();
        document.getElementById('removeDiscountBtn').style.display = 'inline-block';
        discountInput.value = "";
        showNotification(`Discount of Rs ${discount.toFixed(2)} applied`);
    }
    
    function removeDiscount() {
        currentDiscount = 0;
        document.getElementById('discountInput').value = "";
        document.getElementById('removeDiscountBtn').style.display = 'none';
        updateCartUI();
        showNotification('Discount removed');
    }

    // -------------------------------------------------------------------------
    // Pin and lock functions
    // -------------------------------------------------------------------------
    function handleLock() {
        if (isLocked) {
            document.getElementById('pinInput').value = "";
            document.getElementById('pinModal').style.display = 'flex';
            document.getElementById('pinInput').focus();
        } else {
            isLocked = true;
            document.getElementById('lockBtn').innerText = 'üîí LOCK';
            updateStats();
            showNotification('System locked');
        }
    }

    function confirmPin() {
        let pin = document.getElementById('pinInput').value;
        if (pin === "8514") {
            isLocked = false;
            document.getElementById('lockBtn').innerText = 'üîì UNLOCKED';
            updateStats();
            closeModal('pinModal');
            showNotification('System unlocked', 'success');
        } else {
            closeModal('pinModal');
            setTimeout(() => {
                document.getElementById('pinErrorModal').style.display = 'flex';
            }, 100);
        }
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
        if (id === 'scannerModal') {
            stopScanner();
        } else if (id === 'weightModal') {
            tempItem = null;
        }
    }

    // -------------------------------------------------------------------------
    // Stock control helper functions
    // -------------------------------------------------------------------------
    function toggleStockMode() {
        let mode = document.getElementById('stType').value;
        document.getElementById('newProductForm').style.display = mode === 'in' ? 'block' : 'none';
        document.getElementById('existingProductForm').style.display = mode === 'out' ? 'block' : 'none';
        if(mode === 'out') {
            document.getElementById('stSelect').innerHTML = db.map(i => 
                `<option value="${i.name}">${i.name} (${parseFloat(i.qty).toFixed(2)}kg)</option>`
            ).join('');
        }
        
        // Clear all fields when switching modes
        clearStockForm();
    }

    function clearStockForm() {
        document.getElementById('stSelectName').value = "";
        document.getElementById('stName').value = "";
        document.getElementById('stCost').value = "";
        document.getElementById('stPrice').value = "";
        document.getElementById('stEmoji').value = "üçé";
        document.getElementById('stBarcode').value = "";
        document.getElementById('stQty').value = "";
        document.getElementById('stCat').value = "Fruit";
    }

    function clearExpenseForm() {
        document.getElementById('expName').value = "";
        document.getElementById('expAmt').value = "";
    }

    // -------------------------------------------------------------------------
    // Stock Table Management Functions
    // -------------------------------------------------------------------------
    function refreshStockTable() {
        loadStockTable();
        showNotification("Stock table refreshed", "success");
    }

    function loadStockTable() {
        const tableBody = document.getElementById('stockTableBody');
        const emptyMessage = document.getElementById('stockTableEmpty');
        
        if (!db.length) {
            tableBody.innerHTML = '';
            emptyMessage.style.display = 'block';
            return;
        }
        
        emptyMessage.style.display = 'none';
        
        // Sort items by category and name
        const sortedItems = [...db].sort((a, b) => {
            if (a.category !== b.category) {
                return a.category.localeCompare(b.category);
            }
            return a.name.localeCompare(b.name);
        });
        
        tableBody.innerHTML = sortedItems.map((item, index) => {
            const stockValue = parseFloat(item.qty) * parseFloat(item.cost);
            const stockClass = parseFloat(item.qty) <= 0 ? 'out-of-stock' : 
                             parseFloat(item.qty) < 5 ? 'low-stock' : 'in-stock';
            
            return `
                <tr>
                    <td>${index + 1}</td>
                    <td>
                        <div class="stock-item-row">
                            <div class="emoji-cell">
                                ${item.emoji || 'üì¶'}
                            </div>
                            <div class="stock-item-info">
                                <div class="stock-item-name">${item.name}</div>
                                <div class="stock-item-barcode">${item.barcode || 'No barcode'}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="stock-category-badge">
                            ${item.category || 'Other'}
                        </span>
                    </td>
                    <td class="stock-qty ${stockClass}">
                        ${parseFloat(item.qty).toFixed(2)} kg
                    </td>
                    <td style="font-family: 'JetBrains Mono';">Rs ${parseFloat(item.cost).toFixed(2)}</td>
                    <td style="font-family: 'JetBrains Mono'; color: var(--neon-green);">Rs ${parseFloat(item.price).toFixed(2)}</td>
                    <td>
                        <div style="font-family: 'JetBrains Mono'; font-size: 11px; color: var(--text-dim);">
                            ${item.barcode || 'No barcode'}
                        </div>
                    </td>
                    <td style="font-family: 'JetBrains Mono'; font-weight: 600;">Rs ${stockValue.toFixed(2)}</td>
                    <td>
                        <div class="stock-actions">
                            <button class="action-btn edit-btn-stock" onclick="editStockItem('${item.name}')" title="Edit item">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="action-btn delete-btn-stock" onclick="deleteStockItem('${item.name}')" title="Delete item">
                                üóëÔ∏è Delete
                            </button>
                            <button class="action-btn restock-btn-stock" onclick="restockItem('${item.name}')" title="Add stock">
                                üì¶ Restock
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function editStockItem(itemName) {
        const item = db.find(i => i.name === itemName);
        if (!item) {
            showNotification("Item not found", "error");
            return;
        }
        
        // Check if system is locked
        if (isLocked) {
            itemToEdit = item;
            document.getElementById('editPinInput').value = "";
            document.getElementById('editPinModal').style.display = 'flex';
            document.getElementById('editPinInput').focus();
            
            // Customize the modal for editing
            document.getElementById('editPinModal').querySelector('.popup-title').textContent = "EDIT LOCKED";
            document.getElementById('editPinModal').querySelector('.popup-sub').textContent = `Enter PIN 8514 to edit "${itemName}"`;
            
            // Override the verify function for editing
            const verifyBtn = document.getElementById('editPinModal').querySelector('.btn-pay');
            verifyBtn.onclick = verifyStockEditPin;
        } else {
            openStockItemEditModal(itemName);
        }
    }

    function verifyStockEditPin() {
        let pin = document.getElementById('editPinInput').value;
        if (pin === "8514") {
            closeModal('editPinModal');
            if (itemToEdit) {
                openStockItemEditModal(itemToEdit.name);
            }
        } else {
            showNotification('Incorrect PIN', 'error');
            closeModal('editPinModal');
        }
    }

    function openStockItemEditModal(itemName) {
        const item = db.find(i => i.name === itemName);
        if (!item) {
            showNotification("Item not found", "error");
            return;
        }
        
        itemToEdit = item;
        selectedEmoji = item.emoji || 'üçé';
        currentEmojiCategory = 'fruits';
        
        // Fill the form
        document.getElementById('stockEditTitle').textContent = `Edit ${item.name}`;
        document.getElementById('stockEditSub').textContent = `Update item details`;
        document.getElementById('stockEditName').value = item.name;
        document.getElementById('stockEditCategory').value = item.category || 'Fruit';
        document.getElementById('stockEditCost').value = item.cost;
        document.getElementById('stockEditPrice').value = item.price;
        document.getElementById('stockEditQty').value = parseFloat(item.qty);
        document.getElementById('stockEditBarcode').value = item.barcode || '';
        document.getElementById('stockEmojiDisplay').textContent = selectedEmoji;
        
        // Load emoji grid
        loadStockEmojiGrid(currentEmojiCategory);
        
        // Show modal
        document.getElementById('stockEditModal').style.display = 'flex';
        document.getElementById('stockEditName').focus();
    }

    function toggleStockEmojiPicker() {
        const picker = document.getElementById('stockEmojiPicker');
        if (picker.style.display === 'none') {
            picker.style.display = 'block';
            loadStockEmojiGrid(currentEmojiCategory);
        } else {
            picker.style.display = 'none';
        }
    }

    function switchStockEmojiCategory(category) {
        currentEmojiCategory = category;
        loadStockEmojiGrid(category);
    }

    function loadStockEmojiGrid(category) {
        const emojiGrid = document.getElementById('stockEmojiGrid');
        emojiGrid.innerHTML = '';
        
        const emojis = emojiPacks[category] || emojiPacks.fruits;
        
        emojis.forEach(emoji => {
            const emojiOption = document.createElement('div');
            emojiOption.style.cssText = `
                font-size: 24px;
                padding: 8px;
                cursor: pointer;
                border-radius: 6px;
                text-align: center;
                transition: all 0.2s;
                background: ${emoji === selectedEmoji ? 'rgba(0, 242, 255, 0.2)' : 'transparent'};
                border: ${emoji === selectedEmoji ? '1px solid var(--neon-blue)' : '1px solid transparent'};
            `;
            emojiOption.innerText = emoji;
            emojiOption.onclick = () => selectStockEmoji(emoji);
            emojiGrid.appendChild(emojiOption);
        });
    }

    function selectStockEmoji(emoji) {
        selectedEmoji = emoji;
        document.getElementById('stockEmojiDisplay').innerText = emoji;
        
        // Update selection in grid
        document.querySelectorAll('#stockEmojiGrid > div').forEach(opt => {
            opt.style.background = opt.innerText === emoji ? 'rgba(0, 242, 255, 0.2)' : 'transparent';
            opt.style.border = opt.innerText === emoji ? '1px solid var(--neon-blue)' : '1px solid transparent';
        });
    }

    function saveStockItemEdit() {
        if (!itemToEdit) return;
        
        const newName = document.getElementById('stockEditName').value.trim();
        const newCost = parseFloat(document.getElementById('stockEditCost').value);
        const newPrice = parseFloat(document.getElementById('stockEditPrice').value);
        const newQty = parseFloat(document.getElementById('stockEditQty').value);
        const newBarcode = document.getElementById('stockEditBarcode').value.trim();
        const newCategory = document.getElementById('stockEditCategory').value;
        
        // Validation
        if (!newName) {
            showNotification("Item name cannot be empty", "error");
            return;
        }
        
        if (isNaN(newCost) || newCost <= 0) {
            showNotification("Please enter a valid cost price", "error");
            return;
        }
        
        if (isNaN(newPrice) || newPrice <= 0) {
            showNotification("Please enter a valid selling price", "error");
            return;
        }
        
        if (isNaN(newQty) || newQty < 0) {
            showNotification("Please enter a valid quantity", "error");
            return;
        }
        
        // Check if name already exists (if changed)
        if (newName !== itemToEdit.name) {
            const existingItem = db.find(i => i.name.toLowerCase() === newName.toLowerCase() && i !== itemToEdit);
            if (existingItem) {
                showNotification(`Item "${newName}" already exists`, "error");
                return;
            }
        }
        
        // Update item
        itemToEdit.name = newName;
        itemToEdit.cost = newCost;
        itemToEdit.price = newPrice;
        itemToEdit.qty = newQty.toFixed(3);
        itemToEdit.barcode = newBarcode || null;
        itemToEdit.category = newCategory;
        itemToEdit.emoji = selectedEmoji;
        
        // Update sold out items set
        if (newQty <= 0) {
            soldOutItems.add(newName);
        } else {
            soldOutItems.delete(itemToEdit.name);
        }
        
        // Save to both storage systems
        saveToBothStorage();
        
        // Update UI
        loadStockTable();
        renderItems();
        updateItemSelectDropdown();
        
        closeStockEditModal();
        showNotification(`${newName} updated successfully`, "success");
        itemToEdit = null;
    }

    function closeStockEditModal() {
        document.getElementById('stockEditModal').style.display = 'none';
        document.getElementById('stockEmojiPicker').style.display = 'none';
        itemToEdit = null;
    }

    function deleteStockItem(itemName) {
        const item = db.find(i => i.name === itemName);
        if (!item) {
            showNotification("Item not found", "error");
            return;
        }
        
        // Check if system is locked
        if (isLocked) {
            itemToEdit = item;
            document.getElementById('editPinInput').value = "";
            document.getElementById('editPinModal').style.display = 'flex';
            document.getElementById('editPinInput').focus();
            
            // Customize the modal for deletion
            document.getElementById('editPinModal').querySelector('.popup-title').textContent = "CONFIRM DELETION";
            document.getElementById('editPinModal').querySelector('.popup-sub').textContent = `Enter PIN 8514 to delete "${itemName}"`;
            
            // Override the verify function for deletion
            const verifyBtn = document.getElementById('editPinModal').querySelector('.btn-pay');
            verifyBtn.onclick = verifyDeletePin;
        } else {
            confirmDeleteItem(itemName);
        }
    }

    function verifyDeletePin() {
        let pin = document.getElementById('editPinInput').value;
        if (pin === "8514") {
            closeModal('editPinModal');
            if (itemToEdit) {
                confirmDeleteItem(itemToEdit.name);
            }
        } else {
            showNotification('Incorrect PIN', 'error');
            closeModal('editPinModal');
        }
    }

    function confirmDeleteItem(itemName) {
        const item = db.find(i => i.name === itemName);
        if (!item) {
            showNotification("Item not found", "error");
            return;
        }
        
        // Check if item is in any sales
        const itemInSales = sales.some(sale => 
            sale.items && sale.items.some(item => item.name === itemName)
        );
        
        let confirmMessage = `Are you sure you want to delete "${itemName}"?`;
        if (itemInSales) {
            confirmMessage += "\n\n‚ö†Ô∏è This item has sales history. Deleting it may affect reports.";
        }
        
        if (confirm(confirmMessage)) {
            // Remove from database
            const index = db.findIndex(i => i.name === itemName);
            if (index !== -1) {
                db.splice(index, 1);
            }
            
            // Remove from sold out items
            soldOutItems.delete(itemName);
            
            // Save to both storage systems
            saveToBothStorage();
            
            // Update UI
            loadStockTable();
            renderItems();
            updateItemSelectDropdown();
            
            showNotification(`"${itemName}" deleted successfully`, "success");
        }
    }

    function restockItem(itemName) {
        const item = db.find(i => i.name === itemName);
        if (!item) {
            showNotification("Item not found", "error");
            return;
        }
        
        // Auto-fill the stock form for restocking
        document.getElementById('stType').value = 'in';
        toggleStockMode();
        
        // Auto-select the item
        document.getElementById('stSelectName').value = itemName;
        handleItemSelect();
        
        // Focus on quantity field
        document.getElementById('stQty').focus();
        
        showNotification(`Ready to restock ${itemName}`, "info");
        
        // Scroll to the stock update form
        document.getElementById('stQty').scrollIntoView({ behavior: 'smooth' });
    }

    function exportStockData() {
        if (!db.length) {
            showNotification("No stock data to export", "warning");
            return;
        }
        
        const csvContent = "data:text/csv;charset=utf-8,"
            + ["Name,Category,Stock (kg),Cost Price,Selling Price,Barcode,Value"].concat(
                db.map(item => {
                    const value = parseFloat(item.qty) * parseFloat(item.cost);
                    return `"${item.name}","${item.category || 'Other'}",${parseFloat(item.qty).toFixed(3)},${parseFloat(item.cost).toFixed(2)},${parseFloat(item.price).toFixed(2)},"${item.barcode || ''}",${value.toFixed(2)}`;
                })
            ).join("\n");
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `jayeneth_stock_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification("Stock data exported as CSV", "success");
    }

    // -------------------------------------------------------------------------
    // Notification function
    // -------------------------------------------------------------------------
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        notification.style.background = type === 'error' ? 'var(--danger)' : 
                                      type === 'success' ? 'var(--neon-green)' : 
                                      type === 'warning' ? 'var(--orange)' : 'var(--neon-blue)';
        notification.style.color = type === 'error' ? 'white' : 'black';
        
        document.body.appendChild(notification);
        
        // Remove after animation
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }

    // -------------------------------------------------------------------------
    // Game functions
    // -------------------------------------------------------------------------
    function initGame() {
        game.canvas = document.getElementById('gameCanvas');
        game.ctx = game.canvas.getContext('2d');
        
        // Set canvas size - responsive
        resizeGameCanvas();
        
        // Update player name display
        document.getElementById('playerName').textContent = game.playerName;
        
        // Add keyboard event listeners
        window.addEventListener('keydown', (e) => {
            game.keys[e.key] = true;
        });
        
        window.addEventListener('keyup', (e) => {
            game.keys[e.key] = false;
        });
        
        // Add resize listener
        window.addEventListener('resize', resizeGameCanvas);
    }
    
    function resizeGameCanvas() {
        if (!game.canvas) return;
        
        const container = game.canvas.parentElement;
        const width = container.clientWidth;
        const height = container.clientHeight;
        
        game.canvas.width = width;
        game.canvas.height = height;
        
        // Adjust basket position
        game.basket.x = width / 2 - game.basket.width / 2;
        game.basket.y = height - 50;
        
        // Redraw if game is running
        if (game.isRunning && !game.isPaused) {
            drawGame();
        }
    }

    function startGame() {
        if (!game.playerName || game.playerName === 'Guest') {
            document.getElementById('playerNameModal').style.display = 'flex';
            document.getElementById('playerNameInput').focus();
            return;
        }
        
        if (game.isRunning) return;
        
        game.isRunning = true;
        game.isPaused = false;
        game.score = 0;
        game.lives = 3;
        game.time = 60;
        game.fruits = [];
        game.bombs = [];
        
        // Set basket position based on canvas size
        game.basket.x = game.canvas.width / 2 - game.basket.width / 2;
        game.basket.y = game.canvas.height - 50;
        
        // Hide game over screen
        document.getElementById('gameOverScreen').style.display = 'none';
        
        // Update UI
        updateGameUI();
        
        // Start game loop
        game.lastTime = Date.now();
        game.gameLoopId = requestAnimationFrame(gameLoop);
        
        showNotification('Game started! Catch the fruits!', 'success');
    }

    function pauseGame() {
        if (!game.isRunning) return;
        
        game.isPaused = !game.isPaused;
        
        if (game.isPaused) {
            cancelAnimationFrame(game.gameLoopId);
            showNotification('Game paused', 'warning');
        } else {
            game.lastTime = Date.now();
            game.gameLoopId = requestAnimationFrame(gameLoop);
            showNotification('Game resumed', 'success');
        }
    }

    function gameLoop() {
        if (!game.isRunning || game.isPaused) return;
        
        const currentTime = Date.now();
        const deltaTime = currentTime - game.lastTime;
        game.lastTime = currentTime;
        
        // Update game state
        updateGame(deltaTime);
        
        // Draw game
        drawGame();
        
        // Continue game loop
        game.gameLoopId = requestAnimationFrame(gameLoop);
    }

    function updateGame(deltaTime) {
        // Move basket based on keys
        const speed = 5 * (game.canvas.width / 800);
        if (game.keys['ArrowLeft'] || game.keys['a'] || game.keys['A']) {
            game.basket.x -= speed;
        }
        if (game.keys['ArrowRight'] || game.keys['d'] || game.keys['D']) {
            game.basket.x += speed;
        }
        
        // Keep basket within bounds
        game.basket.x = Math.max(0, Math.min(game.canvas.width - game.basket.width, game.basket.x));
        
        // Update time
        game.time -= deltaTime / 1000;
        if (game.time <= 0) {
            gameOver();
            return;
        }
        
        // Spawn fruits randomly
        if (Math.random() < 0.03) {
            spawnFruit();
        }
        
        // Spawn bombs randomly
        if (Math.random() < 0.01) {
            spawnBomb();
        }
        
        // Update fruits
        for (let i = game.fruits.length - 1; i >= 0; i--) {
            const fruit = game.fruits[i];
            fruit.y += fruit.speed;
            
            // Check collision with basket
            if (fruit.y + fruit.size > game.basket.y &&
                fruit.x + fruit.size > game.basket.x &&
                fruit.x < game.basket.x + game.basket.width) {
                
                // Add score based on fruit type
                if (fruit.type === 'golden') {
                    game.score += 50;
                    showNotification('Golden fruit! +50 points', 'success');
                } else {
                    game.score += 10;
                }
                
                // Remove fruit
                game.fruits.splice(i, 1);
                updateGameUI();
                continue;
            }
            
            // Remove if out of bounds
            if (fruit.y > game.canvas.height) {
                game.fruits.splice(i, 1);
            }
        }
        
        // Update bombs
        for (let i = game.bombs.length - 1; i >= 0; i--) {
            const bomb = game.bombs[i];
            bomb.y += bomb.speed;
            
            // Check collision with basket
            if (bomb.y + bomb.size > game.basket.y &&
                bomb.x + bomb.size > game.basket.x &&
                bomb.x < game.basket.x + game.basket.width) {
                
                // Lose a life
                game.lives--;
                updateGameUI();
                showNotification('Bomb! Lost a life', 'error');
                
                // Remove bomb
                game.bombs.splice(i, 1);
                
                // Check game over
                if (game.lives <= 0) {
                    gameOver();
                    return;
                }
                continue;
            }
            
            // Remove if out of bounds
            if (bomb.y > game.canvas.height) {
                game.bombs.splice(i, 1);
            }
        }
    }

    function drawGame() {
        const ctx = game.ctx;
        const canvas = game.canvas;
        
        // Clear canvas
        ctx.fillStyle = 'rgba(5, 10, 15, 0.8)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Draw background grid
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
        ctx.lineWidth = 1;
        const gridSize = 50 * (canvas.width / 800);
        for (let x = 0; x < canvas.width; x += gridSize) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, canvas.height);
            ctx.stroke();
        }
        for (let y = 0; y < canvas.height; y += gridSize) {
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
            ctx.stroke();
        }
        
        // Draw basket
        ctx.fillStyle = 'var(--neon-green)';
        ctx.fillRect(game.basket.x, game.basket.y, game.basket.width, game.basket.height);
        
        // Draw basket details
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        ctx.fillRect(game.basket.x + 5, game.basket.y + 5, game.basket.width - 10, game.basket.height - 10);
        
        // Draw fruits
        game.fruits.forEach(fruit => {
            ctx.font = `${fruit.size}px Arial`;
            ctx.fillStyle = fruit.type === 'golden' ? 'gold' : 'white';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(fruit.emoji, fruit.x + fruit.size/2, fruit.y + fruit.size/2);
        });
        
        // Draw bombs
        game.bombs.forEach(bomb => {
            ctx.font = `${bomb.size}px Arial`;
            ctx.fillStyle = 'var(--danger)';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('üí£', bomb.x + bomb.size/2, bomb.y + bomb.size/2);
        });
        
        // Draw score overlay
        ctx.fillStyle = 'rgba(0,0,0,0.7)';
        ctx.fillRect(10, 10, 150, 80);
        
        ctx.font = '12px Inter';
        ctx.fillStyle = 'white';
        ctx.textAlign = 'left';
        ctx.fillText(`SCORE: ${game.score}`, 20, 30);
        ctx.fillText(`LIVES: ${'‚ù§Ô∏è'.repeat(game.lives)}`, 20, 50);
        ctx.fillText(`TIME: ${Math.ceil(game.time)}`, 20, 70);
    }

    function spawnFruit() {
        const fruits = ['üçé', 'üçå', 'üçä', 'üçá', 'üçì', 'üçâ'];
        const emoji = fruits[Math.floor(Math.random() * fruits.length)];
        const isGolden = Math.random() < 0.1;
        
        const size = 30 * (game.canvas.width / 800);
        
        game.fruits.push({
            x: Math.random() * (game.canvas.width - size * 2),
            y: -size,
            size: isGolden ? size * 1.2 : size,
            speed: 2 + Math.random() * 2,
            emoji: isGolden ? 'ü•á' : emoji,
            type: isGolden ? 'golden' : 'normal'
        });
    }

    function spawnBomb() {
        const size = 30 * (game.canvas.width / 800);
        
        game.bombs.push({
            x: Math.random() * (game.canvas.width - size * 2),
            y: -size,
            size: size,
            speed: 3 + Math.random() * 2,
            emoji: 'üí£'
        });
    }

    function updateGameUI() {
        document.getElementById('gameScore').textContent = game.score;
        document.getElementById('gameLives').textContent = game.lives;
        document.getElementById('gameTime').textContent = Math.ceil(game.time);
    }

    function gameOver() {
        game.isRunning = false;
        if (game.gameLoopId) {
            cancelAnimationFrame(game.gameLoopId);
        }
        
        // Show game over screen
        document.getElementById('finalScore').textContent = game.score;
        document.getElementById('gameOverScreen').style.display = 'flex';
        
        // Save score to leaderboard
        saveToLeaderboard(game.playerName, game.score);
        
        showNotification(`Game Over! Final score: ${game.score}`, game.score > 100 ? 'success' : 'warning');
    }

    function restartGame() {
        startGame();
    }

    function saveToLeaderboard(name, score) {
        if (score <= 0) return;
        
        const entry = {
            name: name,
            score: score,
            timestamp: Date.now(),
            date: new Date().toLocaleDateString()
        };
        
        // Save to Firebase
        database.ref('game_leaderboard').push(entry);
    }

    function savePlayerName() {
        const name = document.getElementById('playerNameInput').value.trim() || 'Guest';
        game.playerName = name;
        localStorage.setItem('jmart_player_name', name);
        document.getElementById('playerName').textContent = name;
        closeModal('playerNameModal');
        startGame();
    }

    // -------------------------------------------------------------------------
    // QR/Barcode Scanner functions
    // -------------------------------------------------------------------------
    function showScanner(mode) {
        currentScannerMode = mode;
        document.getElementById('scannerModal').style.display = 'flex';
        document.getElementById('scanner-result').style.display = 'none';
        document.getElementById('scanned-text').innerHTML = '';
        
        // Clear scanner container
        const scannerContainer = document.getElementById('scanner-container');
        scannerContainer.innerHTML = `
            <div id="scanner-placeholder">
                <div class="scanner-icon">üì∑</div>
                <div>Click "Start Scanner" to begin</div>
            </div>
        `;
    }

    function startScanner() {
        const scannerContainer = document.getElementById('scanner-container');
        scannerContainer.innerHTML = '';
        
        // Create scanner element
        const scannerElement = document.createElement('div');
        scannerElement.id = 'qr-reader';
        scannerElement.style.width = '100%';
        scannerElement.style.height = '100%';
        scannerContainer.appendChild(scannerElement);
        
        try {
            // Initialize scanner
            scanner = new Html5Qrcode("qr-reader");
            
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
                facingMode: "environment"
            };
            
            scanner.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanError
            ).then(() => {
                console.log("Scanner started successfully");
                showNotification("Scanner started", "success");
            }).catch(err => {
                console.error("Scanner start error:", err);
                showNotification("Unable to start camera. Check permissions.", "error");
                scannerContainer.innerHTML = `
                    <div id="scanner-placeholder">
                        <div class="scanner-icon">üì∑</div>
                        <div>Camera access required</div>
                    </div>
                `;
            });
        } catch (error) {
            console.error("Scanner initialization error:", error);
            showNotification("Error initializing scanner", "error");
        }
    }

    function stopScanner() {
        if (scanner && scanner.isScanning) {
            scanner.stop().then(() => {
                console.log("Scanner stopped");
                scanner = null;
                const scannerContainer = document.getElementById('scanner-container');
                scannerContainer.innerHTML = `
                    <div id="scanner-placeholder">
                        <div class="scanner-icon">üì∑</div>
                        <div>Camera scanner stopped</div>
                    </div>
                `;
            }).catch(err => {
                console.error("Error stopping scanner:", err);
            });
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        console.log(`Scan result: ${decodedText}`, decodedResult);
        
        // Display scanned result with visual feedback
        const resultDiv = document.getElementById('scanner-result');
        resultDiv.innerHTML = `
            <div style="color: var(--neon-green); font-weight: 600;">‚úì SCAN SUCCESSFUL</div>
            <div style="margin-top: 5px;"><strong>Scanned Code:</strong> ${decodedText}</div>
            <div style="font-size: 11px; color: var(--text-dim);">${new Date().toLocaleTimeString()}</div>
        `;
        resultDiv.style.display = 'block';
        resultDiv.style.background = 'rgba(138, 255, 103, 0.1)';
        resultDiv.style.border = '1px solid var(--neon-green)';
        
        // Process based on scanner mode
        processScannedCode(decodedText);
        
        // Stop scanner after successful scan
        setTimeout(() => {
            if (scanner) {
                stopScanner();
            }
        }, 1500);
    }

    function onScanError(errorMessage) {
        console.log(`Scan error: ${errorMessage}`);
    }

    function processScannedCode(code) {
        // Clean the code
        code = code.trim();
        
        // Try to find item by barcode
        let item = db.find(i => i.barcode === code);
        
        // If not found by barcode, try to find by name
        if (!item) {
            item = db.find(i => i.name.toLowerCase().includes(code.toLowerCase()));
        }
        
        if (item) {
            // Item found
            switch(currentScannerMode) {
                case 'pos':
                case 'bill':
                    // Add to cart
                    setTimeout(() => {
                        closeModal('scannerModal');
                        addToCart(item);
                    }, 500);
                    break;
                    
                case 'stock':
                    // Pre-fill stock form
                    setTimeout(() => {
                        closeModal('scannerModal');
                        autoFillStockForm(item);
                    }, 500);
                    break;
            }
        } else {
            // Item not found
            switch(currentScannerMode) {
                case 'pos':
                case 'bill':
                    setTimeout(() => {
                        const resultDiv = document.getElementById('scanner-result');
                        resultDiv.innerHTML = `
                            <div style="color: var(--danger); font-weight: 600;">‚úó ITEM NOT FOUND</div>
                            <div style="margin-top: 5px;"><strong>Code:</strong> ${code}</div>
                            <div style="font-size: 11px; color: var(--text-dim);">Add item in Stock Control first</div>
                        `;
                        resultDiv.style.background = 'rgba(255, 71, 71, 0.1)';
                        resultDiv.style.border = '1px solid var(--danger)';
                    }, 300);
                    break;
                    
                case 'stock':
                    // For new items, just fill the barcode field
                    setTimeout(() => {
                        closeModal('scannerModal');
                        document.getElementById('stBarcode').value = code;
                        showNotification(`Barcode ${code} saved. Fill other details.`, 'info');
                    }, 500);
                    break;
            }
        }
    }

    function autoFillStockForm(item) {
        // Auto-select the item in dropdown
        document.getElementById('stSelectName').value = item.name;
        
        // Trigger the change event to fill other fields
        handleItemSelect();
        
        showNotification(`${item.name} loaded for stock update`, 'success');
    }

    // Generate barcode for items
    function generateBarcode(itemName) {
        const hash = Array.from(itemName).reduce((acc, char) => {
            return ((acc << 5) - acc) + char.charCodeAt(0);
        }, 0);
        return 'JM' + Math.abs(hash).toString().substring(0, 8);
    }

    // -------------------------------------------------------------------------
    // Initialize on load
    // -------------------------------------------------------------------------
    window.onload = () => { 
        // Try to load from Firebase first
        database.ref('pos_data').once('value').then((snapshot) => {
            const cloudData = snapshot.val();
            if (cloudData) {
                // Use cloud data
                db = cloudData.db || [];
                sales = cloudData.sales || [];
                expenses = cloudData.expenses || [];
                wastage = cloudData.wastage || [];
                logs = cloudData.logs || [];
                
                // Update local storage with cloud data
                localStorage.setItem('jmart_db', JSON.stringify(db));
                localStorage.setItem('jmart_sales', JSON.stringify(sales));
                localStorage.setItem('jmart_exp', JSON.stringify(expenses));
                localStorage.setItem('jmart_waste', JSON.stringify(wastage));
                localStorage.setItem('jmart_logs', JSON.stringify(logs));
                
                showNotification('üîÑ Cloud data loaded successfully', 'success');
            } else {
                // Load from local storage if no cloud data
                db = JSON.parse(localStorage.getItem('jmart_db')) || [];
                sales = JSON.parse(localStorage.getItem('jmart_sales')) || [];
                expenses = JSON.parse(localStorage.getItem('jmart_exp')) || [];
                wastage = JSON.parse(localStorage.getItem('jmart_waste')) || [];
                logs = JSON.parse(localStorage.getItem('jmart_logs')) || [];
            }
            
            // Initialize UI
            renderItems(); 
            updateStats(); 
            renderLogs();
            updateCartUI();
            
            // Generate barcodes for existing items if not present
            let needsSave = false;
            db.forEach(item => {
                if (!item.barcode) {
                    item.barcode = generateBarcode(item.name);
                    needsSave = true;
                }
                // Check for sold out items
                if (parseFloat(item.qty) <= 0) {
                    soldOutItems.add(item.name);
                }
            });
            if (needsSave) saveToBothStorage();
            
            // Update the item select dropdown
            updateItemSelectDropdown();
            
            // Load stock table
            loadStockTable();
            
            // Show welcome message
            setTimeout(() => {
                showNotification('Jayaneth Pro Mart POS Ready');
            }, 1000);
        }).catch(error => {
            console.error("Firebase load error:", error);
            // Load from local storage if Firebase fails
            db = JSON.parse(localStorage.getItem('jmart_db')) || [];
            sales = JSON.parse(localStorage.getItem('jmart_sales')) || [];
            expenses = JSON.parse(localStorage.getItem('jmart_exp')) || [];
            wastage = JSON.parse(localStorage.getItem('jmart_waste')) || [];
            logs = JSON.parse(localStorage.getItem('jmart_logs')) || [];
            
            renderItems(); 
            updateStats(); 
            renderLogs();
            updateCartUI();
            updateItemSelectDropdown();
            loadStockTable();
            
            showNotification('üì± Local data loaded', 'info');
        });
    };

    // Handle beforeunload to clean up
    window.addEventListener('beforeunload', () => {
        if (scanner) {
            stopScanner();
        }
        if (game.gameLoopId) {
            cancelAnimationFrame(game.gameLoopId);
        }
    });

    // Handle window resize for responsive design
    window.addEventListener('resize', () => {
        // Re-render items to adjust grid
        renderItems();
        // Resize game canvas if game is active
        if (game.canvas && document.getElementById('view-game').style.display !== 'none') {
            resizeGameCanvas();
        }
    });
    // -------------------------------------------------------------------------
// ‡∂¥‡∑ê‡∂ª‡∂´‡∑í ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂±‡∑Ä ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫‡∂ß ‡∑Ñ‡∑ê‡∂©‡∂ú‡∑ê‡∑É‡∑ä‡∑Ä‡∑ì‡∂∏
// -------------------------------------------------------------------------

/**
 * ‡∂¥‡∑ê‡∂ª‡∂´‡∑í logs ‡∑Ä‡∂Ω ‡∂á‡∂≠‡∑í ‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä ‡∂Ø‡∂≠‡∑ä‡∂≠ sales array ‡∂ë‡∂ö‡∂ß ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂∫‡∑í
 */
function migrateOldSalesFromLogs() {
    console.log("üìä ‡∂¥‡∑ê‡∂ª‡∂´‡∑í logs ‡∑Ä‡∂Ω‡∑í‡∂±‡∑ä ‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂Ω‡∂∂‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏...");
    
    let migratedCount = 0;
    let skippedCount = 0;
    
    // logs array ‡∂ë‡∂ö ‡∑Ñ‡∂ª‡∑í‡∂∫‡∂ß ‡∂á‡∂≠‡∑í‡∂Ø‡∑ê‡∂∫‡∑í ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    if (!logs || !Array.isArray(logs)) {
        console.error("Logs array not found or invalid");
        return 0;
    }
    
    // sales array ‡∂ë‡∂ö ‡∑Ñ‡∂ª‡∑í‡∂∫‡∂ß ‡∂á‡∂≠‡∑í‡∂Ø‡∑ê‡∂∫‡∑í ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    if (!sales || !Array.isArray(sales)) {
        console.error("Sales array not found or invalid");
        sales = [];
    }
    
    // ‡∂¥‡∑ê‡∂ª‡∂´‡∑í logs ‡∑Ä‡∂Ω‡∑í‡∂±‡∑ä sale type ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂á‡∂≠‡∑í entries ‡∂ú‡∑ô‡∂± ‡∂í‡∑Ä‡∑è sales ‡∂ë‡∂ö‡∂ß ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    logs.forEach((log, index) => {
        // ‡∂¥‡∑ê‡∂ª‡∂´‡∑í sale log ‡∂ë‡∂ö‡∂ö‡∑ä ‡∑Ñ‡∂Ø‡∑î‡∂±‡∑è ‡∂ú‡∂±‡∑ä‡∂±
        if (log && log.type === 'sale' && log.data) {
            // ‡∂∏‡∑ô‡∂∏ sale ‡∂Ø‡∑ê‡∂±‡∂ß‡∂∏‡∂≠‡∑ä sales array ‡∂ë‡∂ö‡∑ö ‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑Ä‡∑è‡∂Ø‡∑ê‡∂∫‡∑í ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
            const existingSale = sales.find(s => s.id === log.data.id || 
                (s.date === log.data.date && s.total === log.data.total));
            
            if (!existingSale) {
                // ‡∂±‡∑Ä sale object ‡∂ë‡∂ö‡∂ö‡∑ä ‡∑É‡∑è‡∂Ø‡∂±‡∑ä‡∂±
                const saleData = log.data;
                
                // ‡∂Ö‡∂±‡∑í‡∑Ä‡∑è‡∂ª‡∑ä‡∂∫‡∂∫ fields ‡∑É‡∑Ñ‡∑í‡∂≠ sale object ‡∂ë‡∂ö‡∂ö‡∑ä ‡∑É‡∑è‡∂Ø‡∂±‡∑ä‡∂±
                const newSale = {
                    id: saleData.id || 'LOG_' + log.id,
                    total: saleData.total || 0,
                    subtotal: saleData.subtotal || saleData.total || 0,
                    discount: saleData.discount || 0,
                    profit: saleData.profit || 0,
                    date: saleData.date || log.date || new Date().toLocaleDateString(),
                    time: saleData.time || log.time || new Date().toLocaleTimeString(),
                    timestamp: saleData.timestamp || log.id || Date.now(),
                    month: saleData.month !== undefined ? saleData.month : getMonthFromDate(saleData.date || log.date),
                    itemsCount: saleData.itemsCount || (saleData.items ? saleData.items.length : 0),
                    items: saleData.items || [],
                    customer: saleData.customer || null,
                    syncId: saleData.syncId || syncId || 'migrated_from_logs'
                };
                
                // Profit ‡∂ú‡∂´‡∂±‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (‡∂±‡∑ê‡∂≠‡∑ä‡∂±‡∂∏‡∑ä)
                if (newSale.profit === 0 && newSale.items && newSale.items.length > 0) {
                    const totalCost = newSale.items.reduce((sum, item) => {
                        const itemCost = item.cost || 0;
                        const itemWeight = item.weight || item.qty || 1;
                        return sum + (itemCost * itemWeight);
                    }, 0);
                    newSale.profit = newSale.total - totalCost;
                }
                
                // Sales array ‡∂ë‡∂ö‡∂ß ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
                sales.push(newSale);
                migratedCount++;
                
                console.log(`‚úÖ Log migrated: ${newSale.date} ${newSale.time} - Rs ${newSale.total.toFixed(2)}`);
            } else {
                skippedCount++;
            }
        }
    });
    
    console.log(`üìà ${migratedCount} sales migrated from logs, ${skippedCount} already existed`);
    
    if (migratedCount > 0) {
        // ‡∂±‡∑Ä ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑É‡∑î‡∂ª‡∂ö‡∑ä‡∑Ç‡∑í‡∂≠ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
        saveToBothStorage();
        
        // UI ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
        updateStats();
        
        // ‡∂¥‡∑ä‚Äç‡∂ª‡∂Ø‡∂ª‡∑ä‡∑Å‡∂± ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫‡∂ö‡∑ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂±
        setTimeout(() => {
            showNotification(`‡∂¥‡∑ê‡∂ª‡∂´‡∑í ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ${migratedCount}‡∂ö‡∑ä sales ‡∂Ω‡∑ô‡∑É ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì`, 'success');
        }, 1000);
    }
    
    return migratedCount;
}

/**
 * date string ‡∂ë‡∂ö‡∂ö‡∑í‡∂±‡∑ä month ‡∂ë‡∂ö ‡∂Ω‡∂∂‡∑è ‡∂ú‡∂±‡∑ä‡∂±
 */
function getMonthFromDate(dateString) {
    if (!dateString) return new Date().getMonth();
    
    try {
        // ‡∑Ä‡∑í‡∑Ä‡∑í‡∂∞ date format ‡∑Ä‡∂Ω‡∂ß support ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±
        let dateObj;
        
        if (dateString.includes('/')) {
            // Format: DD/MM/YYYY ‡∑Ñ‡∑ù MM/DD/YYYY
            const parts = dateString.split('/');
            if (parts.length >= 2) {
                // ‡∂∂‡∑ú‡∑Ñ‡∑ù‡∑Ä‡∑í‡∂ß DD/MM/YYYY format ‡∂ë‡∂ö
                const monthPart = parts[1];
                const month = parseInt(monthPart);
                
                if (!isNaN(month) && month >= 1 && month <= 12) {
                    return month - 1; // 0-11 ‡∂Ω‡∑ô‡∑É
                }
            }
        } else if (dateString.includes('-')) {
            // Format: YYYY-MM-DD
            dateObj = new Date(dateString);
            if (!isNaN(dateObj.getTime())) {
                return dateObj.getMonth();
            }
        }
        
        // ‡∂Ö‡∂±‡∑ô‡∂ö‡∑î‡∂≠‡∑ä format ‡∑Ä‡∂Ω‡∂ß
        dateObj = new Date(dateString);
        if (!isNaN(dateObj.getTime())) {
            return dateObj.getMonth();
        }
    } catch (e) {
        console.error("Error parsing date:", dateString, e);
    }
    
    // ‡∂ö‡∑í‡∑É‡∑í‡∂Ø‡∑î ‡∂Ü‡∂ö‡∑è‡∂ª‡∂∫‡∂ö‡∑í‡∂±‡∑ä parse ‡∂ö‡∂ª‡∂ú‡∂≠ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö‡∑í ‡∂±‡∂∏‡∑ä ‡∑Ä‡∂ª‡∑ä‡∂≠‡∂∏‡∂±‡∑ä ‡∂∏‡∑è‡∑É‡∂∫ ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    return new Date().getMonth();
}

/**
 * ‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ ‡∂¥‡∑ê‡∂ª‡∂´‡∑í ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑Ñ‡∑ê‡∂©‡∂ú‡∑ê‡∑É‡∑ä‡∑Ä‡∑ì‡∂∏ (logs ‡∑É‡∑Ñ sales)
 */
function migrateAllOldData() {
    console.log("üîÑ ‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ ‡∂¥‡∑ê‡∂ª‡∂´‡∑í ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑Ñ‡∑ê‡∂©‡∂ú‡∑ê‡∑É‡∑ä‡∑Ä‡∂∏‡∑í‡∂±‡∑ä...");
    
    let totalMigrated = 0;
    
    // 1. ‡∂¥‡∑ê‡∂ª‡∂´‡∑í logs ‡∑Ä‡∂Ω‡∑í‡∂±‡∑ä sales ‡∂Ω‡∂∂‡∑è ‡∂ú‡∂±‡∑ä‡∂±
    const logsMigrated = migrateOldSalesFromLogs();
    totalMigrated += logsMigrated;
    
    // 2. ‡∂¥‡∑ê‡∂ª‡∂´‡∑í sales array ‡∂ë‡∂ö ‡∂±‡∑Ä format ‡∂ë‡∂ö‡∂ß ‡∑Ñ‡∑ê‡∂©‡∂ú‡∑É‡∑ä‡∑É‡∂±‡∑ä‡∂±
    const salesMigrated = migrateExistingSales();
    totalMigrated += salesMigrated;
    
    // 3. Update statistics
    updateStats();
    
    // 4. ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑É‡∑î‡∂ª‡∂ö‡∑ä‡∑Ç‡∑í‡∂≠ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    saveToBothStorage();
    
    console.log(`‚úÖ ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´‡∂∫‡∑ô‡∂±‡∑ä ${totalMigrated} sales ‡∑Ñ‡∑ê‡∂©‡∂ú‡∑É‡∑ä‡∑Ä‡∂± ‡∂Ω‡∂Ø‡∑ì`);
    
    if (totalMigrated > 0) {
        showNotification(`‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´‡∂∫‡∑ô‡∂±‡∑ä ${totalMigrated} ‡∂¥‡∑ê‡∂ª‡∂´‡∑í ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ‡∂±‡∑Ä ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫‡∂ß ‡∑Ñ‡∑ê‡∂©‡∂ú‡∑É‡∑ä‡∑Ä‡∂± ‡∂Ω‡∂Ø‡∑ì`, 'success');
        
        // Reports ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä refresh ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
        if (document.getElementById('view-reports').style.display !== 'none') {
            setTimeout(() => {
                updateStats();
            }, 500);
        }
    }
    
    return totalMigrated;
}

/**
 * ‡∂¥‡∑ê‡∑Ä‡∂≠‡∑í sales array ‡∂ë‡∂ö ‡∂±‡∑Ä format ‡∂ë‡∂ö‡∂ß ‡∑Ñ‡∑ê‡∂©‡∂ú‡∑É‡∑ä‡∑É‡∂±‡∑ä‡∂±
 */
function migrateExistingSales() {
    if (!sales || !Array.isArray(sales)) {
        console.error("Sales array not found");
        return 0;
    }
    
    let migratedCount = 0;
    
    sales.forEach((sale, index) => {
        if (!sale || typeof sale !== 'object') {
            // ‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂±‡∑ú‡∑Ä‡∂± sale object ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂±‡∑Ä object ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ω‡∑ô‡∑É ‡∑É‡∂ö‡∑É‡∂±‡∑ä‡∂±
            sales[index] = {
                id: 'FIXED_' + Date.now() + '_' + index,
                total: 0,
                subtotal: 0,
                discount: 0,
                profit: 0,
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                timestamp: Date.now() - (sales.length - index) * 86400000,
                month: new Date().getMonth(),
                itemsCount: 0,
                items: [],
                syncId: syncId
            };
            migratedCount++;
            return;
        }
        
        // ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ fields ‡∑É‡∑í‡∂∫‡∂Ω‡∑ä‡∂Ω ‡∂á‡∂≠‡∑ä‡∂Ø‡∑ê‡∂∫‡∑í ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
        let needsMigration = false;
        
        // 1. id field ‡∂ë‡∂ö
        if (!sale.id) {
            sale.id = 'SALE_' + (sale.timestamp || Date.now()) + '_' + index;
            needsMigration = true;
        }
        
        // 2. month field ‡∂ë‡∂ö
        if (sale.month === undefined || sale.month === null || isNaN(sale.month)) {
            sale.month = getMonthFromDate(sale.date);
            needsMigration = true;
        }
        
        // 3. profit field ‡∂ë‡∂ö
        if (sale.profit === undefined || sale.profit === null || isNaN(sale.profit)) {
            // Profit ‡∂ú‡∂´‡∂±‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
            if (sale.items && sale.items.length > 0) {
                const totalCost = sale.items.reduce((sum, item) => {
                    const itemCost = item.cost || 0;
                    const itemWeight = item.weight || item.qty || 1;
                    return sum + (itemCost * itemWeight);
                }, 0);
                sale.profit = (sale.total || sale.subtotal || 0) - totalCost;
            } else {
                sale.profit = (sale.total || sale.subtotal || 0) * 0.3; // 30% ‡∂Ω‡∑è‡∂∑‡∂∫ ‡∂Ω‡∑ô‡∑É ‡∂Ö‡∂±‡∑î‡∂∏‡∑è‡∂± ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
            }
            needsMigration = true;
        }
        
        // 4. timestamp field ‡∂ë‡∂ö
        if (!sale.timestamp || typeof sale.timestamp !== 'number') {
            sale.timestamp = Date.now() - (sales.length - index) * 86400000;
            needsMigration = true;
        }
        
        // 5. syncId field ‡∂ë‡∂ö
        if (!sale.syncId) {
            sale.syncId = syncId;
            needsMigration = true;
        }
        
        // 6. itemsCount field ‡∂ë‡∂ö
        if (!sale.itemsCount && sale.items) {
            sale.itemsCount = sale.items.length;
            needsMigration = true;
        }
        
        // 7. subtotal field ‡∂ë‡∂ö
        if (!sale.subtotal && sale.total) {
            sale.subtotal = sale.total;
            needsMigration = true;
        }
        
        if (needsMigration) {
            migratedCount++;
        }
    });
    
    console.log(`‚úÖ ${migratedCount} existing sales migrated to new format`);
    return migratedCount;
}

/**
 * ‡∂¥‡∑ê‡∂ª‡∂´‡∑í ‡∂Ø‡∂≠‡∑ä‡∂≠ migration button ‡∂ë‡∂ö‡∂ö‡∑ä reports ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä‡∂ß ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
 */
function addMigrationButtonToReports() {
    // Reports ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä‡∑ö ‡∂á‡∂≠‡∑í ‡∂∂‡∑Ä ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    const reportsView = document.getElementById('view-reports');
    if (!reportsView) return;
    
    // ‡∂Ø‡∑ê‡∂±‡∂ß‡∂∏‡∂≠‡∑ä button ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂≠‡∑í‡∂∂‡∑ö‡∂Ø‡∑ê‡∂∫‡∑í ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    if (document.getElementById('migrateOldDataBtn')) return;
    
    // Button ‡∂ë‡∂ö ‡∑É‡∑è‡∂Ø‡∂±‡∑ä‡∂±
    const migrateBtn = document.createElement('button');
    migrateBtn.id = 'migrateOldDataBtn';
    migrateBtn.innerHTML = 'üîÑ ‡∂¥‡∑ê‡∂ª‡∂´‡∑í ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ‡∂±‡∑Ä ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫‡∂ß ‡∑Ñ‡∑ê‡∂©‡∂ú‡∑É‡∑ä‡∑É‡∂±‡∑ä‡∂±';
    migrateBtn.style.cssText = `
        background: var(--orange);
        color: black;
        border: none;
        padding: 12px 20px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        margin: 15px auto;
        display: block;
        width: 90%;
        max-width: 300px;
        transition: all 0.3s;
    `;
    
    // Hover effect
    migrateBtn.onmouseover = function() {
        this.style.transform = 'translateY(-2px)';
        this.style.boxShadow = '0 5px 15px rgba(255, 159, 67, 0.3)';
    };
    
    migrateBtn.onmouseout = function() {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = 'none';
    };
    
    // Click event
    migrateBtn.onclick = function() {
        if (confirm('‡∂¥‡∑ê‡∂ª‡∂´‡∑í ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑É‡∑í‡∂∫‡∂Ω‡∑ä‡∂Ω ‡∂±‡∑Ä ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫‡∂ß ‡∑Ñ‡∑ê‡∂©‡∂ú‡∑É‡∑ä‡∑É‡∂±‡∑ä‡∂±‡∂Ø?\n\n‡∂∏‡∑ô‡∂∏ ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂Ü‡∂¥‡∑É‡∑î ‡∑Ñ‡∑ê‡∂ª‡∑Ä‡∑í‡∂∫ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö.')) {
            const migrated = migrateAllOldData();
            if (migrated > 0) {
                this.innerHTML = '‚úÖ ‡∑Ñ‡∑ê‡∂©‡∂ú‡∑É‡∑ä‡∑Ä‡∑è ‡∂ú‡∂±‡∑ä‡∂±‡∑è ‡∂Ω‡∂Ø‡∑ì!';
                this.style.background = 'var(--neon-green)';
                this.disabled = true;
                
                // ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä refresh ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }
        }
    };
    
    // Reports ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä‡∑ö privacy wrapper ‡∂ë‡∂ö‡∂ß ‡∂¥‡∑É‡∑î‡∑Ä button ‡∂ë‡∂ö ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    const reportWrapper = document.getElementById('reportPrivacyWrapper');
    if (reportWrapper && reportWrapper.parentNode) {
        reportWrapper.parentNode.insertBefore(migrateBtn, reportWrapper.nextSibling);
    }
}

/**
 * ‡∂Ø‡∂≠‡∑ä‡∂≠ migration status ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
 */
function checkMigrationStatus() {
    console.log("üîç ‡∂Ø‡∂≠‡∑ä‡∂≠ migration status ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä...");
    
    if (!sales || !Array.isArray(sales)) {
        console.error("Sales array not found");
        return;
    }
    
    // 1. ‡∂¥‡∑ê‡∂ª‡∂´‡∑í sales ‡∑Ä‡∂Ω‡∑í‡∂±‡∑ä month field ‡∂ë‡∂ö ‡∂±‡∑ê‡∂≠‡∑í ‡∂í‡∑Ä‡∑è ‡∂ú‡∂´‡∂±‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    const salesWithoutMonth = sales.filter(s => s.month === undefined || s.month === null || isNaN(s.month)).length;
    const salesWithoutProfit = sales.filter(s => s.profit === undefined || s.profit === null || isNaN(s.profit)).length;
    const salesWithoutId = sales.filter(s => !s.id).length;
    
    console.log(`Sales without month field: ${salesWithoutMonth}/${sales.length}`);
    console.log(`Sales without profit field: ${salesWithoutProfit}/${sales.length}`);
    console.log(`Sales without ID: ${salesWithoutId}/${sales.length}`);
    
    // 2. logs ‡∑Ä‡∂Ω‡∑í‡∂±‡∑ä migration ‡∂ö‡∑Ö ‡∑Ñ‡∑ê‡∂ö‡∑í sales ‡∂ú‡∂´‡∂±
    const migratableLogs = logs ? logs.filter(l => l.type === 'sale' && l.data).length : 0;
    console.log(`Migratable sales in logs: ${migratableLogs}`);
    
    // 3. ‡∂∏‡∑è‡∑É ‡∂Ö‡∂±‡∑î‡∑Ä sales ‡∂ú‡∂´‡∂±
    const salesByMonth = {};
    sales.forEach(sale => {
        const month = (sale.month !== undefined && !isNaN(sale.month)) ? 
                     parseInt(sale.month) : new Date().getMonth();
        
        if (month < 0 || month > 11) return;
        
        if (!salesByMonth[month]) {
            salesByMonth[month] = { count: 0, profit: 0, revenue: 0 };
        }
        
        salesByMonth[month].count++;
        salesByMonth[month].profit += parseFloat(sale.profit) || 0;
        salesByMonth[month].revenue += parseFloat(sale.total) || parseFloat(sale.subtotal) || 0;
    });
    
    console.log("Sales distribution by month:");
    Object.keys(salesByMonth).sort((a,b) => parseInt(a)-parseInt(b)).forEach(month => {
        const monthInt = parseInt(month);
        console.log(`  Month ${monthInt+1}: ${salesByMonth[month].count} sales, 
                     Revenue: Rs ${salesByMonth[month].revenue.toFixed(2)}, 
                     Profit: Rs ${salesByMonth[month].profit.toFixed(2)}`);
    });
    
    // Migration ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂Ø‡∑ê‡∂∫‡∑í ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    const needsMigration = salesWithoutMonth > 0 || salesWithoutProfit > 0 || migratableLogs > 0;
    
    if (needsMigration) {
        console.log("‚ö†Ô∏è ‡∂Ø‡∂≠‡∑ä‡∂≠ migration ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂∫‡∑í!");
        
        // Reports ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä‡∂ß migration button ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
        setTimeout(addMigrationButtonToReports, 1000);
        
        // ‡∂¥‡∑Ö‡∂∏‡∑î‡∑Ä ‡∂á‡∂≠‡∑î‡∂Ω‡∑ä ‡∑Ä‡∑ñ ‡∑Ä‡∑í‡∂ß auto-migration ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö ‡∂Ö‡∑Ä‡∑É‡∂ª‡∂∫‡∑ô‡∂±‡∑ä)
        if (!localStorage.getItem('jmart_auto_migrated')) {
            setTimeout(() => {
                if (confirm('‡∂¥‡∑ê‡∂ª‡∂´‡∑í ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑Ñ‡∂∏‡∑î‡∑Ä‡∑ì ‡∂á‡∂≠. ‡∂±‡∑Ä ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫‡∂ß ‡∑É‡∑ä‡∑Ä‡∂∫‡∂Ç‡∂ö‡∑ä‚Äç‡∂ª‡∑ì‡∂∫‡∑Ä ‡∑Ñ‡∑ê‡∂©‡∂ú‡∑É‡∑ä‡∑É‡∂±‡∑ä‡∂±‡∂Ø?')) {
                    migrateAllOldData();
                    localStorage.setItem('jmart_auto_migrated', 'true');
                }
            }, 2000);
        }
    } else {
        console.log("‚úÖ ‡∂Ø‡∂≠‡∑ä‡∂≠ migration ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∂±‡∑ê‡∂≠");
    }
    
    return needsMigration;
}

// -------------------------------------------------------------------------
// Initialize migration system
// -------------------------------------------------------------------------

// ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä load ‡∑Ä‡∑ñ ‡∂¥‡∑É‡∑î migration system initialize ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
setTimeout(() => {
    // 1. ‡∂Ø‡∂≠‡∑ä‡∂≠ migration status ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    checkMigrationStatus();
    
    // 2. ‡∂¥‡∑ê‡∂ª‡∂´‡∑í ‡∂Ø‡∂≠‡∑ä‡∂≠ auto-migrate ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö ‡∂Ö‡∑Ä‡∑É‡∂ª‡∂∫‡∑ô‡∂±‡∑ä)
    if (!localStorage.getItem('jmart_auto_migrated')) {
        console.log("üîÑ ‡∂¥‡∑ê‡∂ª‡∂´‡∑í ‡∂Ø‡∂≠‡∑ä‡∂≠ auto-migration ‡∑É‡∂ö‡∑É‡∑ä ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä...");
        
        // ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂ß ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫‡∂ö‡∑ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂±
        setTimeout(() => {
            if (sales.length > 0 || (logs && logs.length > 0)) {
                showNotification('‡∂¥‡∑ê‡∂ª‡∂´‡∑í ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑Ñ‡∂∏‡∑î‡∑Ä‡∑ì ‡∂á‡∂≠. "P&L REPORTS" ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä‡∑ö migration button ‡∂ë‡∂ö ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.', 'info', 5000);
            }
        }, 3000);
    }
}, 2000);

// -------------------------------------------------------------------------
// Extended updateStats function to show migrated data
// -------------------------------------------------------------------------
const originalUpdateStats = updateStats;
updateStats = function() {
    // ‡∂∏‡∑î‡∂Ω‡∑ä function ‡∂ë‡∂ö ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    originalUpdateStats.call(this);
    
    // Migration status ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂± (debugging ‡∑É‡∂≥‡∑Ñ‡∑è)
    if (sales && sales.length > 0) {
        const salesWithMonth = sales.filter(s => s.month !== undefined && !isNaN(s.month)).length;
        const salesWithProfit = sales.filter(s => s.profit !== undefined && !isNaN(s.profit)).length;
        
        // Console ‡∂ë‡∂ö‡∑ö ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂±
        console.log(`üìä Migration Status: ${salesWithMonth}/${sales.length} sales with month, ${salesWithProfit}/${sales.length} sales with profit`);
        
        // Reports ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä‡∑ö ‡∂Ö‡∂∏‡∂≠‡∂ª ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂±
        if (document.getElementById('view-reports').style.display !== 'none') {
            const summaryText = document.getElementById('summaryText');
            if (summaryText) {
                const originalHTML = summaryText.innerHTML;
                const migrationInfo = `<div style="font-size:11px; color:var(--text-dim); margin-top:10px;">
                    Data: ${sales.length} sales | Migrated: ${salesWithMonth} with month data
                </div>`;
                summaryText.innerHTML = originalHTML + migrationInfo;
            }
        }
    }
};

console.log("‚úÖ ‡∂¥‡∑ê‡∂ª‡∂´‡∑í ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ‡∂Ø‡∂≠‡∑ä‡∂≠ migration system ‡∑É‡∑ñ‡∂Ø‡∑è‡∂±‡∂∏‡∑ä");
</script>
</body>
</html>
