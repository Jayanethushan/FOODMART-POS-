<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>JAYANETH PRO MART | ADVANCED POS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    
    <!-- Firebase for Data Backup -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
    <!-- QR Scanner -->
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        :root {
            --bg-dark: #050608;
            --glass-bg: rgba(15, 18, 22, 0.85);
            --glass-border: rgba(255, 255, 255, 0.12);
            --neon-green: #8aff67;
            --neon-blue: #00f2ff;
            --danger: #ff4747;
            --orange: #ff9f43;
            --text-main: #ffffff;
            --text-dim: #94a3b8;
        }

        * { 
            box-sizing: border-box; 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            margin: 0; 
            min-height: 100vh; 
            background: radial-gradient(circle at 70% 20%, #0d1a0d, #050608); 
            color: var(--text-main); 
            display: flex; 
            flex-direction: column; 
            overflow-x: hidden;
            position: relative;
            touch-action: manipulation;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .desktop-only { display: none !important; }
            .mobile-only { display: flex !important; }
            
            header { padding: 10px 15px; flex-wrap: wrap; }
            .logo h1 { font-size: 18px; }
            .dashboard-stats { 
                gap: 5px; 
                margin-top: 10px; 
                width: 100%; 
                justify-content: space-between; 
                flex-wrap: wrap;
            }
            .mini-stat { 
                min-width: calc(50% - 5px) !important; 
                padding: 8px 10px; 
                margin-bottom: 5px;
            }
            .stat-val { font-size: 14px; }
            
            nav { 
                padding: 8px 10px; 
                overflow-x: auto; 
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            .nav-link { 
                padding: 8px 12px; 
                font-size: 12px; 
                flex-shrink: 0;
            }
            
            main { 
                flex-direction: column; 
                padding: 10px; 
                gap: 10px; 
                height: auto;
            }
            .left-col, .right-col { 
                width: 100%; 
                min-height: 300px;
            }
            .item-grid { 
                grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); 
                max-height: 50vh;
                gap: 8px;
            }
            
            .cart-row { 
                grid-template-columns: 1.5fr 0.8fr 1fr 1fr auto; 
                font-size: 12px; 
                gap: 5px;
                padding: 6px 0;
            }
            
            .btn-action { 
                padding: 14px; 
                font-size: 14px; 
                margin-top: 10px;
            }
            
            .game-container { 
                height: 60vh; 
                margin-bottom: 20px;
            }
            
            .touch-controls {
                display: flex !important;
            }
        }

        @media (min-width: 769px) {
            .mobile-only { display: none !important; }
            .desktop-only { display: flex !important; }
            
            main {
                height: calc(100vh - 130px);
            }
        }

        /* Glass Effect */
        .glass { 
            background: var(--glass-bg); 
            backdrop-filter: blur(25px); 
            border: 1px solid var(--glass-border); 
            border-radius: 18px; 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); 
        }
        
        .privacy-blur { 
            filter: blur(25px); 
            pointer-events: none; 
            transition: 0.5s; 
            opacity: 0.3; 
        }

        /* Header */
        header { 
            padding: 15px 30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: rgba(0,0,0,0.6); 
            border-bottom: 1px solid var(--glass-border); 
            z-index: 10; 
        }
        .logo h1 { 
            margin: 0; 
            font-size: 22px; 
            font-weight: 800; 
        }
        .logo span { 
            color: var(--neon-green); 
        }

        .dashboard-stats { 
            display: flex; 
            gap: 12px; 
        }
        .mini-stat { 
            padding: 8px 15px; 
            text-align: right; 
            min-width: 120px; 
        }
        .stat-label { 
            font-size: 9px; 
            color: var(--text-dim); 
            text-transform: uppercase; 
            font-weight: 800; 
        }
        .stat-val { 
            display: block; 
            font-family: 'JetBrains Mono'; 
            font-size: 15px; 
        }

        /* Navigation */
        nav { 
            display: flex; 
            gap: 10px; 
            padding: 12px 30px; 
            background: rgba(0,0,0,0.3); 
            z-index: 10; 
        }
        .nav-link { 
            background: var(--glass-bg); 
            border: 1px solid var(--glass-border); 
            color: white; 
            padding: 10px 20px; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 12px; 
            font-weight: 600; 
            transition: all 0.3s;
        }
        .nav-link:hover {
            background: rgba(138, 255, 103, 0.1);
        }
        .nav-link.active { 
            background: var(--neon-green); 
            color: black; 
            border-color: var(--neon-green); 
        }

        /* Main Layout */
        main { 
            flex: 1; 
            display: flex; 
            padding: 20px; 
            gap: 20px; 
            overflow: hidden; 
        }
        .left-col { 
            flex: 1.8; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
        }
        .right-col { 
            flex: 1.2; 
            display: flex; 
            flex-direction: column; 
        }

        /* Search & Inputs */
        .search-bar, select { 
            width: 100%; 
            padding: 12px 15px; 
            border-radius: 10px; 
            border: 1px solid var(--glass-border); 
            background: rgba(0,0,0,0.4); 
            color: white; 
            margin-bottom: 10px; 
            font-size: 14px;
        }
        
        /* Category Tabs */
        .category-tabs { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        .category-tab { 
            padding: 8px 16px; 
            border-radius: 8px; 
            background: rgba(255,255,255,0.05); 
            border: 1px solid var(--glass-border); 
            color: var(--text-dim); 
            cursor: pointer; 
            font-size: 12px; 
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
        }
        .category-tab:hover { 
            background: rgba(138, 255, 103, 0.1); 
            border-color: var(--neon-green); 
        }
        .category-tab.active { 
            background: var(--neon-green); 
            color: black; 
            border-color: var(--neon-green); 
        }
        
        .add-category-btn {
            background: var(--neon-blue);
            color: black;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        .add-category-btn:hover {
            background: #00d9e6;
            transform: scale(1.05);
        }

        /* Item Grid */
        .item-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); 
            gap: 10px; 
            overflow-y: auto; 
            padding-right: 5px;
            flex: 1;
        }
        .item-card { 
            padding: 15px 10px; 
            text-align: center; 
            cursor: pointer; 
            transition: 0.3s; 
            position: relative;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .item-card:hover { 
            border-color: var(--neon-green); 
            background: rgba(138, 255, 103, 0.05); 
            transform: translateY(-2px);
        }
        
        .stock-badge { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            font-size: 9px; 
            background: rgba(255,255,255,0.1); 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-family: 'JetBrains Mono';
        }
        
        /* Cart */
        .cart-table { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px; 
        }
        .cart-row { 
            display: grid; 
            grid-template-columns: 2fr 1fr 1fr 1fr auto; 
            gap: 5px; 
            padding: 8px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            font-size: 12px; 
            align-items: center;
        }
        
        /* Totals */
        .grand-total { 
            font-family: 'JetBrains Mono'; 
            font-size: 24px; 
            color: var(--neon-green); 
            font-weight: 800; 
        }
        .btn-action { 
            width: 100%; 
            padding: 15px; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 800; 
            margin-top: 10px; 
            transition: all 0.3s;
        }
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .btn-pay { 
            background: var(--neon-green); 
            color: black; 
        }
        .btn-pay:hover {
            background: #6bff3a;
        }

        /* Discount Row */
        .discount-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        .discount-input {
            width: 80px;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.05);
            color: white;
            text-align: center;
            font-family: 'JetBrains Mono';
        }
        .apply-discount-btn {
            padding: 8px 15px;
            border-radius: 8px;
            background: var(--orange);
            color: black;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        /* Modals */
        .modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.92); 
            z-index: 2000; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
            backdrop-filter: blur(10px); 
        }
        
        .glass-popup { 
            background: var(--glass-bg); 
            border: 1px solid var(--glass-border); 
            padding: 30px; 
            border-radius: 24px; 
            width: 100%; 
            max-width: 380px; 
            text-align: center; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
        }
        .popup-title { 
            font-size: 18px; 
            font-weight: 800; 
            margin-bottom: 10px; 
            color: var(--neon-blue); 
        }
        .popup-sub { 
            font-size: 12px; 
            color: var(--text-dim); 
            margin-bottom: 20px; 
        }
        .popup-input { 
            width: 100%; 
            padding: 15px; 
            border-radius: 12px; 
            border: 1px solid var(--glass-border); 
            background: rgba(255,255,255,0.05); 
            color: white; 
            font-size: 20px; 
            text-align: center; 
            font-family: 'JetBrains Mono'; 
            margin-bottom: 20px; 
            outline: none; 
        }
        .popup-btn-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
        }
        .btn-cancel { 
            background: rgba(255,255,255,0.1); 
            color: white; 
            border: none;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
        }
        
        /* Notification */
        .notification { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--neon-green); 
            color: black; 
            padding: 12px 20px; 
            border-radius: 10px; 
            font-weight: 600; 
            z-index: 3000; 
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
            max-width: 300px;
        }
        @keyframes slideIn { 
            from { transform: translateX(100%); opacity: 0; } 
            to { transform: translateX(0); opacity: 1; } 
        }
        @keyframes fadeOut { 
            from { opacity: 1; } 
            to { opacity: 0; } 
        }
        
        /* GAME STYLES - RESPONSIVE */
        .game-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .game-canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 300px;
        }
        
        #gameCanvas {
            width: 100%;
            height: 100%;
            background: rgba(5, 10, 15, 0.8);
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        /* Touch Controls for Mobile */
        .touch-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: none;
            justify-content: space-around;
            align-items: center;
            z-index: 50;
            padding: 0 20px;
        }
        
        .touch-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(138, 255, 103, 0.3);
            border: 2px solid var(--neon-green);
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            cursor: pointer;
        }
        
        .touch-btn:active {
            background: rgba(138, 255, 103, 0.6);
            transform: scale(0.95);
        }
        
        .game-controls {
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .game-stats {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .game-stat {
            background: rgba(255,255,255,0.05);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            min-width: 80px;
        }
        
        .game-stat-value {
            font-family: 'JetBrains Mono';
            font-size: 16px;
            color: var(--neon-green);
            display: block;
        }
        
        .game-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .game-btn {
            background: var(--neon-blue);
            color: black;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: 0.3s;
            flex-shrink: 0;
        }
        
        .game-btn:hover {
            background: var(--neon-green);
            transform: scale(1.05);
        }
        
        .game-btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 20px;
            text-align: center;
        }
        
        .game-over-title {
            font-size: 24px;
            color: var(--danger);
            margin-bottom: 10px;
            font-weight: 800;
        }
        
        .game-over-score {
            font-size: 20px;
            color: var(--neon-green);
            margin-bottom: 20px;
            font-family: 'JetBrains Mono';
        }
        
        .game-instructions {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 12px;
            color: var(--text-dim);
        }
        
        .game-instructions h4 {
            margin: 0 0 8px 0;
            color: var(--neon-blue);
        }
        
        .game-instructions ul {
            margin: 0;
            padding-left: 15px;
        }
        
        .game-instructions li {
            margin-bottom: 5px;
            font-size: 11px;
        }

        /* Add Category Modal */
        .add-category-modal {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 25px;
            border-radius: 20px;
            width: 90%;
            max-width: 350px;
        }
        
        .category-color-picker {
            display: flex;
            gap: 8px;
            margin: 15px 0;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.selected {
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top-color: var(--neon-green);
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--neon-green);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #6bff3a;
        }
    </style>
</head>
<body>

<!-- Loading Screen -->
<div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
    <div>Loading Jayaneth Pro Mart...</div>
    <div style="font-size: 12px; color: var(--text-dim); margin-top: 10px;" id="loadingText">Initializing System</div>
</div>

<header>
    <div class="logo"><h1>JAYANETH <span>PRO MART</span></h1></div>
    <div class="dashboard-stats">
        <div class="mini-stat glass"><span class="stat-label">Daily Revenue</span><span id="statRev" class="stat-val">Rs 0.00</span></div>
        <div class="mini-stat glass"><span class="stat-label">Daily Profit</span><span id="statProf" class="stat-val" style="color: var(--neon-green);">Rs 0.00</span></div>
        <button class="nav-link" id="lockBtn" onclick="handleLock()">üîì UNLOCKED</button>
    </div>
</header>

<nav>
    <button class="nav-link active" id="tab-pos" onclick="switchTab('pos')">POS</button>
    <button class="nav-link" id="tab-stock" onclick="switchTab('stock')">STOCK</button>
    <button class="nav-link" id="tab-reports" onclick="switchTab('reports')">REPORTS</button>
    <button class="nav-link" id="tab-game" onclick="switchTab('game')">üéÆ FRUIT CATCH</button>
</nav>

<!-- POS View -->
<div id="view-pos" style="display: contents;">
    <main>
        <div class="left-col">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" id="pSearch" class="search-bar" placeholder="üîç Search items..." oninput="renderItems()" style="flex: 1;">
                <button class="nav-link mobile-only" onclick="showScanner('pos')" style="min-width: 45px; padding: 12px; display: flex; align-items: center; justify-content: center;">üì∑</button>
                <button class="nav-link desktop-only" onclick="showScanner('pos')" style="min-width: 50px; padding: 12px; display: flex; align-items: center; justify-content: center;">üì∑ Scan</button>
            </div>
            
            <!-- Category Tabs -->
            <div class="category-tabs" id="categoryTabs">
                <!-- Categories will be loaded here -->
            </div>
            
            <div class="item-grid" id="itemGrid"></div>
        </div>
        
        <div class="right-col glass">
            <div style="padding: 15px; border-bottom: 1px solid var(--glass-border); font-weight: 800; display: flex; justify-content: space-between; align-items: center;">
                <span>BILLING</span>
                <button class="nav-link" onclick="showScanner('bill')" style="padding: 5px 10px; font-size: 11px;">üì∑ Scan Item</button>
            </div>
            <div class="cart-table" id="cartList"></div>
            
            <div style="padding: 10px 15px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--glass-border);">
                <div class="discount-row">
                    <span style="font-size: 12px; color: var(--text-dim);">Discount:</span>
                    <input type="number" id="discountInput" class="discount-input" placeholder="Rs" min="0">
                    <button class="apply-discount-btn" onclick="applyDiscount()">Apply</button>
                </div>
            </div>
            
            <div style="padding: 20px; background: rgba(0,0,0,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <span style="font-size: 12px; color: var(--text-dim);">SUBTOTAL</span>
                    <span id="subTotal" style="font-family: 'JetBrains Mono';">0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;" id="discountDisplay">
                    <span style="font-size: 12px; color: var(--danger);">DISCOUNT</span>
                    <span id="discountAmount" style="font-family: 'JetBrains Mono'; color: var(--danger);">0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 12px; color: var(--text-dim);">TOTAL</span>
                    <span id="grandTotal" class="grand-total">0.00</span>
                </div>
                <button class="btn-action btn-pay" onclick="completeSale()">COMPLETE SALE</button>
            </div>
        </div>
    </main>
</div>

<!-- Stock View -->
<div id="view-stock" style="display: none; padding: 20px; overflow-y: auto;">
    <div style="max-width: 1000px; margin: 0 auto;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="glass" style="padding: 20px;">
                <div style="font-weight: 800; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <span>STOCK UPDATE</span>
                    <button class="nav-link" onclick="showScanner('stock')" style="padding: 5px 10px; font-size: 11px;">üì∑ Scan</button>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <select id="stSelectName" class="search-bar" onchange="handleItemSelect()">
                        <option value="">-- Select item or add new --</option>
                    </select>
                </div>
                
                <input type="text" id="stName" placeholder="Item Name (if new)" class="search-bar">
                
                <div style="margin-bottom: 10px; display: flex; gap: 10px; align-items: center;">
                    <select id="stCat" class="search-bar" style="flex: 1;">
                        <!-- Categories loaded here -->
                    </select>
                    <button class="add-category-btn" onclick="showAddCategoryModal()" title="Add New Category">
                        +
                    </button>
                </div>
                
                <input type="number" id="stCost" placeholder="Cost Price (1kg)" class="search-bar">
                <input type="number" id="stPrice" placeholder="Selling Price (1kg)" class="search-bar">
                <input type="text" id="stEmoji" placeholder="Emoji (üçé)" class="search-bar" value="üçé">
                <input type="text" id="stBarcode" placeholder="Barcode (optional)" class="search-bar">
                <input type="number" id="stQty" placeholder="Weight (kg)" class="search-bar">
                
                <button class="btn-action btn-pay" onclick="processStock()" style="margin-top: 20px;">UPDATE STOCK</button>
            </div>
            
            <div class="glass" style="padding: 20px;">
                <div style="font-weight: 800; margin-bottom: 20px;">OTHER EXPENSES</div>
                <input type="text" id="expName" placeholder="Expense Reason" class="search-bar">
                <input type="number" id="expAmt" placeholder="Amount (Rs)" class="search-bar">
                <button class="btn-action" style="background:var(--orange); color:black;" onclick="addExpense()">ADD EXPENSE</button>
            </div>
        </div>
        
        <div class="glass" style="padding: 20px;">
            <div style="font-weight: 800; margin-bottom: 15px;">RECENT ACTIVITY</div>
            <div class="history-list" id="historyLog"></div>
        </div>
    </div>
</div>

<!-- Reports View -->
<div id="view-reports" style="display: none; padding: 20px; overflow-y: auto;">
    <div style="max-width: 1000px; margin: 0 auto;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div class="glass" style="padding:20px; text-align:center;">
                <span class="stat-label">Daily Revenue</span>
                <h2 id="rDayRev">0.00</h2>
            </div>
            <div class="glass" style="padding:20px; text-align:center;">
                <span class="stat-label">Daily Profit</span>
                <h2 id="rDayProf" style="color:var(--neon-green)">0.00</h2>
            </div>
            <div class="glass" style="padding:20px; text-align:center;">
                <span class="stat-label">Total Items</span>
                <h2 id="totalItems">0</h2>
            </div>
            <div class="glass" style="padding:20px; text-align:center;">
                <span class="stat-label">Today Sales</span>
                <h2 id="todaySales">0</h2>
            </div>
        </div>
        
        <div class="glass" style="padding: 20px; margin-bottom: 20px;">
            <h3 style="margin-bottom: 15px;">Today's Summary</h3>
            <div id="summaryText">No sales today</div>
        </div>
        
        <div class="glass" style="padding: 20px;">
            <h3 style="margin-bottom: 15px;">Recent Sales</h3>
            <div id="salesHistory"></div>
        </div>
    </div>
</div>

<!-- Game View -->
<div id="view-game" style="display: none; padding: 20px; overflow: hidden;">
    <div class="game-container glass">
        <div class="game-canvas-container">
            <canvas id="gameCanvas"></canvas>
            
            <!-- Touch Controls for Mobile -->
            <div class="touch-controls" id="touchControls">
                <button class="touch-btn" id="leftBtn">‚Üê</button>
                <button class="touch-btn" id="shootBtn">üí•</button>
                <button class="touch-btn" id="rightBtn">‚Üí</button>
            </div>
            
            <!-- Game Over Screen -->
            <div id="gameOverScreen" class="game-over-screen" style="display: none;">
                <div class="game-over-title" id="gameOverTitle">GAME OVER!</div>
                <div class="game-over-score">Score: <span id="finalScore">0</span></div>
                <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center;">
                    <button class="game-btn" onclick="restartGame()">PLAY AGAIN</button>
                    <button class="game-btn game-btn-danger" onclick="switchTab('pos')">BACK TO POS</button>
                </div>
            </div>
        </div>
        
        <div class="game-controls">
            <div class="game-stats">
                <div class="game-stat">
                    <div style="font-size: 10px; color: var(--text-dim);">SCORE</div>
                    <div id="gameScore" class="game-stat-value">0</div>
                </div>
                <div class="game-stat">
                    <div style="font-size: 10px; color: var(--text-dim);">LIVES</div>
                    <div id="gameLives" class="game-stat-value">3</div>
                </div>
                <div class="game-stat">
                    <div style="font-size: 10px; color: var(--text-dim);">TIME</div>
                    <div id="gameTime" class="game-stat-value">60</div>
                </div>
            </div>
            
            <div class="game-buttons">
                <button class="game-btn" onclick="startGame()" id="startBtn">START</button>
                <button class="game-btn" onclick="pauseGame()" id="pauseBtn">PAUSE</button>
                <button class="game-btn game-btn-danger" onclick="switchTab('pos')">EXIT</button>
            </div>
        </div>
        
        <div class="game-instructions">
            <h4>üéÆ HOW TO PLAY:</h4>
            <ul>
                <li><strong>‚Üê ‚Üí</strong> or <strong>A D</strong> keys to move basket</li>
                <li><strong>SPACE</strong> to shoot (on desktop)</li>
                <li>Catch falling fruits üçéüçåüçä for points</li>
                <li>Avoid bombs üí£ or lose a life</li>
                <li>Game ends when time runs out or lives reach 0</li>
            </ul>
        </div>
    </div>
</div>

<!-- Weight Modal -->
<div class="modal" id="weightModal">
    <div class="glass-popup">
        <div class="popup-title" id="weightTitle">ENTER WEIGHT</div>
        <div class="popup-sub" id="weightSub">Enter weight in kilograms</div>
        <input type="number" id="weightInput" class="popup-input" placeholder="0.000" step="0.001" onkeydown="if(event.key === 'Enter') confirmWeight()">
        <div class="popup-btn-grid">
            <button class="btn-action btn-cancel" onclick="closeModal('weightModal')">CANCEL</button>
            <button class="btn-action btn-pay" onclick="confirmWeight()">ADD TO CART</button>
        </div>
    </div>
</div>

<!-- Receipt Modal -->
<div class="modal" id="receiptModal">
    <div class="glass-popup">
        <div id="billArea" style="text-align: left; font-family: 'JetBrains Mono'; font-size: 13px; color: black; background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;"></div>
        <button class="btn-action btn-pay" onclick="closeModal('receiptModal')">OK</button>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal" id="addCategoryModal">
    <div class="add-category-modal">
        <div class="popup-title">ADD NEW CATEGORY</div>
        <div class="popup-sub">Create a new product category</div>
        
        <input type="text" id="newCategoryName" class="popup-input" placeholder="Category Name (e.g., Drinks)" style="font-size: 16px; margin-bottom: 15px;">
        
        <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 10px;">Select Color:</div>
        <div class="category-color-picker" id="colorPicker">
            <!-- Colors added dynamically -->
        </div>
        
        <input type="text" id="newCategoryEmoji" class="popup-input" placeholder="Category Emoji (e.g., ü•§)" style="font-size: 16px; margin-bottom: 20px;" value="üì¶">
        
        <div class="popup-btn-grid">
            <button class="btn-action btn-cancel" onclick="closeModal('addCategoryModal')">CANCEL</button>
            <button class="btn-action btn-pay" onclick="addNewCategory()">CREATE</button>
        </div>
    </div>
</div>

<!-- Scanner Modal -->
<div class="modal" id="scannerModal">
    <div class="glass-popup">
        <div class="popup-title">SCAN QR/BARCODE</div>
        <div class="popup-sub">Point camera at code</div>
        <div id="scanner-container" style="width:100%; height:300px; margin:20px 0; background:rgba(0,0,0,0.3); border-radius:10px; display:flex; align-items:center; justify-content:center;">
            <div id="scanner-placeholder" style="text-align:center;">
                <div style="font-size:50px;">üì∑</div>
                <div>Click Start Scanner</div>
            </div>
        </div>
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
            <button class="btn-action btn-pay" onclick="startScanner()" style="padding: 10px 20px;">Start Scanner</button>
            <button class="btn-action btn-cancel" onclick="closeModal('scannerModal')" style="padding: 10px 20px;">Close</button>
        </div>
    </div>
</div>

<!-- Restore Data Modal -->
<div class="modal" id="restoreModal">
    <div class="glass-popup">
        <div class="popup-title">RESTORE CLOUD DATA</div>
        <div class="popup-sub">Restore your previous data from cloud backup</div>
        <div id="restoreStatus" style="margin: 20px 0; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px; font-size: 14px;">
            Checking for cloud backup...
        </div>
        <div class="popup-btn-grid">
            <button class="btn-action btn-cancel" onclick="closeModal('restoreModal')">CANCEL</button>
            <button class="btn-action btn-pay" onclick="restoreCloudData()">RESTORE</button>
        </div>
    </div>
</div>

<script>
    // -------------------------------------------------------------------------
    // FIREBASE CONFIGURATION
    // -------------------------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyAdw73seKGjO0VLFZuMj9gJaiSmnpc3N0M",
        authDomain: "pos-system-dc0e0.firebaseapp.com",
        databaseURL: "https://pos-system-dc0e0-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "pos-system-dc0e0",
        storageBucket: "pos-system-dc0e0.firebasestorage.app",
        messagingSenderId: "251115370846",
        appId: "1:251115370846:web:f7cfe5b3f38f71d67077cf",
        measurementId: "G-CGRK6HPBLX"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // -------------------------------------------------------------------------
    // GLOBAL VARIABLES
    // -------------------------------------------------------------------------
    let db = [];
    let sales = [];
    let expenses = [];
    let wastage = [];
    let logs = [];
    let categories = [];
    let cart = [];
    let currentDiscount = 0;
    let isLocked = false;
    let tempItem = null;
    let scanner = null;
    let currentScannerMode = 'pos';
    let selectedCategory = 'all';
    let isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    
    // Game Variables
    let game = {
        canvas: null,
        ctx: null,
        basket: { x: 300, y: 400, width: 100, height: 30 },
        fruits: [],
        bombs: [],
        score: 0,
        lives: 3,
        time: 60,
        isRunning: false,
        isPaused: false,
        lastTime: 0,
        keys: {},
        gameLoopId: null,
        fruitSpeed: 2,
        bombSpeed: 3
    };

    // -------------------------------------------------------------------------
    // INITIALIZATION
    // -------------------------------------------------------------------------
    
    async function initializeSystem() {
        updateLoadingText('Loading system...');
        
        // Try to load from localStorage first
        loadLocalData();
        
        // Check for cloud backup
        setTimeout(async () => {
            const hasCloudData = await checkCloudBackup();
            if (hasCloudData) {
                showNotification('Cloud backup available! Click Restore in Reports tab.', 'info');
            }
        }, 1000);
        
        // Initialize categories
        initCategories();
        
        // Render initial views
        renderItems();
        updateCartUI();
        updateStats();
        renderLogs();
        
        // Hide loading screen
        setTimeout(() => {
            document.getElementById('loadingScreen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                showNotification('Jayaneth Pro Mart POS Ready!');
            }, 500);
        }, 1500);
    }
    
    function updateLoadingText(text) {
        const loadingText = document.getElementById('loadingText');
        if (loadingText) loadingText.textContent = text;
    }
    
    function loadLocalData() {
        db = JSON.parse(localStorage.getItem('jmart_db')) || [];
        sales = JSON.parse(localStorage.getItem('jmart_sales')) || [];
        expenses = JSON.parse(localStorage.getItem('jmart_exp')) || [];
        wastage = JSON.parse(localStorage.getItem('jmart_waste')) || [];
        logs = JSON.parse(localStorage.getItem('jmart_logs')) || [];
        categories = JSON.parse(localStorage.getItem('jmart_categories')) || [];
        
        // If no categories, create default ones
        if (categories.length === 0) {
            categories = [
                { id: 1, name: "‡∂¥‡∂Ω‡∂≠‡∑î‡∂ª‡∑î", emoji: "üçé", color: "#ff6b6b", active: true },
                { id: 2, name: "‡∂ë‡∂Ω‡∑Ä‡∂Ω‡∑î", emoji: "ü•¶", color: "#51cf66", active: true },
                { id: 3, name: "‡∂∂‡∂©‡∑î‡∂¥‡∂ß‡∑ä‡∂ß‡∂∏", emoji: "üì¶", color: "#339af0", active: true }
            ];
            localStorage.setItem('jmart_categories', JSON.stringify(categories));
        }
    }
    
    function saveAllData() {
        localStorage.setItem('jmart_db', JSON.stringify(db));
        localStorage.setItem('jmart_sales', JSON.stringify(sales));
        localStorage.setItem('jmart_exp', JSON.stringify(expenses));
        localStorage.setItem('jmart_waste', JSON.stringify(wastage));
        localStorage.setItem('jmart_logs', JSON.stringify(logs));
        localStorage.setItem('jmart_categories', JSON.stringify(categories));
        
        // Cloud backup
        database.ref('pos_data').set({
            db, sales, expenses, wastage, logs, categories,
            timestamp: Date.now(),
            lastUpdate: new Date().toLocaleString()
        });
    }
    
    // -------------------------------------------------------------------------
    // CATEGORY MANAGEMENT
    // -------------------------------------------------------------------------
    
    function initCategories() {
        renderCategoryTabs();
        populateCategoryDropdown();
    }
    
    function renderCategoryTabs() {
        const tabsContainer = document.getElementById('categoryTabs');
        tabsContainer.innerHTML = '';
        
        // All items tab
        const allTab = document.createElement('div');
        allTab.className = `category-tab ${selectedCategory === 'all' ? 'active' : ''}`;
        allTab.innerHTML = 'üì¶ All Items';
        allTab.onclick = () => {
            selectedCategory = 'all';
            renderCategoryTabs();
            renderItems();
        };
        tabsContainer.appendChild(allTab);
        
        // Active category tabs
        categories.forEach(cat => {
            if (cat.active) {
                const tab = document.createElement('div');
                tab.className = `category-tab ${selectedCategory === cat.name ? 'active' : ''}`;
                tab.style.borderColor = cat.color;
                tab.innerHTML = `${cat.emoji} ${cat.name}`;
                tab.onclick = () => {
                    selectedCategory = cat.name;
                    renderCategoryTabs();
                    renderItems();
                };
                tabsContainer.appendChild(tab);
            }
        });
        
        // Add category button
        const addBtn = document.createElement('button');
        addBtn.className = 'add-category-btn';
        addBtn.innerHTML = '+ Add';
        addBtn.onclick = showAddCategoryModal;
        addBtn.title = 'Add New Category';
        tabsContainer.appendChild(addBtn);
    }
    
    function populateCategoryDropdown() {
        const dropdown = document.getElementById('stCat');
        dropdown.innerHTML = '';
        
        categories.forEach(cat => {
            if (cat.active) {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = `${cat.emoji} ${cat.name}`;
                dropdown.appendChild(option);
            }
        });
    }
    
    function showAddCategoryModal() {
        const colors = [
            '#ff6b6b', '#ff8787', '#fa5252', '#e03131', '#c92a2a',
            '#51cf66', '#8ce99a', '#40c057', '#2f9e44', '#2b8a3e',
            '#339af0', '#74c0fc', '#228be6', '#1c7ed6', '#1971c2',
            '#ffd43b', '#ffec99', '#fab005', '#f59f00', '#f08c00',
            '#be4bdb', '#e599f7', '#ae3ec9', '#9c36b5', '#862e9c'
        ];
        
        const colorPicker = document.getElementById('colorPicker');
        colorPicker.innerHTML = '';
        
        colors.forEach(color => {
            const colorOption = document.createElement('div');
            colorOption.className = 'color-option';
            colorOption.style.backgroundColor = color;
            colorOption.onclick = () => {
                document.querySelectorAll('.color-option').forEach(co => co.classList.remove('selected'));
                colorOption.classList.add('selected');
                colorOption.dataset.color = color;
            };
            colorPicker.appendChild(colorOption);
        });
        
        // Select first color by default
        if (colorPicker.firstChild) {
            colorPicker.firstChild.click();
        }
        
        document.getElementById('newCategoryName').value = '';
        document.getElementById('newCategoryEmoji').value = 'üì¶';
        document.getElementById('addCategoryModal').style.display = 'flex';
        document.getElementById('newCategoryName').focus();
    }
    
    function addNewCategory() {
        const name = document.getElementById('newCategoryName').value.trim();
        const emoji = document.getElementById('newCategoryEmoji').value.trim() || 'üì¶';
        const selectedColor = document.querySelector('.color-option.selected');
        
        if (!name) {
            alert("Please enter a category name");
            return;
        }
        
        // Check if category exists
        if (categories.some(cat => cat.name.toLowerCase() === name.toLowerCase())) {
            alert("Category already exists!");
            return;
        }
        
        const newCategory = {
            id: categories.length + 1,
            name: name,
            emoji: emoji,
            color: selectedColor ? selectedColor.dataset.color : '#339af0',
            active: true
        };
        
        categories.push(newCategory);
        saveAllData();
        
        // Update UI
        renderCategoryTabs();
        populateCategoryDropdown();
        closeModal('addCategoryModal');
        
        showNotification(`New category added: ${emoji} ${name}`, 'success');
    }
    
    // -------------------------------------------------------------------------
    // POS FUNCTIONS
    // -------------------------------------------------------------------------
    
    function renderItems() {
        const grid = document.getElementById('itemGrid');
        const query = document.getElementById('pSearch').value.toLowerCase();
        
        // Filter items
        let filteredItems = db.filter(item => 
            item.name.toLowerCase().includes(query) && 
            parseFloat(item.qty) > 0
        );
        
        // Filter by category
        if (selectedCategory !== 'all') {
            filteredItems = filteredItems.filter(item => item.category === selectedCategory);
        }
        
        grid.innerHTML = '';
        
        if (filteredItems.length === 0) {
            grid.innerHTML = `
                <div style="text-align:center; padding:40px; color:var(--text-dim); grid-column: 1 / -1;">
                    ${selectedCategory !== 'all' ? `No items in ${selectedCategory} category` : 'No items available'}<br>
                    <small>Add stock in Stock Control</small>
                </div>
            `;
            return;
        }
        
        filteredItems.forEach(item => {
            const card = document.createElement('div');
            card.className = 'item-card glass';
            card.innerHTML = `
                <span class="stock-badge">${parseFloat(item.qty).toFixed(2)}kg</span>
                <div style="font-size:30px;">${item.emoji || 'üçé'}</div>
                <b>${item.name}</b>
                <br>
                <small>Rs ${parseFloat(item.price).toFixed(2)}/kg</small>
                <br>
                <small style="font-size:10px; color:var(--text-dim);">
                    ${item.category || 'Uncategorized'}
                </small>
            `;
            card.onclick = () => addToCart(item);
            grid.appendChild(card);
        });
        
        updateItemSelectDropdown();
    }
    
    function updateItemSelectDropdown() {
        const select = document.getElementById('stSelectName');
        select.innerHTML = '<option value="">-- Select item or add new --</option>';
        
        db.forEach(item => {
            if (parseFloat(item.qty) > 0) {
                const option = document.createElement('option');
                option.value = item.name;
                option.textContent = `${item.name} (${parseFloat(item.qty).toFixed(2)}kg)`;
                select.appendChild(option);
            }
        });
    }
    
    function handleItemSelect() {
        const selectedValue = document.getElementById('stSelectName').value;
        if (selectedValue) {
            const item = db.find(i => i.name === selectedValue);
            if (item) {
                document.getElementById('stName').value = item.name;
                document.getElementById('stCost').value = item.cost;
                document.getElementById('stPrice').value = item.price;
                document.getElementById('stEmoji').value = item.emoji || "üçé";
                document.getElementById('stBarcode').value = item.barcode || "";
                document.getElementById('stCat').value = item.category || categories[0].name;
                document.getElementById('stQty').value = "";
                document.getElementById('stQty').focus();
            }
        }
    }
    
    // -------------------------------------------------------------------------
    // CART FUNCTIONS
    // -------------------------------------------------------------------------
    
    function addToCart(item) {
        tempItem = item;
        document.getElementById('weightTitle').innerText = item.name;
        document.getElementById('weightSub').innerText = `Price: Rs ${item.price}/kg | Stock: ${item.qty}kg`;
        document.getElementById('weightInput').value = "";
        document.getElementById('weightModal').style.display = 'flex';
        document.getElementById('weightInput').focus();
    }
    
    function confirmWeight() {
        const input = document.getElementById('weightInput').value;
        const weight = parseFloat(input);
        
        if (isNaN(weight) || weight <= 0) {
            alert("Please enter valid weight!");
            return;
        }
        
        if (weight > tempItem.qty) {
            alert(`Not enough stock! Available: ${tempItem.qty}kg`);
            return;
        }
        
        cart.push({ 
            ...tempItem, 
            weight, 
            rowTotal: parseFloat(tempItem.price) * weight 
        });
        
        updateCartUI();
        closeModal('weightModal');
        showNotification(`${tempItem.name} added to cart`, 'success');
    }
    
    function updateCartUI() {
        const list = document.getElementById('cartList');
        let subtotal = cart.reduce((total, item) => total + item.rowTotal, 0);
        let total = Math.max(0, subtotal - currentDiscount);
        
        list.innerHTML = '';
        
        if (cart.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-dim);">Cart is empty<br><small>Add items from left</small></div>';
        } else {
            cart.forEach((item, i) => {
                list.innerHTML += `
                    <div class="cart-row">
                        <span>${item.name}</span>
                        <span>${item.weight.toFixed(3)}kg</span>
                        <span>Rs ${parseFloat(item.price).toFixed(2)}</span>
                        <span>${item.rowTotal.toFixed(2)}</span>
                        <span onclick="removeCartItem(${i})" style="color:var(--danger);cursor:pointer;">‚úï</span>
                    </div>
                `;
            });
        }
        
        document.getElementById('subTotal').innerText = subtotal.toFixed(2);
        document.getElementById('discountAmount').innerText = currentDiscount.toFixed(2);
        document.getElementById('grandTotal').innerText = total.toFixed(2);
        
        // Show/hide discount display
        document.getElementById('discountDisplay').style.display = currentDiscount > 0 ? 'flex' : 'none';
    }
    
    function removeCartItem(index) {
        const item = cart[index];
        cart.splice(index, 1);
        updateCartUI();
        showNotification(`${item.name} removed from cart`, 'warning');
    }
    
    function applyDiscount() {
        const discountInput = document.getElementById('discountInput');
        const discount = parseFloat(discountInput.value);
        
        if (isNaN(discount) || discount < 0) {
            alert("Please enter valid discount amount");
            return;
        }
        
        const subtotal = cart.reduce((total, item) => total + item.rowTotal, 0);
        if (discount > subtotal) {
            alert("Discount cannot be more than subtotal");
            return;
        }
        
        currentDiscount = discount;
        updateCartUI();
        discountInput.value = "";
        showNotification(`Discount applied: Rs ${discount.toFixed(2)}`, 'success');
    }
    
    function completeSale() {
        if (!cart.length) {
            alert("Please add items to cart");
            return;
        }
        
        let subtotal = cart.reduce((a, b) => a + b.rowTotal, 0);
        let total = Math.max(0, subtotal - currentDiscount);
        let cost = cart.reduce((a, b) => a + (b.cost * b.weight), 0);
        let itemsForLog = [...cart];
        let timestamp = new Date().toLocaleTimeString();

        // Update stock
        cart.forEach(c => { 
            let p = db.find(x => x.name === c.name); 
            if (p) {
                p.qty = Math.max(0, parseFloat(p.qty) - c.weight).toFixed(3);
            }
        });

        // Record sale
        const sale = {
            total, 
            discount: currentDiscount,
            profit: total - cost, 
            date: new Date().toLocaleDateString(), 
            time: timestamp,
            month: new Date().getMonth(),
            itemsCount: cart.length,
            items: itemsForLog
        };
        
        sales.push(sale);
        
        // Add log
        addLog(`Sale: Rs ${total.toFixed(2)} (${cart.length} items)`, 'sale', sale);
        
        // Show receipt
        showReceipt(sale);
        
        // Clear cart and reset
        cart = []; 
        currentDiscount = 0;
        updateCartUI(); 
        renderItems(); 
        updateStats();
        saveAllData();
        
        showNotification('Sale completed successfully!', 'success');
    }
    
    function showReceipt(sale) {
        let html = `
            <div style="text-align:center">
                <h3 style="margin-bottom:5px;">JAYANETH PRO MART</h3>
                <p style="font-size:11px; margin-bottom:10px;">${sale.date} | ${sale.time}</p>
            </div>
            <hr style="border:none; border-top:1px dashed #ccc; margin:10px 0;">
        `;
        
        sale.items.forEach(i => {
            html += `
                <div style="display:flex; justify-content:space-between; margin:3px 0; font-size:11px;">
                    <span>${i.name} (${i.weight}kg)</span>
                    <span>${i.rowTotal.toFixed(2)}</span>
                </div>
            `;
        });
        
        html += `<hr style="border:none; border-top:1px dashed #ccc; margin:10px 0;">`;
        
        if (sale.discount > 0) {
            html += `
                <div style="display:flex; justify-content:space-between; margin:3px 0; font-size:11px;">
                    <span>Subtotal</span>
                    <span>${(sale.total + sale.discount).toFixed(2)}</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin:3px 0; font-size:11px; color:#e74c3c;">
                    <span>Discount</span>
                    <span>-${sale.discount.toFixed(2)}</span>
                </div>
            `;
        }
        
        html += `
            <div style="display:flex; justify-content:space-between; font-weight:bold; margin-top:10px; font-size:12px;">
                <span>TOTAL</span>
                <span>Rs ${sale.total.toFixed(2)}</span>
            </div>
            <p style="text-align:center; font-size:10px; margin-top:15px; color:#666;">
                Thank You! Come Again.
            </p>
        `;
        
        document.getElementById('billArea').innerHTML = html;
        document.getElementById('receiptModal').style.display = 'flex';
    }
    
    // -------------------------------------------------------------------------
    // STOCK CONTROL
    // -------------------------------------------------------------------------
    
    function processStock() {
        const name = document.getElementById('stName').value.trim();
        const category = document.getElementById('stCat').value;
        const cost = parseFloat(document.getElementById('stCost').value);
        const price = parseFloat(document.getElementById('stPrice').value);
        const emoji = document.getElementById('stEmoji').value || 'üçé';
        const barcode = document.getElementById('stBarcode').value.trim();
        const qty = parseFloat(document.getElementById('stQty').value);
        
        if (!name) {
            alert("Please enter item name");
            return;
        }
        
        if (!price || price <= 0 || !cost || cost <= 0) {
            alert("Please enter valid prices");
            return;
        }
        
        if (!qty || qty <= 0) {
            alert("Please enter valid quantity");
            return;
        }
        
        let item = db.find(i => i.name.toLowerCase() === name.toLowerCase());
        
        if (item) {
            // Update existing item
            item.qty = (parseFloat(item.qty) + qty).toFixed(3);
            item.cost = cost;
            item.price = price;
            item.emoji = emoji;
            item.category = category;
            if (barcode) item.barcode = barcode;
            
            addLog(`Stock updated: ${name} (+${qty}kg)`, 'stock');
            showNotification(`${name} stock increased by ${qty}kg`, 'success');
        } else {
            // Add new item
            item = {
                name: name,
                cost: cost,
                price: price,
                qty: qty,
                emoji: emoji,
                barcode: barcode || null,
                category: category
            };
            db.push(item);
            
            addLog(`New item added: ${name}`, 'stock');
            showNotification(`New item added: ${name}`, 'success');
        }
        
        // Clear form
        document.getElementById('stName').value = "";
        document.getElementById('stCost').value = "";
        document.getElementById('stPrice').value = "";
        document.getElementById('stEmoji').value = "üçé";
        document.getElementById('stBarcode').value = "";
        document.getElementById('stQty').value = "";
        
        saveAllData();
        renderItems();
        updateStats();
    }
    
    function addExpense() {
        const name = document.getElementById('expName').value.trim();
        const amount = parseFloat(document.getElementById('expAmt').value);
        
        if (!name) {
            alert("Please enter expense reason");
            return;
        }
        
        if (!amount || amount <= 0) {
            alert("Please enter valid amount");
            return;
        }
        
        expenses.push({ 
            name: name, 
            amt: amount, 
            date: new Date().toLocaleDateString(), 
            month: new Date().getMonth()
        });
        
        addLog(`Expense: ${name} (Rs ${amount})`, 'expense');
        showNotification(`Expense added: ${name}`, 'warning');
        
        document.getElementById('expName').value = "";
        document.getElementById('expAmt').value = "";
        
        saveAllData();
        updateStats();
    }
    
    function addLog(msg, type, data = null) {
        const logEntry = {
            msg, 
            type, 
            data, 
            time: new Date().toLocaleTimeString(), 
            date: new Date().toLocaleDateString(), 
            id: Date.now()
        };
        
        logs.unshift(logEntry);
        if (logs.length > 50) logs.pop();
        
        renderLogs();
    }
    
    function renderLogs() {
        const logBox = document.getElementById('historyLog');
        logBox.innerHTML = '';
        
        logs.slice(0, 20).forEach(log => {
            logBox.innerHTML += `
                <div class="history-item">
                    <span>[${log.time}] ${log.msg}</span>
                    ${log.type === 'sale' ? `<button class="btn-view" onclick="viewSaleDetails(${log.id})">VIEW</button>` : ''}
                </div>
            `;
        });
    }
    
    function viewSaleDetails(logId) {
        const log = logs.find(l => l.id === logId);
        if (log && log.data) {
            showReceipt(log.data);
        }
    }
    
    // -------------------------------------------------------------------------
    // REPORTS & STATS
    // -------------------------------------------------------------------------
    
    function updateStats() {
        const today = new Date().toLocaleDateString();
        const todaySales = sales.filter(s => s.date === today);
        const todayRevenue = todaySales.reduce((sum, sale) => sum + sale.total, 0);
        const todayProfit = todaySales.reduce((sum, sale) => sum + sale.profit, 0);
        const todayExpenses = expenses.filter(e => e.date === today).reduce((sum, e) => sum + e.amt, 0);
        const todayWastage = wastage.filter(w => w.date === today).reduce((sum, w) => sum + w.loss, 0);
        const netProfit = todayProfit - todayExpenses - todayWastage;
        
        // Update header stats
        document.getElementById('statRev').innerText = `Rs ${todayRevenue.toFixed(2)}`;
        document.getElementById('statProf').innerText = `Rs ${netProfit.toFixed(2)}`;
        
        // Update reports
        document.getElementById('rDayRev').innerText = todayRevenue.toFixed(2);
        document.getElementById('rDayProf').innerText = netProfit.toFixed(2);
        document.getElementById('totalItems').innerText = db.length;
        document.getElementById('todaySales').innerText = todaySales.length;
        
        // Update summary
        document.getElementById('summaryText').innerHTML = `
            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Total Sales:</span>
                    <span>Rs ${todayRevenue.toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Gross Profit:</span>
                    <span>Rs ${todayProfit.toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Expenses:</span>
                    <span style="color: var(--danger);">Rs ${todayExpenses.toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Wastage:</span>
                    <span style="color: var(--danger);">Rs ${todayWastage.toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--glass-border);">
                    <span>Net Profit:</span>
                    <span style="color: var(--neon-green);">Rs ${netProfit.toFixed(2)}</span>
                </div>
            </div>
        `;
        
        // Update sales history
        const salesHistory = document.getElementById('salesHistory');
        salesHistory.innerHTML = '';
        
        todaySales.slice(-10).reverse().forEach(sale => {
            salesHistory.innerHTML += `
                <div class="history-item">
                    <span>${sale.time} - Rs ${sale.total.toFixed(2)} (${sale.itemsCount} items)</span>
                    <button class="btn-view" onclick="viewSaleDetails(${sale.id || Date.now()})">VIEW</button>
                </div>
            `;
        });
        
        if (todaySales.length === 0) {
            salesHistory.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-dim);">No sales today</div>';
        }
    }
    
    // -------------------------------------------------------------------------
    // GAME FUNCTIONS
    // -------------------------------------------------------------------------
    
    function initGame() {
        game.canvas = document.getElementById('gameCanvas');
        game.ctx = game.canvas.getContext('2d');
        
        // Set canvas size based on container
        const container = game.canvas.parentElement;
        game.canvas.width = container.clientWidth;
        game.canvas.height = container.clientHeight;
        
        // Adjust basket position
        game.basket.y = game.canvas.height - 50;
        game.basket.width = Math.min(100, game.canvas.width * 0.2);
        
        // Initialize touch controls if on mobile
        if (isMobile) {
            initTouchControls();
        }
        
        // Initialize keyboard controls
        initKeyboardControls();
    }
    
    function initTouchControls() {
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const shootBtn = document.getElementById('shootBtn');
        
        // Show touch controls
        document.getElementById('touchControls').style.display = 'flex';
        
        // Left button
        leftBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            game.keys['ArrowLeft'] = true;
        });
        
        leftBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            game.keys['ArrowLeft'] = false;
        });
        
        // Right button
        rightBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            game.keys['ArrowRight'] = true;
        });
        
        rightBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            game.keys['ArrowRight'] = false;
        });
        
        // Shoot button
        shootBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            shootFruit();
        });
    }
    
    function initKeyboardControls() {
        window.addEventListener('keydown', (e) => {
            if (e.key === ' ' || e.key === 'Spacebar') {
                e.preventDefault();
                shootFruit();
            }
            game.keys[e.key] = true;
        });
        
        window.addEventListener('keyup', (e) => {
            game.keys[e.key] = false;
        });
    }
    
    function shootFruit() {
        // In this version, shooting is just for fun
        if (game.isRunning && !game.isPaused) {
            // Add a visual effect
            showNotification('üí• Shot fired!', 'info');
        }
    }
    
    function startGame() {
        if (game.isRunning) return;
        
        game.isRunning = true;
        game.isPaused = false;
        game.score = 0;
        game.lives = 3;
        game.time = 60;
        game.fruits = [];
        game.bombs = [];
        game.basket.x = game.canvas.width / 2 - game.basket.width / 2;
        
        // Hide game over screen
        document.getElementById('gameOverScreen').style.display = 'none';
        
        // Update UI
        updateGameUI();
        
        // Start game loop
        game.lastTime = Date.now();
        game.gameLoopId = requestAnimationFrame(gameLoop);
        
        showNotification('Game started! Catch the fruits!', 'success');
    }
    
    function gameLoop() {
        if (!game.isRunning || game.isPaused) return;
        
        const currentTime = Date.now();
        const deltaTime = currentTime - game.lastTime;
        game.lastTime = currentTime;
        
        // Update game state
        updateGame(deltaTime);
        
        // Draw game
        drawGame();
        
        // Continue game loop
        game.gameLoopId = requestAnimationFrame(gameLoop);
    }
    
    function updateGame(deltaTime) {
        // Move basket
        const speed = isMobile ? 8 : 10;
        if (game.keys['ArrowLeft'] || game.keys['a'] || game.keys['A']) {
            game.basket.x -= speed;
        }
        if (game.keys['ArrowRight'] || game.keys['d'] || game.keys['D']) {
            game.basket.x += speed;
        }
        
        // Keep basket in bounds
        game.basket.x = Math.max(0, Math.min(game.canvas.width - game.basket.width, game.basket.x));
        
        // Update time
        game.time -= deltaTime / 1000;
        if (game.time <= 0) {
            gameOver();
            return;
        }
        
        // Spawn fruits
        if (Math.random() < 0.03) {
            spawnFruit();
        }
        
        // Spawn bombs
        if (Math.random() < 0.01) {
            spawnBomb();
        }
        
        // Update fruits
        for (let i = game.fruits.length - 1; i >= 0; i--) {
            const fruit = game.fruits[i];
            fruit.y += fruit.speed;
            
            // Check collision with basket
            if (fruit.y + fruit.size > game.basket.y &&
                fruit.x + fruit.size > game.basket.x &&
                fruit.x < game.basket.x + game.basket.width) {
                
                // Add score
                game.score += fruit.type === 'golden' ? 50 : 10;
                
                // Remove fruit
                game.fruits.splice(i, 1);
                updateGameUI();
                continue;
            }
            
            // Remove if out of bounds
            if (fruit.y > game.canvas.height) {
                game.fruits.splice(i, 1);
            }
        }
        
        // Update bombs
        for (let i = game.bombs.length - 1; i >= 0; i--) {
            const bomb = game.bombs[i];
            bomb.y += bomb.speed;
            
            // Check collision with basket
            if (bomb.y + bomb.size > game.basket.y &&
                bomb.x + bomb.size > game.basket.x &&
                bomb.x < game.basket.x + game.basket.width) {
                
                // Lose a life
                game.lives--;
                updateGameUI();
                
                // Remove bomb
                game.bombs.splice(i, 1);
                
                // Check game over
                if (game.lives <= 0) {
                    gameOver();
                    return;
                }
                continue;
            }
            
            // Remove if out of bounds
            if (bomb.y > game.canvas.height) {
                game.bombs.splice(i, 1);
            }
        }
    }
    
    function drawGame() {
        const ctx = game.ctx;
        const canvas = game.canvas;
        
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw background
        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, 'rgba(5, 10, 15, 0.9)');
        gradient.addColorStop(1, 'rgba(10, 20, 30, 0.9)');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Draw basket
        ctx.fillStyle = 'var(--neon-green)';
        ctx.fillRect(game.basket.x, game.basket.y, game.basket.width, game.basket.height);
        
        // Draw basket details
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        ctx.fillRect(game.basket.x + 5, game.basket.y + 5, game.basket.width - 10, game.basket.height - 10);
        
        // Draw fruits
        game.fruits.forEach(fruit => {
            ctx.font = `${fruit.size}px Arial`;
            ctx.fillStyle = fruit.type === 'golden' ? 'gold' : 'white';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(fruit.emoji, fruit.x + fruit.size/2, fruit.y + fruit.size/2);
        });
        
        // Draw bombs
        game.bombs.forEach(bomb => {
            ctx.font = `${bomb.size}px Arial`;
            ctx.fillStyle = 'var(--danger)';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('üí£', bomb.x + bomb.size/2, bomb.y + bomb.size/2);
        });
        
        // Draw score overlay
        ctx.fillStyle = 'rgba(0,0,0,0.7)';
        ctx.fillRect(10, 10, 150, 80);
        
        ctx.font = '12px Inter';
        ctx.fillStyle = 'white';
        ctx.textAlign = 'left';
        ctx.fillText(`SCORE: ${game.score}`, 20, 30);
        ctx.fillText(`LIVES: ${'‚ù§Ô∏è'.repeat(game.lives)}`, 20, 50);
        ctx.fillText(`TIME: ${Math.ceil(game.time)}`, 20, 70);
    }
    
    function spawnFruit() {
        const fruits = ['üçé', 'üçå', 'üçä', 'üçá', 'üçì', 'üçâ'];
        const emoji = fruits[Math.floor(Math.random() * fruits.length)];
        const isGolden = Math.random() < 0.05;
        
        game.fruits.push({
            x: Math.random() * (game.canvas.width - 40),
            y: -40,
            size: isGolden ? 35 : 25 + Math.random() * 10,
            speed: 1 + Math.random() * 2,
            emoji: isGolden ? 'ü•á' : emoji,
            type: isGolden ? 'golden' : 'normal'
        });
    }
    
    function spawnBomb() {
        game.bombs.push({
            x: Math.random() * (game.canvas.width - 40),
            y: -40,
            size: 25 + Math.random() * 10,
            speed: 2 + Math.random() * 2,
            emoji: 'üí£'
        });
    }
    
    function updateGameUI() {
        document.getElementById('gameScore').textContent = game.score;
        document.getElementById('gameLives').textContent = game.lives;
        document.getElementById('gameTime').textContent = Math.ceil(game.time);
    }
    
    function gameOver() {
        game.isRunning = false;
        if (game.gameLoopId) {
            cancelAnimationFrame(game.gameLoopId);
        }
        
        // Show game over screen
        document.getElementById('finalScore').textContent = game.score;
        document.getElementById('gameOverTitle').textContent = game.lives <= 0 ? 'GAME OVER!' : 'TIME UP!';
        document.getElementById('gameOverScreen').style.display = 'flex';
        
        showNotification(`Game Over! Final score: ${game.score}`, 
            game.score > 100 ? 'success' : 'warning');
    }
    
    function pauseGame() {
        if (!game.isRunning) return;
        
        game.isPaused = !game.isPaused;
        
        if (game.isPaused) {
            cancelAnimationFrame(game.gameLoopId);
            document.getElementById('pauseBtn').textContent = 'RESUME';
            showNotification('Game paused', 'warning');
        } else {
            game.lastTime = Date.now();
            game.gameLoopId = requestAnimationFrame(gameLoop);
            document.getElementById('pauseBtn').textContent = 'PAUSE';
            showNotification('Game resumed', 'success');
        }
    }
    
    function restartGame() {
        startGame();
    }
    
    // -------------------------------------------------------------------------
    // CLOUD BACKUP FUNCTIONS
    // -------------------------------------------------------------------------
    
    async function checkCloudBackup() {
        try {
            const snapshot = await database.ref('pos_data').once('value');
            const cloudData = snapshot.val();
            return cloudData !== null;
        } catch (error) {
            console.error('Cloud check error:', error);
            return false;
        }
    }
    
    async function restoreCloudData() {
        try {
            const snapshot = await database.ref('pos_data').once('value');
            const cloudData = snapshot.val();
            
            if (!cloudData) {
                showNotification('No cloud backup found', 'error');
                return;
            }
            
            // Restore data
            if (cloudData.db) db = cloudData.db;
            if (cloudData.sales) sales = cloudData.sales;
            if (cloudData.expenses) expenses = cloudData.expenses;
            if (cloudData.wastage) wastage = cloudData.wastage;
            if (cloudData.logs) logs = cloudData.logs;
            if (cloudData.categories) categories = cloudData.categories;
            
            // Save to localStorage
            saveAllData();
            
            // Update UI
            renderItems();
            updateStats();
            renderLogs();
            initCategories();
            
            showNotification('Cloud data restored successfully!', 'success');
            closeModal('restoreModal');
            
        } catch (error) {
            showNotification('Error restoring cloud data', 'error');
        }
    }
    
    // -------------------------------------------------------------------------
    // SCANNER FUNCTIONS
    // -------------------------------------------------------------------------
    
    function showScanner(mode) {
        currentScannerMode = mode;
        document.getElementById('scannerModal').style.display = 'flex';
    }
    
    function startScanner() {
        const scannerContainer = document.getElementById('scanner-container');
        scannerContainer.innerHTML = '<div id="qr-reader" style="width:100%; height:100%;"></div>';
        
        try {
            scanner = new Html5Qrcode("qr-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            scanner.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanError
            );
        } catch (error) {
            showNotification('Scanner error: ' + error.message, 'error');
        }
    }
    
    function onScanSuccess(decodedText) {
        // Find item by barcode
        let item = db.find(i => i.barcode === decodedText);
        
        if (item) {
            stopScanner();
            closeModal('scannerModal');
            
            if (currentScannerMode === 'pos' || currentScannerMode === 'bill') {
                addToCart(item);
            } else if (currentScannerMode === 'stock') {
                // Auto-fill stock form
                document.getElementById('stSelectName').value = item.name;
                handleItemSelect();
                showNotification(`${item.name} loaded from barcode`, 'success');
            }
        } else {
            showNotification("Item not found for barcode", 'error');
        }
    }
    
    function onScanError(error) {
        // Quietly handle scan errors
    }
    
    function stopScanner() {
        if (scanner) {
            scanner.stop();
            scanner = null;
        }
    }
    
    // -------------------------------------------------------------------------
    // UTILITY FUNCTIONS
    // -------------------------------------------------------------------------
    
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        
        switch(type) {
            case 'error': notification.style.background = 'var(--danger)'; break;
            case 'success': notification.style.background = 'var(--neon-green)'; break;
            case 'warning': notification.style.background = 'var(--orange)'; break;
            default: notification.style.background = 'var(--neon-blue)';
        }
        
        notification.style.color = type === 'error' ? 'white' : 'black';
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }
    
    function handleLock() {
        showNotification('System is already unlocked', 'info');
    }
    
    function switchTab(tab) {
        // Hide all views
        ['view-pos', 'view-stock', 'view-reports', 'view-game'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
        
        // Show selected view
        document.getElementById('view-' + tab).style.display = tab === 'pos' ? 'contents' : 'block';
        
        // Update nav buttons
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        document.getElementById('tab-' + tab).classList.add('active');
        
        // Tab-specific initializations
        if (tab === 'game') {
            setTimeout(() => {
                initGame();
            }, 100);
        } else if (tab === 'reports') {
            updateStats();
        } else if (tab === 'stock') {
            renderLogs();
            updateItemSelectDropdown();
        }
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        if (modalId === 'scannerModal') {
            stopScanner();
        }
    }
    
    // -------------------------------------------------------------------------
    // WINDOW LOAD
    // -------------------------------------------------------------------------
    
    window.addEventListener('load', () => {
        initializeSystem();
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (game.canvas) {
                const container = game.canvas.parentElement;
                game.canvas.width = container.clientWidth;
                game.canvas.height = container.clientHeight;
                game.basket.y = game.canvas.height - 50;
            }
        });
    });
    
    // Handle beforeunload
    window.addEventListener('beforeunload', () => {
        saveAllData();
        if (scanner) stopScanner();
        if (game.gameLoopId) cancelAnimationFrame(game.gameLoopId);
    });
</script>
</body>
</html>
